@{
    ViewBag.Title = "ManagerApprovalMHB";
}

<div class="main-content container-fluid ">


    <div class="container mt-4 bg-white">
        <h3 class=" mb-1 text-center text-primary"> Manager Approval Panel</h3>
        <div class="mb-3">
            <div class="input-group" style="max-width: 280px;">
                <span class="input-group-text bg-primary text-white">
                    <i class="bi bi-calendar-date"></i>
                </span>
                <input type="text" id="createdDateFilter" class="form-control" placeholder="Filter by Created Date" readonly />
            </div>
        </div>

        <div class="table-responsive">
            <table id="plansTable" class="table table-hover table-bordered align-middle text-center shadow-sm">
                <thead class="table-dark">
                    <tr>
                        <th><input type="checkbox" id="selectAll" /></th> <!-- ✅ Select All -->
                        <th>Sr. No</th>
                        <th>Plan Name</th>
                        <th>MRP Code</th>
                        <th>Created Date</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated dynamically -->
                </tbody>
            </table>

        </div>
    </div>



    <!-- ✅ Plan Details Modal -->
    <div class="modal fade" id="planDetailsModal" tabindex="-1" aria-labelledby="planDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content shadow-lg rounded-3">
                <div class="modal-header bg-primary d-flex justify-content-center align-items-center rounded-top p-1">
                    <h5 class="modal-title text-center w-100 text-white  mb-0 fs-5 "> Plan Details</h5>
                    <button type="button" class="btn-close btn-close-white position-absolute end-0 me-2 " onclick="closePlanModal()" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label form-label-sm fw-bold text-dark">Plan Name:</label>
                            <div id="modalPlanName" class=" form-control bg-light form-control-sm  text-dark shadow-sm"></div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label form-label-sm fw-bold text-dark">MRP Code:</label>
                            <div id="modalPlanCode" class=" form-control bg-light form-control-sm  text-dark shadow-sm"></div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label form-label-sm fw-bold text-dark">Year:</label>
                            <div id="modalPlanyear" class=" form-control bg-light form-control-sm  text-dark shadow-sm"></div>
                        </div>
                    </div>

                    <div class="table-responsive mb-3">
                        <table id="modalItemTable" class="table table-hover table-bordered align-middle text-center shadow-sm">
                            <thead class="table-dark ">
                                <tr>
                                    <th>Sr No</th>
                                    <th>Item Name</th>
                                    <th>Item Code</th>
                                    <th>Quantity</th>
                                    <th>UOM</th>
                                    <th>Description</th>
                                    <th>Request Type</th>
                                </tr>
                            </thead>
                            <tbody id="modalItemTableBody"></tbody>
                        </table>
                    </div>

                    <div class="row mb-3 text-center">
                        <div class="col-md-6">
                            <label class="form-label form-label-sm fw-bold text-dark">From Date:</label>
                            <div id="modalfromdate" class="text-muted"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label form-label-sm fw-bold text-dark">To Date:</label>
                            <div id="modaltodate" class="text-muted"></div>
                        </div>
                    </div>

                    <div class="text-center mt-4 ">
                        <button id="rejectBtn" class="btn btn-danger px-4 btn-sm"> Reject</button>
                        <button id="approveBtn" class="btn btn-success px-4 me-3 btn-sm">Approve</button>
                    </div>
                </div>
            </div>
        </div>


    </div>
    <!-- ✅ Reject Reason Modal -->
    <div class="modal fade" id="rejectReasonModal" tabindex="-1" aria-labelledby="rejectReasonModalLabel" aria-hidden="true">
        <div class="modal-dialog ">
            <div class="modal-content shadow-lg rounded-3">
                <div class="modal-header bg-danger d-flex justify-content-center align-items-center rounded-top p-1 ">
                    <h5 class="modal-title fw-bold text-white mb-0 fs-5">Reason for Rejection</h5>
                    <button type="button" class="btn-close btn-close-white position-absolute end-0 me-2" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <textarea id="rejectReasonText" class="form-control" rows="4" placeholder="Enter reason for rejection..."></textarea>
                </div>
                <div class="modal-footer">
                    <button id="submitRejectBtn" class="btn btn-danger btn-sm">Submit</button>
                    @*<button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>*@
                </div>
            </div>
        </div>
    </div>

    @*edit plan modal*@
    <div class="modal fade" id="editPlanModal" tabindex="-1" aria-labelledby="editPlanModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content shadow-lg rounded-3">
                <div class="modal-header bg-primary d-flex justify-content-center align-items-center rounded-top p-1">
                    <h5 class="modal-title fw-bold text-white mb-0 fs-5" id="editPlanModalLabel"> Edit Plan</h5>

                    <button type="button" class="btn-close btn-close-white position-absolute end-0 me-2" onclick="closeEditModal()" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <!-- Plan Metadata -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label form-label-sm fw-bold text-dark" >Year:</label>
                            <input type="text" class="form-control form-control-sm text-dark shadow-sm bg-light" id="editYear" readonly />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label form-label-sm fw-bold text-dark">Plan Name:</label>
                            <input type="text" class="form-control form-control-sm text-dark shadow-sm bg-light" id="editPlanName" readonly />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label form-label-sm fw-bold text-dark">Plan Code:</label>
                            <input type="text" class="form-control  form-control-sm text-dark shadow-sm bg-light" id="editMRPCode" readonly />
                        </div>
                    </div>

                    <!-- Item Form -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-dark">Item Name:<span class="required-star">*</span></label>
                            <select class="form-control form-select-sm item-select shadow-sm " id="editItemName">
                                <option value="">Select Item</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold text-dark">Item Code:</label>
                            <input type="text" class="form-control form-control-sm text-dark shadow-sm bg-light" id="editItemCode" readonly />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold text-dark">Quantity:<span class="required-star">*</span></label>
                            <input type="number" class="form-control form-control-sm text-dark shadow-sm " id="editQuantity" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold text-dark">UOM:</label>
                            <input type="text" class="form-control form-control-sm text-dark shadow-sm bg-light" id="editUOM" readonly />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold text-dark">Request Type:</label>
                            <input type="text" class="form-control form-control-sm text-dark shadow-sm bg-light" id="editRequestType" readonly />
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button class="btn btn-success w-100 btn-sm mb-2" onclick="addItemToEditTable()"><i class="bi bi-plus-circle me-2"></i>Add</button>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold text-dark">Description:</label>
                            <input type="text" class="form-control  form-control-sm text-dark shadow-sm bg-light" id="editItemDescription" readonly />
                        </div>
                    </div>
                    
                    <!-- Item Table -->
                    <div class="table-responsive mb-3">
                        <table id="editItemTable" class="table table-bordered text-center table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Item Name</th>
                                    <th>Item Code</th>
                                    <th>Quantity</th>
                                    <th>UOM</th>
                                    <th>Description</th>
                                    <th>Request Type</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="editItemTableBody"></tbody>
                        </table>
                    </div>

                    <!-- Date Range -->
                    <div class="row mb-3 ">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-dark">From Date:<span class="required-star">*</span></label>
                            <input type="date" class="form-control form-control-sm text-dark shadow-sm" id="editFromDate"  min="@DateTime.Now.ToString("yyyy-MM-dd")"/>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-dark" >To Date:<span class="required-star">*</span></label>
                            <input type="date" class="form-control form-control-sm text-dark shadow-sm" id="editToDate"  min="@DateTime.Now.ToString("yyyy-MM-dd")"/>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="button" class="btn btn-success px-4 btn-sm" id="sendForApprovalBtn">
                            Save Changes
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<style>
    .status-badge {
        padding: 6px 10px;
        /*        border-radius: 20px;*/
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-pending {
        background-color: #ffc107;
        color: #212529;
    }

    .status-rejected {
        background-color: #dc3545;
        color: white;
    }

    .status-approved {
        background-color: #28a745;
        color: white;
    }

    .modal-backdrop {
        display: none;
    }
    /* Blur only main content when modal opens */
    body.modal-open .main-content {
        position: relative;
    }

        body.modal-open .main-content::before {
            content: '';
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1040; /* behind modal */
            pointer-events: none; /* clicks pass to modal */
        }

    /* Ensure modal is above overlay */
    .modal {
        z-index: 1055 !important;
    }

    #plansTable th,
    #plansTable td, #modalItemTable th, #modalItemTable td, #editItemTable td, #editItemTable th {
        text-align: center !important;
        vertical-align: middle !important;
    }

    .required-star {
        color: red;
        font-size: 1em;
        font-weight: bold;
        vertical-align: middle;
        position: relative;
        top: -4px;
    }

    button.dt-button.processing,
    div.dt-button.processing {
        pointer-events: auto !important;
        opacity: 1 !important;
        background: none !important;
    }
        button.dt-button.processing:after {
            content: none !important;
        }
</style>

<script>

    let allItems = []; // will hold all items from server


    function fetchPlans() {
        const tableSelector = '#plansTable';

        // Show loading spinner
        const tbody = $(tableSelector + ' tbody');
        tbody.html(`<tr><td colspan="7"><div class="spinner-border text-primary" role="status"></div></td></tr>`);

        // Fetch data from server
        $.ajax({
            url: '/Inventory/FetchPlanDetailsMHB',
            method: 'GET',
            success: function (items) {
                // If DataTable already exists, destroy it
                if ($.fn.DataTable.isDataTable(tableSelector)) {
                    $(tableSelector).DataTable().clear().destroy();
                }

                // Clear tbody manually before repopulating (safety)
                tbody.empty();
                const table = $(tableSelector).DataTable({
                    dom: '<"d-flex justify-content-between align-items-center mb-3"<"dt-left"B><"dt-search"f>>rt<"bottom d-flex justify-content-between align-items-center"ip>',
                    ordering: false,
                    buttons: [
                        // ✅ Print
                        {
                            extend: 'print',
                            title: 'Manager Approval Panel',
                            text: '<i class="bi bi-printer-fill text-dark fs-5" data-bs-toggle="tooltip" title="Print Selected Rows"></i>',
                            titleAttr: 'Print',
                            action: function (e, dt, button, config) {
                                if ($('.row-select:checked').length === 0) {
                                    showExportToast("Please select at least one row to Print");
                                    return;
                                }
                                $.fn.dataTable.ext.buttons.print.action.call(this, e, dt, button, config);
                            },
                            exportOptions: {
                                columns: [1, 2, 3, 4, 5],
                                rows: function (idx, data, node) {
                                    return $(node).find('.row-select').prop('checked');
                                }
                            },
                            customize: function (win) {
                                $(win.document.body).prepend(
                                    `<div style="text-align:center; font-size:12px; margin-bottom:10px;">
                        Generated on: ${new Date().toLocaleString()}
                    </div>`
                                );
                                $(win.document.body).find('table')
                                    .addClass('table table-bordered table-striped')
                                    .css('font-size', '14px');
                                $(win.document.body).find('thead')
                                    .css('background-color', '#0d6efd')
                                    .css('color', 'white');
                                $(win.document.body).find('table tbody tr').each(function (i) {
                                    $(this).find('td:first').text(i + 1);
                                });
                            },
                            customize: function (win) {
                                $(win.document.body).find('h1').remove();
                                const today = new Date().toLocaleDateString('en-GB');
                                $(win.document.body).prepend(`
    <div style="text-align:center; margin-bottom:10px;">
        <h2 style="margin:0;">Manager Approval Panel</h2>
        <div style="font-size:12px;">Generated Date: ${today}</div>
    </div>
`);
                                const $table = $(win.document.body).find('table');
                                $table.addClass('table table-bordered table-striped').css({ 'font-size': '14px', 'width': '100%', 'border-collapse': 'collapse', 'margin-top': '20px' });
                                $table.find('thead th').css({ 'background-color': '#000', 'color': '#fff', 'text-align': 'center' });
                                $table.find('tbody td').css('text-align', 'center');
                                $table.find('tbody tr').each(function (i) { $(this).find('td:first').text(i + 1); });
                            }
                        },
                        // ✅ PDF
                        {
                            extend: 'pdfHtml5',
                            title: 'Manager Approval Panel',
                            text: '<i class="bi bi-file-earmark-pdf text-danger fs-5" data-bs-toggle="tooltip" title="Export to PDF"></i>',
                            titleAttr: 'Export PDF',
                            action: function (e, dt, button, config) {
                                if ($('.row-select:checked').length === 0) {
                                    showExportToast("Please select at least one row to export PDF");
                                    return;
                                }
                                $.fn.dataTable.ext.buttons.pdfHtml5.action.call(this, e, dt, button, config);
                            },
                            exportOptions: {
                                columns: [1, 2, 3, 4, 5],
                                rows: function (idx, data, node) {
                                    return $(node).find('.row-select').prop('checked');
                                },
                                format: {
                                    body: function (data, rowIdx, colIdx) {
                                        if (colIdx === 1) return rowIdx + 1;
                                        if (typeof data === 'string') return data.replace(/<\/?[^>]+(>|$)/g, "").trim();
                                        return data;
                                    }
                                }
                            },
                            customize: function (doc) {
                                try {
                                    // Center + enlarge title
                                    doc.content[0].alignment = 'center';
                                    doc.content[0].fontSize = 14;

                                    // Add export date
                                    var exportDate = new Date().toLocaleDateString('en-GB');
                                    doc.content.splice(1, 0, {
                                        text: 'Generated Date: ' + exportDate,
                                        alignment: 'center',
                                        margin: [0, 0, 0, 8],
                                        fontSize: 10
                                    });

                                    // Style table
                                    var tableNode = doc.content.find(c => c.table);
                                    if (!tableNode) return;

                                    doc.styles = doc.styles || {};
                                    doc.styles.tableHeader = { alignment: 'center', fillColor: '#212529', color: '#ffffff', bold: true };
                                    doc.styles.tableBodyEven = { alignment: 'center' };
                                    doc.styles.tableBodyOdd = { alignment: 'center' };

                                    tableNode.layout = {
                                        hLineWidth: () => .5, vLineWidth: () => .5,
                                        hLineColor: () => '#dddddd', vLineColor: () => '#dddddd',
                                        paddingLeft: () => 50, paddingRight: () => 6,
                                        paddingTop: () => 3, paddingBottom: () => 4
                                    };

                                    // Re-number Sr No column
                                    tableNode.table.body.forEach((row, i) => {
                                        if (i > 0) row[0] = { text: String(i), alignment: 'center' };
                                    });
                                } catch (err) {
                                    console.error('PDF customize error:', err);
                                }
                            }
                        },
                        // ✅ Excel
                        {
                            extend: 'excelHtml5',
                            title: 'Manager Approval Panel',
                            text: '<i class="bi bi-file-earmark-excel text-success fs-5" data-bs-toggle="tooltip" title="Export to Excel"></i>',
                            titleAttr: 'Export Excel',
                            action: function (e, dt, button, config) {
                                if ($('.row-select:checked').length === 0) {
                                    showExportToast("Please select at least one row to export Excel");
                                    return;
                                }
                                window.__excelSrCounter = 0;
                                $.fn.dataTable.ext.buttons.excelHtml5.action.call(this, e, dt, button, config);
                            },
                            exportOptions: {
                                columns: [1, 2, 3, 4, 5],
                                rows: function (idx, data, node) {
                                    return $(node).find('.row-select').prop('checked');
                                },
                                format: {
                                    body: function (data, rowIdx, colIdx) {
                                        if (colIdx === 1) return ++window.__excelSrCounter;
                                        if (typeof data === 'string') return data.replace(/<\/?[^>]+(>|$)/g, "").trim();
                                        return data;
                                    }
                                }
                            },
                            customize: function (xlsx) {
                                const sheet = xlsx.xl.worksheets['sheet1.xml'];
                                const now = new Date();
                                const formattedDate = now.toLocaleDateString('en-GB'); // DD/MM/YYYY

                                const newRowNumber = 2;

                                // Create "Generated Date" row
                                const dateRow = `
<row r="${newRowNumber}">
    <c t="inlineStr" r="A${newRowNumber}">
        <is><t>Generated Date: ${formattedDate}</t></is>
    </c>
</row>`;

                                // Shift existing rows down by +1
                                $('row', sheet).each(function () {
                                    const r = parseInt($(this).attr('r'));
                                    if (r >= newRowNumber) $(this).attr('r', r + 1);
                                });
                                $('c', sheet).each(function () {
                                    const cellRef = $(this).attr('r');
                                    const col = cellRef.replace(/[0-9]/g, '');
                                    const row = parseInt(cellRef.replace(/[A-Z]/g, ''));
                                    if (row >= newRowNumber) $(this).attr('r', col + (row + 1));
                                });

                                // Add the new date row right after the title
                                $('row[r="1"]', sheet).after(dateRow);

                                // ✅ Merge cells from A to last column
                                const totalCols = $('row c', sheet).last().attr('r').replace(/[0-9]/g, '');
                                let mergeCells = $('mergeCells', sheet);
                                if (mergeCells.length === 0) {
                                    $('worksheet', sheet).prepend(`<mergeCells count="1"><mergeCell ref="A${newRowNumber}:${totalCols}${newRowNumber}"/></mergeCells>`);
                                } else {
                                    const count = parseInt(mergeCells.attr('count')) + 1;
                                    mergeCells.attr('count', count);
                                    mergeCells.append(`<mergeCell ref="A${newRowNumber}:${totalCols}${newRowNumber}"/>`);
                                }

                                // ✅ Center align the merged cell
                                const styles = xlsx.xl['styles.xml'];
                                const styleIndex = $('cellXfs xf', styles).length;
                                $('cellXfs', styles).append('<xf xfId="0" applyAlignment="1"><alignment horizontal="center"/></xf>');
                                $(`c[r="A${newRowNumber}"]`, sheet).attr('s', styleIndex);
                            }

                        },
                        // ✅ CSV
                        {
                            extend: 'csvHtml5',
                            title: 'Manager_Approval_Panel',
                            text: '<i class="bi bi-filetype-csv text-primary fs-5" data-bs-toggle="tooltip" title="Export to CSV"></i>',
                            titleAttr: 'Export CSV',
                            action: function (e, dt, button, config) {
                                if ($('.row-select:checked').length === 0) {
                                    showExportToast("Please select at least one row to export CSV");
                                    return;
                                }
                                $.fn.dataTable.ext.buttons.csvHtml5.action.call(this, e, dt, button, config);
                            },
                            exportOptions: {
                                columns: [1, 2, 3, 4, 5],
                                rows: function (idx, data, node) {
                                    return $(node).find('.row-select').prop('checked');
                                },
                                format: {
                                    body: function (data, rowIdx, colIdx) {
                                        // Remove HTML tags and trim
                                        if (typeof data === 'string') data = data.replace(/<[^>]*>/g, '').trim();

                                        // Serial number column
                                        if (colIdx === 0 || colIdx === 1) {
                                            // Initialize counter once
                                            if (typeof this.srnoCounter === 'undefined') this.srnoCounter = 0;
                                            return ++this.srnoCounter;
                                        }

                                        return data; // fallback
                                    }
                                }
                            }
                        }
                    ],
                    columnDefs: [
                        { targets: 1, render: function (data, type, row, meta) { return meta.row + 1; } },
                        { orderable: false, targets: [0, 6] }
                    ],
                    order: []
                });



                // No items case
                if (!items || items.length === 0) {
                    table.row.add([
                        '', '', 'No plans found.', '', '', '', ''
                    ]).draw();
                    return;
                }


                // Populate table rows
                items.forEach((plan, index) => {
                    let actionButtons = `
                       <div class="d-flex align-items-center justify-content-center gap-2">
                            <!-- View Button -->
                            <button class="btn btn-sm btn-primary d-flex align-items-center justify-content-center"
                                    style="width: 32px; height: 32px;"
                                    onclick="viewPlanDetails('${plan.MaterialReqPlanningCode}', '${plan.PlanName}', '${plan.StatusName}')"
                                    data-bs-toggle="tooltip" title="View">
                                <i class="bi bi-eye-fill text-white"></i>
                            </button>`;

                    if (plan.StatusName === "Pending") {
                        actionButtons += `
                            <!-- Edit Button -->
                            <button class="btn btn-sm btn-secondary d-flex align-items-center justify-content-center"
                                    style="width: 32px; height: 32px;"
                                    onclick="openEditModal('${plan.MaterialReqPlanningCode}', '${plan.PlanName}')"
                                    data-bs-toggle="tooltip"  title="Edit">
                                <i class="bi bi-pencil-fill text-white"></i>
                            </button>`;
                    }

                    actionButtons += `</div>`;
                    const statusClassMap = {
                        pending: 'status-badge status-pending',
                        rejected: 'status-badge status-rejected',
                        approved: 'status-badge status-approved'
                    };

                    // Get the CSS class based on StatusName (case-insensitive)
                    const statusClass = statusClassMap[plan.StatusName.toLowerCase()] || 'status-badge';

                    // Wrap StatusName in a span
                    const statusHTML = `<span class="${statusClass}">${plan.StatusName}</span>`;
                    const rowData = [
                        `<input type="checkbox" class="row-select" />`,
                        index + 1,
                        plan.PlanName,
                        plan.MaterialReqPlanningCode,
                        plan.AddedDate,
                        statusHTML,
                        actionButtons
                    ];

                    table.row.add(rowData);


                });
             

                table.draw();
                $('[data-bs-toggle="tooltip"]').tooltip();

            },
            error: function () {
                tbody.html(`<tr><td colspan="7" class="text-danger">Failed to load data.</td></tr>`);
            }
        });
    }



    toastr.options = {
        closeButton: true,
        progressBar: true,
        preventDuplicates: true,
        newestOnTop: true,
        positionClass: "toast-top-right",
        timeOut: "3000"
    };

    function showExportToast() {
        toastr.warning("Please select at least one row before exporting.", "Warning");
    }

    // Select All
    $(document).on("change", "#selectAll", function () {
        $(".row-select").prop("checked", this.checked);
    });

    // Sync "Select All" if individual checkbox is changed
    $(document).on("change", ".row-select", function () {
        $("#selectAll").prop("checked", $(".row-select:checked").length === $(".row-select").length);
    });


    function viewPlanDetails(mrpCode, planName, status) {
        $.ajax({
            url: '/Inventory/showplanforApprovalMHB',
            type: 'GET',
            data: { MRPcode: mrpCode },
            success: function (data) {

              
                 
                $('#modalPlanName').text(data.PlanName || '');
                $('#modalPlanCode').text(data.MRPCode || '');
                $('#modalPlanyear').text(data.Year || '');  
                
       
                //$('#modalfromdate').text(data.FromDate);
                //$('#modaltodate').text(data.ToDate);

                function formatDateOnly(dateString) {
                    if (!dateString) return '';

                    // Handle both "dd/mm/yyyy hh:mm:ss" and ISO date formats
                    const parts = dateString.split(' ')[0].split(/[-/]/); // works with '-' or '/'

                    if (parts.length === 3) {
                        // Detect if it's yyyy-mm-dd or dd-mm-yyyy
                        let day, month, year;
                        if (parts[0].length === 4) {
                            // yyyy-mm-dd
                            [year, month, day] = parts;
                        } else {
                            // dd-mm-yyyy
                            [day, month, year] = parts;
                        }
                        return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
                    }
                    return '';
                }

                // ✅ Apply to your elements
                $('#modalfromdate').text(formatDateOnly(data.FromDate));
                $('#modaltodate').text(formatDateOnly(data.ToDate));


               
                const tbody = $('#modalItemTableBody');
                tbody.empty();
               


                if (data.ItemList && data.ItemList.length > 0) {
                    $.each(data.ItemList, function (i, item) {
                        const row = `
                            <tr>

                                <td></td> <!-- Sr No will be auto-filled by DataTable -->
                                <td>${item.ItemName}</td>
                                <td>${item.ItemCode}</td>
                                <td>${item.QuantityMRP}</td>
                                <td>${item.UOMName}</td>
                              <td data-bs-toggle="tooltip" data-bs-placement="top" title="${item.Description}">${item.Description}</td>
                                <td>${item.RequestType}</td>
                            </tr>`;
                        tbody.append(row);
                    });
                }
                else {
                    tbody.append(`<tr><td colspan="6">No items found.</td></tr>`);
                }

                // Destroy previous DataTable if exists
                if ($.fn.DataTable.isDataTable('#modalItemTable')) {
                    $('#modalItemTable').DataTable().destroy();
                }

                // Initialize DataTable
                $('#modalItemTable').DataTable({
                    paging: true,
                    searching: true,
                    ordering: false,
                    info: false,
                    lengthChange: false,
                    dom: '<"d-flex justify-content-between align-items-center mb-3"<"dt-left"B><"dt-search"f>>rt<"bottom d-flex justify-content-end"p>',
                    buttons: [
                        // ✅ Print
                        {
                            extend: 'print',
                            title: 'Plan Items',
                            text: '<i class="bi bi-printer-fill text-dark fs-5" data-bs-toggle="tooltip" title="Print"></i>',
                            titleAttr: 'Print',
                            exportOptions: {
                                columns: ':not(:last-child)' // exclude actions column
                            },
                            customize: function (win) {
                                $(win.document.body).find('h1').remove();
                                const today = new Date().toLocaleDateString('en-GB');
                                $(win.document.body).prepend(`
    <div style="text-align:center; margin-bottom:10px;">
        <h2 style="margin:0;">Stocl Level</h2>
        <div style="font-size:12px;">Generated Date: ${today}</div>
    </div>
`);
                                const $table = $(win.document.body).find('table');
                                $table.addClass('table table-bordered table-striped').css({ 'font-size': '14px', 'width': '100%', 'border-collapse': 'collapse', 'margin-top': '20px' });
                                $table.find('thead th').css({ 'background-color': '#000', 'color': '#fff', 'text-align': 'center' });
                                $table.find('tbody td').css('text-align', 'center');
                                $table.find('tbody tr').each(function (i) { $(this).find('td:first').text(i + 1); });
                            }
                        },
                        // ✅ PDF
                        {
                            extend: 'pdfHtml5',
                            title: 'Plan Items',
                            text: '<i class="bi bi-file-earmark-pdf text-danger fs-5" data-bs-toggle="tooltip" title="Export to PDF"></i>',
                            titleAttr: 'Export PDF',
                            exportOptions: {
                                columns: ':not(:last-child)',
                                format: {
                                    body: function (data, rowIdx, colIdx) {
                                        if (colIdx === 0) return rowIdx + 1; // ✅ Sr No
                                        if (typeof data === 'string') return data.replace(/<\/?[^>]+(>|$)/g, "").trim();
                                        return data;
                                    }
                                }
                            },
                            customize: function (doc) {
                                try {
                                    // Center and enlarge title
                                    doc.content[0].alignment = 'center';
                                    doc.content[0].fontSize = 14;

                                    // Add export date below title
                                    var exportDate = new Date().toLocaleDateString('en-GB');
                                    doc.content.splice(1, 0, {
                                        text: 'Generated Date: ' + exportDate,
                                        alignment: 'center',
                                        margin: [0, 0, 0, 8],
                                        fontSize: 10
                                    });

                                    // Find table node
                                    var tableNode = doc.content.find(c => c.table);
                                    if (!tableNode) return;

                                    // Apply styling
                                    doc.styles = doc.styles || {};
                                    doc.styles.tableHeader = { alignment: 'center', fillColor: '#212529', color: '#ffffff', bold: true };
                                    doc.styles.tableBodyEven = { alignment: 'center' };
                                    doc.styles.tableBodyOdd = { alignment: 'center' };

                                    // Table borders + padding
                                    tableNode.layout = {
                                        hLineWidth: () => .5, vLineWidth: () => .5,
                                        hLineColor: () => '#dddddd', vLineColor: () => '#dddddd',
                                        paddingLeft: () => 6, paddingRight: () => 6,
                                        paddingTop: () => 4, paddingBottom: () => 4
                                    };

                                    // Re-number Sr No column
                                    tableNode.table.body.forEach((row, i) => {
                                        if (i > 0) row[0] = { text: String(i), alignment: 'center' };
                                    });
                                } catch (err) {
                                    console.error('PDF customize error:', err);
                                }
                            }
                        },
                        // ✅ Excel
                        {
                            extend: 'excelHtml5',
                            title: 'Plan Items',
                            text: '<i class="bi bi-file-earmark-excel text-success fs-5" data-bs-toggle="tooltip" title="Export to Excel"></i>',
                            titleAttr: 'Export Excel',
                            exportOptions: {
                                columns: ':not(:last-child)',
                                format: {
                                    body: function (data, rowIdx, colIdx) {
                                        if (colIdx === 0) return rowIdx + 1; // ✅ Sr No
                                        if (typeof data === 'string') return data.replace(/<\/?[^>]+(>|$)/g, "").trim();
                                        return data;
                                    }
                                }
                            },
                            customize: function (xlsx) {
                                const sheet = xlsx.xl.worksheets['sheet1.xml'];
                                const now = new Date();
                                const formattedDate = now.toLocaleDateString('en-GB'); // DD/MM/YYYY

                                const newRowNumber = 2;

                                // Create "Generated Date" row
                                const dateRow = `
<row r="${newRowNumber}">
    <c t="inlineStr" r="A${newRowNumber}">
        <is><t>Generated Date: ${formattedDate}</t></is>
    </c>
</row>`;

                                // Shift existing rows down by +1
                                $('row', sheet).each(function () {
                                    const r = parseInt($(this).attr('r'));
                                    if (r >= newRowNumber) $(this).attr('r', r + 1);
                                });
                                $('c', sheet).each(function () {
                                    const cellRef = $(this).attr('r');
                                    const col = cellRef.replace(/[0-9]/g, '');
                                    const row = parseInt(cellRef.replace(/[A-Z]/g, ''));
                                    if (row >= newRowNumber) $(this).attr('r', col + (row + 1));
                                });

                                // Add the new date row right after the title
                                $('row[r="1"]', sheet).after(dateRow);

                                // ✅ Merge cells from A to last column
                                const totalCols = $('row c', sheet).last().attr('r').replace(/[0-9]/g, '');
                                let mergeCells = $('mergeCells', sheet);
                                if (mergeCells.length === 0) {
                                    $('worksheet', sheet).prepend(`<mergeCells count="1"><mergeCell ref="A${newRowNumber}:${totalCols}${newRowNumber}"/></mergeCells>`);
                                } else {
                                    const count = parseInt(mergeCells.attr('count')) + 1;
                                    mergeCells.attr('count', count);
                                    mergeCells.append(`<mergeCell ref="A${newRowNumber}:${totalCols}${newRowNumber}"/>`);
                                }

                                // ✅ Center align the merged cell
                                const styles = xlsx.xl['styles.xml'];
                                const styleIndex = $('cellXfs xf', styles).length;
                                $('cellXfs', styles).append('<xf xfId="0" applyAlignment="1"><alignment horizontal="center"/></xf>');
                                $(`c[r="A${newRowNumber}"]`, sheet).attr('s', styleIndex);
                            }
                        },
                        // ✅ CSV
                        {
                            extend: 'csvHtml5',
                            title: 'Plan_Items',
                            text: '<i class="bi bi-filetype-csv text-primary fs-5" data-bs-toggle="tooltip" title="Export to CSV"></i>',
                            titleAttr: 'Export CSV',
                            exportOptions: {
                                columns: ':not(:last-child)',
                                format: {
                                    body: function (data, rowIdx, colIdx) {
                                        if (colIdx === 0) return rowIdx + 1; // ✅ Sr No
                                        if (typeof data === 'string') return data.replace(/<\/?[^>]+(>|$)/g, "").trim();
                                        return data;
                                    }
                                }
                            }
                        }
                    ]
                    ,
                    columnDefs: [{
                        targets: 0,
                        render: function (data, type, row, meta) {
                            return meta.row + 1; // ✅ Sr No
                        }
                    }]

                });
                $('[data-bs-toggle="tooltip"]').tooltip();
                // Toggle approve/reject buttons
                if (status === "Approved" || status === "Rejected") {
                    $('#approveBtn').hide();
                    $('#rejectBtn').hide();
                }

                else {
                    $('#approveBtn').show();
                    $('#rejectBtn').show();
                }

                $('#planDetailsModal').modal('show');
            },
            error: function () {
                alert("⚠️ Failed to load plan details.");
            }
        });
    }


    function closePlanModal() {

        if ($.fn.DataTable.isDataTable('#modalItemTable')) {
            $('#modalItemTable').DataTable().destroy();
        }

        const modal = bootstrap.Modal.getInstance(document.getElementById('planDetailsModal'));
        modal.hide();
    }

    let currentMRPCode = '';

    $(document).ready(function () {
        fetchPlans();

        $('#approveBtn').click(function () {
            const mrpCode = $('#modalPlanCode').text();

            // 🔔 Confirm approval
            Swal.fire({
                title: 'Approve this Plan?',
                text: "This action will mark the MRP plan as approved.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#198754',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, Approve'
            }).then((result) => {
                if (result.isConfirmed) {
                    // 🔄 Show loading while request is processing
                    Swal.fire({
                        title: 'Approving...',
                        text: 'Please wait...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    // 🔧 Send approval request
                    $.ajax({
                        url: '/Inventory/ApprovePlanMHB',
                        type: 'POST',
                        data: { MRPCode: mrpCode },
                        success: function () {
                            Swal.fire({
                                icon: 'success',
                                title: '✅ Approved!',
                                text: 'Plan approved successfully.',
                                showConfirmButton: false,
                                timer: 1500
                            });

                            $('#planDetailsModal').modal('hide');
                            fetchPlans();
                        },
                        error: function () {
                            Swal.fire('❌ Error', 'Failed to approve plan.', 'error');
                        }
                    });
                }
            });
        });

        $('#rejectBtn').click(function () {
            currentMRPCode = $('#modalPlanCode').text();

            // ✅ Don't hide the main modal — just lower its z-index
            $('#planDetailsModal').css('z-index', '1040');
            $('.modal-backdrop').last().css('z-index', '1039');

            // Clear and show rejection modal
            $('#rejectReasonText').val('');
            $('#rejectReasonModal').modal('show');
        });

        // ✅ When Reject modal closes, restore Plan modal z-index and focus it again
        $('#rejectReasonModal').on('hidden.bs.modal', function () {
            $('#planDetailsModal').css('z-index', '1050');  // Bring back above backdrop
            $('body').addClass('modal-open');               // Prevent background scroll
        });

        // Submit Rejection
        $('#submitRejectBtn').click(function () {
            const reason = $('#rejectReasonText').val().trim();
            const mrpCode = currentMRPCode;

            if (reason === '') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Reason Required',
                    text: '⚠️ Please enter a rejection reason.',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            // 🔔 Confirm rejection
            Swal.fire({
                title: 'Reject this Plan?',
                html: `<p>This action will mark the MRP plan as <b>rejected</b>.</p>
               <p><strong>Reason:</strong> ${reason}</p>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, Reject'
            }).then((result) => {
                if (result.isConfirmed) {
                    // 🔄 Show loading while request is processing
                    Swal.fire({
                        title: 'Rejecting...',
                        text: 'Please wait...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    // 🔧 Send rejection request
                    $.ajax({
                        url: '/Inventory/RejectPlanMHB',
                        type: 'POST',
                        data: {
                            MRPCode: mrpCode,
                            Reason: reason
                        },
                        success: function () {
                            Swal.fire({
                                icon: 'success',
                                title: '❌ Rejected!',
                                text: 'Plan rejected successfully.',
                                showConfirmButton: false,
                                timer: 1500
                            });

                            $('#rejectReasonModal').modal('hide');
                            $('#planDetailsModal').modal('hide');
                            fetchPlans();
                        },
                        error: function () {
                            Swal.fire('❌ Error', 'Failed to reject plan.', 'error');
                        }
                    });
                }
            });
        });



    });

    function openEditModal(mrpCode, planName) {

        populateItemDropdown();
        // Store in hidden fields or use directly
        $('#editPlanName').val(planName);
        $('#editMRPCode').val(mrpCode);

        // Clear table
        $('#editItemTableBody').empty();

        // Fetch details from server
        $.ajax({
            url: '/Inventory/showplanforApprovalMHB',
            type: 'GET',
            data: { MRPcode: mrpCode },
            success: function (data) {
                $('#editYear').val(data.Year || '');

               
                function formatDateForInput(dateString) {
                    // This one is for <input type="date">
                    if (!dateString) return '';

                    let day, month, year;

                    if (dateString.includes('-')) {
                        const parts = dateString.split(' ')[0].split('-');
                        [day, month, year] = parts;
                        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`; // ✅ yyyy-MM-dd
                    } else if (dateString.includes('-')) {
                        return dateString.split('T')[0]; // already yyyy-MM-dd
                    }

                    return '';
                }
      
                $('#editFromDate').val(formatDateForInput(data.FromDate));
                $('#editToDate').val(formatDateForInput(data.ToDate));

                 $(document).ready(function () {
        const today = new Date().toISOString().split("T")[0];
        $('#editFromDate').attr("min", today);
        $('#editToDate').attr("min", today);

        // When From Date changes, set To Date min accordingly
        $('#editFromDate').on('change', function () {
            const fromDate = $(this).val();
            $('#editToDate').attr("min", fromDate);

            // Optional: Clear To Date if it's before the new From Date
            const toDate = $('#editToDate').val();
            if (toDate && toDate < fromDate) {
                $('#editToDate').val('');
            }
        });
    });

               

              



                const tbody = $('#editItemTableBody');
                tbody.empty();

                if (data.ItemList && data.ItemList.length > 0) {
                    data.ItemList.forEach(item => {
                        tbody.append(`
                    <tr>
                        <td>${item.ItemName}</td>
                        <td>${item.ItemCode}</td>
                        <td>${item.QuantityMRP}</td>
                        <td>${item.UOMName}</td>
                      <td data-bs-toggle="tooltip" data-bs-placement="top" title="${item.Description}">${item.Description}</td>
                        <td>${item.RequestType}</td>
                      <td>
                            <button class="btn btn-outline-danger btn-sm d-flex  bg-danger align-items-center justify-content-center p-0"
                                    style="width: 32px; height: 32px;"
                                    data-bs-toggle="tooltip" data-bs-placement="top" title="Remove"
                                    onclick="$(this).closest('tr').remove()">
                                <i class="bi bi-trash text-white" ></i>
                            </button>
                        </td>


                    </tr>
                `);

                    });


                } else {
                    tbody.append(`<tr><td colspan="7">No items found.</td></tr>`);
                }

                // ✅ Reinitialize DataTable
              

                $('#editItemTable').DataTable({
                    paging: true,
                    searching: true,
                    ordering: false,
                    info: false,
                    lengthChange: false
                });
                $('[data-bs-toggle="tooltip"]').tooltip();

                new bootstrap.Modal(document.getElementById('editPlanModal')).show();
            },
            error: function () {
                alert("⚠️ Failed to load plan for edit.");
            }
        });

    }

    function closeEditModal() {

        if ($.fn.DataTable.isDataTable('#editItemTable')) {
            $('#editItemTable').DataTable().destroy();
        }

        const modal = bootstrap.Modal.getInstance(document.getElementById('editPlanModal'));
        modal.hide();
    }

    function addItemToEditTable() {
        const itemName = $('#editItemName option:selected').text();
        const itemCode = $('#editItemCode').val();
        const qty = $('#editQuantity').val();
        const uom = $('#editUOM').val();
        const reqType = $('#editRequestType').val();
        const description = $('#editItemDescription').val() || '–';


        if (!itemName || !itemCode ||  !uom || !reqType) {
            Swal.fire({
                icon: 'warning',
                title: 'please Select Item ',
                text: '⚠️ Please fill in all required fields before adding.',
                confirmButtonText: 'OK',
                confirmButtonColor: '#d33'
            });
            return;

        }
        if ( !qty) {
            Swal.fire({
                icon: 'warning',
                title: 'Please Fill Quantity',
                text: '⚠️ Please fill required fields Quantity.',
                confirmButtonText: 'OK',
                confirmButtonColor: '#d33'
            });
            return;

        }

        // ✅ Duplicate check (based on ItemCode or ItemName)
        let duplicateFound = false;
        $('#editItemTableBody tr').each(function () {
            const existingItemName = $(this).find('td:eq(0)').text().trim();
            const existingItemCode = $(this).find('td:eq(1)').text().trim();
            if (existingItemName === itemName || existingItemCode === itemCode) {
                duplicateFound = true;
                return false; // stop loop
            }
        });

        if (duplicateFound) {
            Swal.fire('Duplicate', 'This item is already added.', 'warning');
            return;
        }
      
        $('#editItemTableBody').append(`
            <tr>
                <td>${itemName}</td>
                <td>${itemCode}</td>
                <td>${qty}</td>
                <td>${uom}</td>
                  <td data-bs-toggle="tooltip" data-bs-placement="top" title="${description}">${description}</td>
                <td>${reqType}</td>
                <td>
                    <button class="btn btn-outline-danger btn-sm btn-delete bg-danger d-flex align-items-center justify-content-center"
                            style="width: 32px; height: 32px;"
                            data-bs-toggle="tooltip" data-bs-placement="top" title="Remove"
                            onclick="$(this).closest('tr').remove()">
                        <i class="bi bi-trash-fill text-white"></i>
                    </button>
                  </td>
            </tr>
        `);
        $('[data-bs-toggle="tooltip"]').tooltip();
        // Clear input fields
        $('#editItemCode, #editQuantity, #editUOM, #editRequestType, #editItemDescription').val('');
        $('#editItemName').val('');
    }


 
    
    function populateItemDropdown() {
        $.ajax({
            url: '/Inventory/GetItemListMHB', // Your endpoint
            type: 'GET',
            success: function (items) {
                allItems = items; // store globally
                updateItemDropdown(); // populate with filtered data
            }
        });
    }

    function updateItemDropdown() {
        const ddl = $("#editItemName");
        ddl.empty().append('<option value="">Select Item</option>');

        // get all existing ItemCodes in table
        const existingCodes = [];
        $("#editItemTableBody tr").each(function () {
            const itemCode = $(this).find("td:nth-child(2)").text().trim();
            if (itemCode) existingCodes.push(itemCode);
        });

        // now fill dropdown excluding those already added
        allItems.forEach(i => {
            if (!existingCodes.includes(i.ItemCode)) {
                ddl.append(`<option value="${i.ItemId}">${i.ItemName}</option>`);
            }
        });
    }


    $(document).on('change', '#editItemName', function () {
        const selectedItemId = $(this).val();

        if (!selectedItemId) {
            $('#editItemCode').val('');
            $('#editUOM').val('');
            $('#editItemDescription').val('');
            $('#editRequestType').val(''); // Optional, if clearing needed
            return;
        }

        $.ajax({
            url: '/Inventory/GetItemDetailsMHB',
            type: 'GET',
            data: { itemId: selectedItemId },
            success: function (data) {
                $('#editItemCode').val(data.ItemCode || '');
                $('#editUOM').val(data.UOMName || '');
                $('#editItemDescription').val(data.Description || '');

                // ✅ Set RequestType as "MRPItems" explicitly
                $('#editRequestType').val('MRPItems');
            },
            error: function () {
                Swal.fire("⚠️ Failed to fetch item details.");
            }
        });
    });

    $(document).on('click', '#sendForApprovalBtn', function () {
        let items = [];

        // 🔄 Loop through table rows and build item list
        $('#editItemTableBody tr').each(function () {
            let tds = $(this).find('td');

            items.push({
                ItemName: $(tds[0]).text(),
                ItemCode: $(tds[1]).text(),
                QuantityMRP: $(tds[2]).text(),
                UOMName: $(tds[3]).text(),
                Description: $(tds[4]).text(),
                RequestType: $(tds[5]).text()
            });
        });

        // ⚠️ Validation: no items
        if (items.length === 0) {
            Swal.fire("⚠️ Warning", "Please add at least one item before sending for approval.", "warning");
            return;
        }

        // ✅ Prepare the payload
        let payload = {
            MRPCode: $('#editMRPCode').val(),
            Fromdate: $('#editFromDate').val(),
            ToDate: $('#editToDate').val(),

            ItemList: items
        };

        console.log("Payload:", JSON.stringify(payload));

        // 🔔 Confirm submission
        Swal.fire({
            title: 'Are you sure?',
            text: "Do you want to save these changes?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#198754',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, Submit'
        }).then((result) => {
            if (result.isConfirmed) {
                // 🔄 Show loading
                Swal.fire({
                    title: 'Submitting...',
                    text: 'Please wait...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                // 📨 AJAX call to submit
                $.ajax({
                    url: '/Inventory/SaveEditedPlanMHB',
                    type: 'POST',
                    data: JSON.stringify(payload),
                    contentType: 'application/json; charset=utf-8',
                    success: function (res) {
                        if (res.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '✅ Success',
                                text: 'Your changes have been saved.',
                                showConfirmButton: false,
                                timer: 1500
                            });

                            closeEditModal(); // 👈 Close modal
                            fetchPlans();     // 🔁 Reload plans
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '❌ Failed',
                                text: res.message || 'Failed to submit the plan.'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: '❌ Server Error',
                            text: 'Something went wrong while submitting the plan.'
                        });
                    }
                });
            }
        });
    });

    // Global variables for date range
    let addedStart = null, addedEnd = null;

    // Attach Date Range Picker to "Added Date" filter
    $(document).on('focus', '#createdDateFilter', function () { // keep using your filter input
        if (!$(this).data('daterangepicker')) {
            $(this).daterangepicker({
                autoUpdateInput: false,
                opens: "center",
                drops: "down",
                alwaysShowCalendars: true,
                locale: { cancelLabel: 'Clear' },
                ranges: {
                    'Today': [moment(), moment()],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 1 Month': [moment().subtract(1, 'months').startOf('day'), moment()],
                    'Last 3 Months': [moment().subtract(3, 'months').startOf('day'), moment()],
                    'Last 1 Year': [moment().subtract(12, 'months').startOf('day'), moment()]
                }
            });

            // Apply filter
            $(this).on('apply.daterangepicker', function (ev, picker) {
                addedStart = picker.startDate;
                addedEnd = picker.endDate;
                $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));

                $('#plansTable').DataTable().draw();
            });

            // Clear filter
            $(this).on('cancel.daterangepicker', function () {
                $(this).val('');
                addedStart = null;
                addedEnd = null;
                $('#plansTable').DataTable().draw();
            });
        }
    });

    // DataTable custom search for Added Date (column index 4)
    $.fn.dataTable.ext.search.push(function (settings, data) {
        if (settings.nTable.id !== 'plansTable') return true;

        if (!addedStart || !addedEnd) return true; // no filter applied

        const addedDate = moment(data[4], 'DD/MM/YYYY'); // parse in backend format

        return addedDate.isBetween(addedStart, addedEnd, null, '[]'); // inclusive
    });

    // Enable Bootstrap tooltips everywhere
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

  

</script>
