@{
    Layout = "";
}
<style>
    #categoryTable thead th {
        padding: 0.3rem 0.4rem !important;
    }
</style>
<!-- Category List Card -->
<div class="table-responsive card shadow p-3 bg-white rounded">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="text-primary fw-bolder text-center flex-grow-1 m-0">Category List</h4>
        <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" id="btnAddCategory">
                <i class="bi bi-plus-circle me-2"></i> Add Category
            </button>
            <div id="exportContainer" class="d-flex gap-2"></div>
        </div>
    </div>

    <table id="categoryTable" class="table table-bordered table-striped text-center align-middle">
        <thead class="table-dark">
            <tr>
                <th><input type="checkbox" id="selectAllCategory" /></th>
                <th>Sr. No.</th>
                <th>Category Name</th>
                <th>Description</th>
                <th>HSN Code</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Create/Edit Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content shadow-lg rounded-3">
            <div class="card-header bg-primary text-white d-flex justify-content-center align-items-center rounded-top p-1 position-relative">
                <h3 id="categoryModalTitle" class="modal-title fw-bold text-white mb-0 fs-5 w-100 text-center">
                    Create / Edit Category
                </h3>
                <button type="button" class="btn-close btn-close-white position-absolute end-0 me-3" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="categoryModalBody">
                <p class="text-center py-3">Loading...</p>
            </div>
        </div>
    </div>
</div>

<style>
    button.dt-button.processing,
    div.dt-button.processing {
        pointer-events: auto !important;
        opacity: 1 !important;
        background: none !important;
    }

        button.dt-button.processing:after {
            content: none !important;
        }
</style>

<script>
toastr.options = {
    closeButton: true,
    progressBar: true,
    preventDuplicates: true,
    newestOnTop: true,
    positionClass: "toast-top-right",
    timeOut: "3000"
};

function showExportWarning(msg="Please select at least one row before exporting.") { toastr.warning(msg); }
    function showExportSuccess(msg = "Export completed.") { toastr.success(msg, "Success"); }


$(document).ready(function () {
    let selectedCategories = new Set();
    let exportSerialCounter = 0;

    // Initialize DataTable
    let table = $('#categoryTable').DataTable({
        ordering: false,
        ajax: {
            url: '@Url.Action("GetAllCategoriesSSG","Inventory")',
            type: 'GET',
            dataSrc: function(json){
                if(!json || !json.data) return [];
                if(json.data.length===0) toastr.info("No categories found.");
                return json.data;
            },
            error: function(){ toastr.error("Failed to load category list.","Error"); }
        },
        columns: [
            {
                data:'ItemCategoryId', orderable:false, className:'text-center',
                render: function (d) {
                    return '<input type="checkbox" class="rowCheckboxCategory" value="' + d + '">';
                }
            },
            {
                data:null, className:'text-center',
                render:function(data,type,row,meta){ return meta.row+1; }
            },
            { data:'ItemCategoryName', className:'text-center' },
            {
                data:'Description', className:'text-center',
                render: function (d) {
                    return '<span data-bs-toggle="tooltip" title="' + (d || '') + '">' + (d || '') + '</span>';
                }
            },
            { data:'HSNCode', className:'text-center' },
            {
                data:null, orderable:false, className:'text-center',
                render: function (data,type,row) {
                    return `
                        <div class="d-flex gap-1 justify-content-center">
                            <button class="btn btn-secondary square-pill d-inline-flex align-items-center px-2 py-1 btn-sm btnEditCategory" data-id="${row.ItemCategoryId}" data-bs-toggle="tooltip" title="Edit Category">
                                <i class="bi bi-pencil-square "></i>
                            </button>
                        </div>`;
                }
            }
        ],
        dom:'<"row mb-3"<"col-md-6 d-flex gap-2 align-items-center"B><"col-md-6 d-flex justify-content-end"f>>t<"row mt-3"<"col-md-6"i><"col-md-6 d-flex justify-content-end"p>>',
        buttons: [
            // PRINT
            {
                extend: 'print',
                text: '<i class="bi bi-printer-fill text-dark fs-5"></i>',
                title: '',
                exportOptions: {
                    columns: [2, 3, 4],
                    rows: (idx, data) => selectedCategories.has(data.ItemCategoryId)
                },
                customize: function (win) {
                    let body = $(win.document.body);
                    body.find('h1').remove();

                    body.prepend(
                        '<h2 style="text-align:center; color:black;">Category List</h2>' +
                        '<h5 style="text-align:center; color:black;">Generated Date: ' +
                        moment().format("DD/MM/YYYY") + '</h5>'
                    );

                    body.find('table thead tr').prepend('<th>Sr.No.</th>');
                    let counter = 0;
                    body.find('table tbody tr').each(function () {
                        $(this).prepend('<td>' + (++counter) + '</td>');
                    });

                    let css = `
                        table thead th {
                            background-color: #000 !important;
                            color: #fff !important;
                            text-align: center !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        table tbody td { text-align: center; }
                    `;
                    $(win.document.head).append('<style>' + css + '</style>');
                },
                action: function (e, dt, btn, config) {
                    if (selectedCategories.size === 0) { showExportWarning(); return; }
                    $.fn.dataTable.ext.buttons.print.action.call(this, e, dt, btn, config);
                }
            },

            //  PDF
            {
                extend: 'pdfHtml5',
                text: '<i class="bi bi-file-earmark-pdf fs-5 text-danger"></i>',
                filename: `Category_List_${moment().format("DD-MM-YYYY")}`,
                title: '',
                exportOptions: {
                    columns: [2, 3, 4],
                    rows: (idx, data) => selectedCategories.has(data.ItemCategoryId)
                },
                customize: function (doc) {
                    exportSerialCounter = 0;

                    doc.content.unshift(
                        { text: 'Category List', style: 'title', alignment: 'center', margin: [0, 0, 0, 5], color: 'black' },
                        { text: 'Generated Date: ' + moment().format("DD/MM/YYYY"), style: 'date', alignment: 'center', margin: [0, 0, 0, 10], color: 'black' }
                    );

                    let body = doc.content[doc.content.length - 1].table.body;

                    body[0].unshift({ text: 'Sr.No.', bold: true, fillColor: '#000', color: '#fff', alignment: 'center' });
                    for (let i = 1; i < body.length; i++) {
                        body[i].unshift({ text: (++exportSerialCounter).toString(), alignment: 'center' });
                    }

                    doc.content[doc.content.length - 1].table.widths = Array(body[0].length).fill('*');

                    doc.styles.tableHeader.fillColor = '#000';
                    doc.styles.tableHeader.color = '#fff';
                    doc.styles.tableHeader.alignment = 'center';

                    body.forEach(function (row, rowIndex) {
                        if (rowIndex > 0) {
                            row.forEach(function (cell) {
                                cell.alignment = 'center';
                            });
                        }
                    });

                    doc.content[doc.content.length - 1].layout = {
                        hLineWidth: function () { return 0.5; },
                        vLineWidth: function () { return 0.5; },
                        hLineColor: function () { return '#000'; },
                        vLineColor: function () { return '#000'; }
                    };
                },
                action: function (e, dt, btn, config) {
                    if (selectedCategories.size === 0) { showExportWarning(); return; }
                    $.fn.dataTable.ext.buttons.pdfHtml5.action.call(this, e, dt, btn, config);
                }
            },
            //excel
            {
                extend: 'excelHtml5',
                title: '',
                filename: `Category_List_${moment().format("DD-MM-YYYY")}`,
                text: '<i class="bi bi-file-earmark-excel fs-5 text-success"></i>',
                titleAttr: 'Export Excel',

                action: function (e, dt, button, config) {
                    if (selectedCategories.size === 0) {
                        showExportWarning("Select at least one category to export.");
                        return;
                    }
                    window.__excelSrCounter = 0;
                    $.fn.dataTable.ext.buttons.excelHtml5.action.call(this, e, dt, button, config);
                },

                exportOptions: {
                    columns: [2, 3, 4],
                    rows: (idx, data) => selectedCategories.has(data.ItemCategoryId),
                    format: {
                        body: function (data, row, col, node) {
                            return (typeof data === 'string'
                                ? data.replace(/<\/?[^>]+(>|$)/g, "").trim()
                                : data);
                        }
                    }
                },

                customize: function (xlsx) {
                    const sheet = xlsx.xl.worksheets['sheet1.xml'];
                    const styles = xlsx.xl['styles.xml'];
                    const dateStr = moment().format("DD/MM/YYYY");
                    let rowIndex = 0;
                    $('row', sheet).each(function () {
                        rowIndex++;
                        const cells = $('c', this);

                        if (rowIndex === 1) {
                            $(this).prepend(`
                    <c t="inlineStr" r="A${rowIndex}">
                        <is><t>Sr.No.</t></is>
                    </c>
                `);
                        } else {
                            $(this).prepend(`
                    <c t="inlineStr" r="A${rowIndex}">
                        <is><t>${rowIndex - 1}</t></is>
                    </c>
                `);
                        }
                        cells.each(function () {
                            const cellRef = $(this).attr('r');
                            const col = cellRef.replace(/\d+/g, '');
                            const row = cellRef.replace(/\D/g, '');
                            const newCol = String.fromCharCode(col.charCodeAt(0) + 1);
                            $(this).attr('r', newCol + row);
                        });
                    });

                    $(sheet).find('row').each(function () {
                        const r = parseInt($(this).attr('r'));
                        $(this).attr('r', r + 2);
                        $(this).find('c').each(function () {
                            const cellRef = $(this).attr('r');
                            const col = cellRef.replace(/\d+/g, '');
                            const row = parseInt(cellRef.replace(/\D/g, '')) + 2;
                            $(this).attr('r', col + row);
                        });
                    });

                    const exportedCols = [2, 3, 4];
                    const middleColIndex = Math.floor(exportedCols.length / 2);
                    const colLetter = String.fromCharCode(65 + middleColIndex + 1);
                    const titleRow = `<row r="1">
            <c t="inlineStr" r="${colLetter}1" s="2"><is><t>Category List</t></is></c>
        </row>`;
                    const dateRow = `<row r="2">
            <c t="inlineStr" r="${colLetter}2" s="2"><is><t>Generated Date: ${dateStr}</t></is></c>
        </row>`;

                    sheet.childNodes[0].childNodes[1].innerHTML =
                        titleRow + dateRow + sheet.childNodes[0].childNodes[1].innerHTML;

                    if (styles && $('xf', styles).length) {
                        const styleCount = $('cellXfs xf', styles).length;
                        const newStyle = `
                <xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0" applyAlignment="1">
                    <alignment horizontal="center" vertical="center"/>
                </xf>`;
                        $('cellXfs', styles).append(newStyle);
                        const newStyleId = styleCount;
                        $('c[r=' + colLetter + '1], c[r=' + colLetter + '2]', sheet).attr('s', newStyleId);
                    }

                    const colsXml = `
            <cols>
                <col min="1" max="1" width="8" customWidth="1"/>    <!-- Sr.No. -->
                <col min="2" max="2" width="20" customWidth="1"/>   <!-- Category Name -->
                <col min="3" max="3" width="40" customWidth="1"/>   <!-- Description -->
                <col min="4" max="4" width="15" customWidth="1"/>   <!-- HSN Code -->
            </cols>
        `;

                    $(sheet).find('cols').remove();
                    $(sheet.childNodes[0]).prepend(colsXml);
                }
            },





            // ✅ CSV
            {
                extend: 'csvHtml5',
                text: '<i class="bi bi-filetype-csv fs-5 text-success"></i>',
                title: 'Category_List_' + moment().format("DD-MM-YYYY"),
                exportOptions: {
                    columns: [2, 3, 4],
                    rows: (idx, data) => selectedCategories.has(data.ItemCategoryId)
                },
                customize: function (csv) {
                    let lines = csv.split('\n');
                    let counter = 0;

                    lines = lines.map((line, idx) => {
                        if (idx === 0) return "Sr.No.," + line;
                        if (line.trim() === '') return '';
                        return (++counter) + ',' + line;
                    });

                    return lines.join('\n');
                },
                action: function (e, dt, btn, config) {
                    if (selectedCategories.size === 0) {
                        showExportWarning();
                        return;
                    }
                    $.fn.dataTable.ext.buttons.csvHtml5.action.call(this, e, dt, btn, config);
                }
            }

        ],

        select: { style:'multi', selector:'td:first-child input' },
        rowCallback: function(row,data){
            $(row).find('.rowCheckboxCategory').prop('checked', selectedCategories.has(data.ItemCategoryId));
        },
        drawCallback: function(){
            $('[data-bs-toggle="tooltip"]').each(function(){
                if(this._tooltip) this._tooltip.dispose();
                this._tooltip = new bootstrap.Tooltip(this,{
                    template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner" style="background-color:black;color:white;"></div></div>'
                });
            });
        }
    });

    // Checkbox select
    $(document).on('change','.rowCheckboxCategory',function(){
        const id=parseInt($(this).val());
        $(this).is(':checked')?selectedCategories.add(id):selectedCategories.delete(id);
        $('#selectAllCategory').prop('checked',
            table.rows({page:'current'}).nodes().to$().find('.rowCheckboxCategory').length ===
            table.rows({page:'current'}).nodes().to$().find('.rowCheckboxCategory:checked').length
        );
    });
    $(document).on('change','#selectAllCategory',function(){
        const checked=$(this).is(':checked');
        table.rows().every(function(){ checked?selectedCategories.add(this.data().ItemCategoryId):selectedCategories.delete(this.data().ItemCategoryId); });
        $('#categoryTable').find('.rowCheckboxCategory').prop('checked',checked);
    });

    //  Modal open for Edit
    $(document).on('click','.btnEditCategory',function(){
        const id = $(this).data('id');
        $('#categoryModalTitle').text("Edit Category");
        $('#categoryModal').modal('show');
        $('#categoryModalBody').html('<p class="text-center py-3">Loading...</p>');
        $.get('@Url.Action("CreateCategorySSG","Inventory")',{id:id})
            .done(data=>$('#categoryModalBody').html(data))
            .fail(()=>$('#categoryModalBody').html('<p class="text-danger text-center">Failed to load form.</p>'));
    });

    //  Modal open for Add
    $('#btnAddCategory').on('click',function(){
        $('#categoryModalTitle').text("Create Category");
        $('#categoryModal').modal('show');
        $('#categoryModalBody').html('<p class="text-center py-3">Loading...</p>');
        $.get('@Url.Action("CreateCategorySSG","Inventory")')
            .done(data=>$('#categoryModalBody').html(data))
            .fail(()=>$('#categoryModalBody').html('<p class="text-danger text-center">Failed to load form.</p>'));
    });


});
</script>