@{
    ViewBag.Title = "Inventory Dashboard";
}

<!-- ========================== CSS ========================== -->
<style>
    /* ========== Page Layout & Animations ========== */
    body {
        font-family: 'Poppins', sans-serif;
        background: #f6f9fc;
    }

    .hover-shadow {
        transition: all 0.35s ease-in-out;
    }

        .hover-shadow:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
        }

    .bottom-border {
        height: 4px;
        width: 100%;
        position: absolute;
        bottom: 0;
        left: 0;
    }

    /* Gradient Border Variants */
    .card-border-shadow-primary {
        border-left: 5px solid #4e73df !important;
    }

    .card-border-shadow-success {
        border-left: 5px solid #1cc88a !important;
    }

    .card-border-shadow-warning {
        border-left: 5px solid #f6c23e !important;
    }

    .card-border-shadow-info {
        border-left: 5px solid #36b9cc !important;
    }

    /* Avatar icons */
    .avatar {
        height: 45px;
        width: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.05);
    }

    /* Toast Styling */
    #toastContainer {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1080;
    }

    /* Draggable Floating Button */
    #dateFilterBtn {
        transition: transform 0.3s ease;
    }

        #dateFilterBtn:hover {
            transform: rotate(10deg) scale(1.05);
        }

    /* Highcharts Gradient Glow */
    .highcharts-point {
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    /* Modal custom */
    .modal-content {
        border-radius: 1rem;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
    }

    /* Chart containers */
    .chart-container {
        height: 320px;
        background: linear-gradient(135deg, #ffffff, #f9fafb);
        border-radius: 1rem;
        box-shadow: inset 0 0 20px rgba(240, 240, 255, 0.3);
        transition: all 0.3s ease;
    }

        .chart-container:hover {
            transform: scale(1.01);
        }

    /* Table Enhancements */
    #chartDataTable th {
        text-align: center;
        background: #212529 !important;
        color: #fff;
    }

    #chartDataTable td {
        text-align: center;
    }
</style>
<div class="container-xxl flex-grow-1 container-p-y">

    <!-- Floating Draggable Date Filter -->
    <button id="dateFilterBtn"
            class="btn btn-primary btn-lg rounded-circle shadow-lg position-fixed d-flex align-items-center justify-content-center ripple"
            style="top: 90px; right: 20px; width: 65px; height: 65px; z-index: 1050;">
        <i class="bi bi-calendar-date fs-3"></i>
    </button>
    <input type="text" id="reportrange" style="display:none;" />

    <!-- ====== Statistics Cards ====== -->
    <div class="pb-4">
        <div class="row g-4">

            <div class="col-sm-6 col-lg-3">
                <div class="card card-border-shadow-primary hover-shadow position-relative">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <div class="avatar bg-label-primary me-3">
                                <i class="ri ri-building-4-line text-primary fs-5"></i>
                            </div>
                            <h4 id="WareHouse" class="mb-0 fw-bold text-primary">0</h4>
                        </div>
                        <h6 class="text-muted">Warehouses</h6>
                    </div>
                    <div class="bottom-border bg-primary"></div>
                </div>
            </div>

            <div class="col-sm-6 col-lg-3">
                <div class="card card-border-shadow-success hover-shadow position-relative">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <div class="avatar bg-label-success me-3">
                                <i class="ri ri-layout-column-line text-success fs-5"></i>
                            </div>
                            <h4 id="Rack" class="mb-0 fw-bold text-success">0</h4>
                        </div>
                        <h6 class="text-muted">Racks</h6>
                    </div>
                    <div class="bottom-border bg-success"></div>
                </div>
            </div>

            <div class="col-sm-6 col-lg-3">
                <div class="card card-border-shadow-warning hover-shadow position-relative">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <div class="avatar bg-label-warning me-3">
                                <i class="ri ri-box-3-line text-warning fs-5"></i>
                            </div>
                            <h4 id="Bins" class="mb-0 fw-bold text-warning">0</h4>
                        </div>
                        <h6 class="text-muted">Bins</h6>
                    </div>
                    <div class="bottom-border bg-warning"></div>
                </div>
            </div>

            <div class="col-sm-6 col-lg-3">
                <div class="card card-border-shadow-info hover-shadow position-relative">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <div class="avatar bg-label-info me-3">
                                <i class="ri ri-grid-line text-info fs-5"></i>
                            </div>
                            <h4 id="Section" class="mb-0 fw-bold text-info">0</h4>
                        </div>
                        <h6 class="text-muted">Sections</h6>
                    </div>
                    <div class="bottom-border bg-info"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ====== Charts Section ====== -->
    <div class="row g-4">

        <div class="col-lg-6">
            <div class="card p-3 shadow-sm rounded-4">
                <h6 class="fw-bold mb-3 text-success"><i class="bi bi-bar-chart-fill me-2"></i>Inventory Stocks</h6>
                <div id="inventoryStocks" class="chart-container"></div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card p-3 shadow-sm rounded-4">
                <h6 class="fw-bold mb-3 text-warning"><i class="bi bi-pie-chart-fill me-2"></i>Inventory Breakdown</h6>
                <div id="inventoryBreakdown" class="chart-container"></div>
            </div>
        </div>

        <div class="col-lg-12">
            <div class="card p-3 shadow-sm rounded-4">
                <h6 class="fw-bold mb-3 text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Issue in House</h6>
                <div id="issueHouse" class="chart-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- ===== Modal ===== -->
<div class="modal fade" id="chartModal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white align-content-center" >
                <h5 id="chartModalLabel" class="modal-title w-100 text-center text-white">Details</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table id="chartDataTable" class="table table-striped table-bordered w-100"></table>
            </div>
        </div>
    </div>
</div>

<div id="toastContainer"></div>


<script>



    // Reusable PDF/Print customization function
    function customizeDoc(doc) {
        // Title Styling
        doc.styles.title = {
            color: '#000000',
            fontSize: 16,
            bold: true,
            alignment: 'center'
        };

        // Generated on date
        doc.content.splice(1, 0, {
            text: `Generated on: ${moment().format("DD/MM/YYYY")}`,
            alignment: 'center',
            italics: true,
            fontSize: 10
        });

        // Table Header Styling
        doc.styles.tableHeader = {
            fillColor: '#000000',
            color: 'white',
            bold: true,
            fontSize: 11,
            alignment: 'center'
        };

        // Table Border + Padding
        var objLayout = {};
        objLayout['hLineWidth'] = function () { return .5; };
        objLayout['vLineWidth'] = function () { return .5; };
        objLayout['hLineColor'] = function () { return '#aaa'; };
        objLayout['vLineColor'] = function () { return '#aaa'; };
        objLayout['paddingLeft'] = function () { return 6; };
        objLayout['paddingRight'] = function () { return 6; };

        // Get the table
        var tableNode = doc.content[doc.content.length - 1];
        tableNode.layout = objLayout;

        // Set fixed widths for all columns
        var colCount = tableNode.table.body[0].length;
        tableNode.table.widths = Array(colCount).fill('*');

        // Wrap in margin to simulate center alignment
        tableNode.alignment = 'center';
        tableNode.margin = [0, 0, 0, 0];
    }

    // Clear processing state for all DataTable buttons
    window.__dt_clearAllProcessing = function () {
        try {
            // Try to clear via DataTables API
            var tables = $.fn.dataTable.tables();
            for (var i = 0; i < tables.length; i++) {
                try {
                    var api = $(tables[i]).DataTable();
                    if (!api || !api.buttons) continue;
                    var btnCount = (api.buttons().nodes && api.buttons().nodes().length) || 0;
                    for (var j = 0; j < btnCount; j++) {
                        try { api.button(j).processing(false); } catch (e) { }
                    }
                } catch (e) { }
            }
        } catch (e) { }

        // Fallback DOM cleanup
        try {
            $('.dt-button').removeClass('dt-button-processing');
            $('.dt-button').prop('disabled', false);
        } catch (e) { }
    };

    // Listen for print-done message from print window
    window.addEventListener('message', function (ev) {
        if (ev && ev.data === 'dt_print_done') {
            window.__dt_clearAllProcessing();
        }
    });

    // Store original button actions if not already stored
    if (!$.fn.dataTable.ext.buttons.pdfHtml5.__originalAction) {
        $.fn.dataTable.ext.buttons.pdfHtml5.__originalAction =
            $.fn.dataTable.ext.buttons.pdfHtml5.action;
    }
    if (!$.fn.dataTable.ext.buttons.print.__originalAction) {
        $.fn.dataTable.ext.buttons.print.__originalAction =
            $.fn.dataTable.ext.buttons.print.action;
    }
    if (!$.fn.dataTable.ext.buttons.excelHtml5.__originalAction) {
        $.fn.dataTable.ext.buttons.excelHtml5.__originalAction =
            $.fn.dataTable.ext.buttons.excelHtml5.action;
    }
    if (!$.fn.dataTable.ext.buttons.csvHtml5.__originalAction) {
        $.fn.dataTable.ext.buttons.csvHtml5.__originalAction =
            $.fn.dataTable.ext.buttons.csvHtml5.action;
    }

    // Toast notification function
    // Configure toastr once
    toastr.options = {
        closeButton: true,
        progressBar: true,
        newestOnTop: true,
        positionClass: "toast-top-right",
        preventDuplicates: true,
        timeOut: 3000,
        extendedTimeOut: 1000,
        showDuration: 300,
        hideDuration: 300,
        showMethod: "slideDown",
        hideMethod: "fadeOut"
    };



    let startDate = null;  // keep null until user selects
    let endDate = null;

    function cb(start, end) {
        $('#reportrange').val(start.format('YYYY-MM-DD') + ' - ' + end.format('YYYY-MM-DD'));
        startDate = start;
        endDate = end;

        // refresh charts automatically
        loadAllCharts();
    }

    $(function () {
        $('#dateFilterBtn').daterangepicker({
            autoUpdateInput: false,
            locale: { cancelLabel: 'Clear' },// keep input empty at first
            opens: 'left',
            drops: 'down',     // show below button
            parentEl: 'body',  // attach to body to avoid overflow
            ranges: {
                'Today': [moment(), moment()],
                'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                'This Month': [moment().startOf('month'), moment().endOf('month')],
                'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            }
        }, cb);

        //cb(startDate, endDate);
        loadAllCharts();
    });

    // Clear date range on cancel
    $('#dateFilterBtn').on('cancel.daterangepicker', function (ev, picker) {
        startDate = null;
        endDate = null;

        // Reset the hidden input
        $('#reportrange').val('');

        // Reset button text to default
        $(this).html('<i class="bi bi-calendar-date fs-3"></i>');

        // Reload all charts without filters
        loadAllCharts();
    });




    function getFilterParams() {
        return {
            fromDate: startDate ? startDate.format("YYYY-MM-DD") : "", // empty = no filter
            toDate: endDate ? endDate.format("YYYY-MM-DD") : ""
        };
    }


    // Helper for export validation
    function exportWithValidation(type) {
        return function (e, dt, button, config) {
            let selected = dt.$('.row-select:checked', { page: 'all' }).length;
            if (!selected) {
                showToast("⚠ Please select at least one row before exporting.");
                return;
            }
            $.fn.dataTable.ext.buttons[type].action.call(this, e, dt, button, config);
        };
    }

    // Inventory Modal Table Init
    function openModalWithData(chartType, filterValue) {
        let modal = new bootstrap.Modal(document.getElementById('chartModal'));

        // Map headings for dynamic title
        let headingMap = {
            "InventoryStocks": "Inventory Stocks",
            "InventoryBreakdown": "Inventory Breakdown",
            "IssueHouse": "Issue in House"
        };

        // Set dynamic modal heading
        $("#chartModalLabel").text(headingMap[chartType] || "Details");

        modal.show();

        // Map chartType to API URLs
        let urlMap = {
            "InventoryStocks": "/Inventory/GetInventoryStockDetailsHSB",
            "InventoryBreakdown": "/Inventory/GetCategoryDetailsHSB",
            "IssueHouse": "/Inventory/getIssueInHouseDetailsHSB"
        };
        let url = urlMap[chartType] || "";

        // Destroy old DataTable
        if ($.fn.DataTable.isDataTable('#chartDataTable')) {
            $('#chartDataTable').DataTable().clear().destroy();
            $('#chartDataTable thead').empty();
        }

        // Filters
        let filterParams = getFilterParams();
        let params = {
            filter: filterValue,
            fromDate: filterParams.fromDate,
            toDate: filterParams.toDate,
            category: filterParams.category || ""
        };

        // Common Columns
        let columns = [
            {
                data: null,
                orderable: false,
                className: "dt-body-center no-export",
                title: `<input type="checkbox" id="selectAll">`,
                render: (data, type, row) =>
                    `<input type="checkbox" class="row-select" value="${row.ItemCode || row.GRNCode || row.IssueCode}">`
            },
            {
                data: null,
                title: "SR.NO",
                className: "dt-body-center",
                orderable: false,
                render: (data, type, row, meta) => meta.row + 1
            }
        ];


        // Dynamic columns per chart
        if (chartType === "InventoryStocks") {
            columns.push(
                { data: "ItemName", title: "Item Name" },
                { data: "ItemCode", title: "Item Code" },
                { data: "ItemsCounts", title: "Items Count" },
                { data: "ReorderQuantity", title: "Reorder Count" },
                { data: "BinCode", title: "Bins" }
            );
        } else if (chartType === "InventoryBreakdown") {
            columns.push(
                { data: "ItemName", title: "Item Name" },
                { data: "ItemCode", title: "Item Code" },
                { data: "QuantityStored", title: "Quantity" },
                {
                    data: "CreatedDate",
                    title: "Receive Date",
                    render: function (data, type, row) {
                        // Check if date is valid
                        if (!data) return "";
                        return moment(data).format("DD/MM/YYYY"); // Change to your desired format
                    }
                }
            );
        } else if (chartType === "IssueHouse") {
            columns.push(
                { data: "ItemName", title: "Item Name" },
                //{ data: "BinCode", title: "Bin" },
                { data: "ItemsCounts", title: "Quantity" },
                {
                    data: "AddedDate",
                    title: "Issue Date",
                    render: function (data, type, row) {
                        // Check if date is valid
                        if (!data) return "";
                        return moment(data).format("DD/MM/YYYY"); // Change to your desired format
                    }
                }
            );
        }

        //  Init Inventory Table
        let exportRowIndex = 0;

        let table = $('#chartDataTable').DataTable({
            dom: '<"d-flex justify-content-between align-items-center mb-2"Bf>rt<"d-flex justify-content-between align-items-center mt-2"ip>',
            responsive: true,
            columnDefs: [
                { targets: "_all", className: "text-center" } // center all columns
            ],
            ajax: {
                url: url,
                type: "GET",
                data: params,
                dataSrc: function (json) {
                    if (filterValue === "TotalStock") return json.TotalStock || [];
                    if (filterValue === "LowStock") return json.LowStock || [];
                    if (filterValue === "MostStock") return json.MostStock || [];
                    if (filterValue === "FinishedGoods") return json.FinishedGoods || [];
                    if (filterValue === "SemiFinishedGoods") return json.SemiFinishedGoods || [];
                    if (filterValue === "RawMaterial") return json.RawMaterial || [];
                    if (filterValue === "DeadStock") return json.DeadStock || [];

                    if (chartType === "IssueHouse") return json.IssueHouse || json || [];

                    return json || [];
                }
            },
            columns: columns,
            ordering: false,
            buttons: [
                // PRINT
                {
                    extend: 'print',
                    text: '<i class="bi bi-printer-fill text-dark fs-5"></i>',
                    title: '',
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('.row-select').prop('checked');
                        },
                        columns: ':visible:not(.no-export)',
                        format: {
                            body: function (data, row, column, node) {
                                if (column === 1) return ++exportRowIndex;
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        var selected = dt.rows().nodes().to$().find('input.row-select:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        //  Reset Sr.No before export
                        exportRowIndex = 0;

                        // Show spinner
                        try { btnApi.processing(true); } catch (err) { }

                        // Call original print action
                        try {
                            $.fn.dataTable.ext.buttons.print.__originalAction.call(this, e, dt, button, config);
                        } catch (err) {
                            // Ensure spinner not left running
                            setTimeout(function () { try { btnApi.processing(false); } catch (e) { } }, 300);
                            throw err;
                        }

                        // Final fallback: if print window never reports, clear after 2s
                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 2000);
                    },
                    customize: function (win) {
                        var $body = $(win.document.body);
                        $body.prepend(`
    <h1 style="text-align:center;">Inventory Report</h1>
    <div style="text-align:center;font-style:italic;font-size:10pt;margin-bottom:12px;">
        Generated on: ${moment().format("DD/MM/YYYY")}
    </div>
`);

                        $body.find('table')
                            .addClass('table table-bordered table-striped')
                            .css({ width: '100%', 'border-collapse': 'collapse' });

                        $body.append(`
    <style>
        thead th {
            background-color: black !important;
            color: white !important;
            text-align: center !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        td, th { border: 1px solid #000 !important; padding: 6px !important; text-align:center !important; }
    </style>
`);

                        $body.css('font-size', '12pt');
                    },
                },

                // PDF
                {
                    extend: 'pdf',
                    text: '<i class="bi bi-file-earmark-pdf text-danger fs-5"></i>',
                    title: 'Inventory Report',
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('.row-select').prop('checked');
                        },
                        columns: ':visible:not(.no-export)',
                        format: {
                            body: function (data, row, column, node) {
                                if (column === 1) return ++exportRowIndex;
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        var selected = dt.$('.row-select:checked', { page: 'all' }).length;
                        var btnApi = dt.button(button);
                        if (selected === 0) { showExportToast(); btnApi.processing(false); return; }
                        btnApi.processing(true);

                        if (window.pdfMake && pdfMake.createPdf && !pdfMake._patchedForDT) {
                            (function () {
                                var origCreate = pdfMake.createPdf;
                                pdfMake.createPdf = function (docDefinition) {
                                    var pdfDoc = origCreate.call(pdfMake, docDefinition);
                                    var origDownload = pdfDoc.download;
                                    pdfDoc.download = function (filename, cb) {
                                        origDownload.call(pdfDoc, filename, function () {
                                            try { btnApi.processing(false); } catch (err) { }
                                            if (typeof cb === 'function') cb();
                                        });
                                    };
                                    return pdfDoc;
                                };
                                pdfMake._patchedForDT = true;
                            })();
                        }

                        $.fn.dataTable.ext.buttons.pdfHtml5.__originalAction.call(this, e, dt, button, config);
                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 1500);
                    },
                    customize: function (doc) {
                        doc.pageMargins = [40, 60, 40, 40];
                        doc.styles.title = {
                            fontSize: 16,
                            bold: true,
                            alignment: 'center',
                            margin: [0, 0, 0, 15]
                        };
                        doc.content.splice(1, 0, {
                            text: `Generated on: ${moment().format("DD/MM/YYYY")}`,
                            alignment: 'center',
                            margin: [0, 0, 0, 10],
                            fontSize: 10,
                            italics: true
                        });

                        var tableNode = doc.content.find(n => n.table);
                        if (tableNode) {
                            tableNode.table.widths = [50, 120, 60, 100, 70, 90];
                            tableNode.layout = {
                                fillColor: rowIndex => rowIndex === 0 ? '#343a40' : null,
                                hLineColor: () => '#ccc',
                                vLineColor: () => '#ccc',
                                hLineWidth: () => 0.5,
                                vLineWidth: () => 0.5
                            };
                            tableNode.table.body[0].forEach(cell => {
                                cell.color = 'white';
                                cell.alignment = 'center';
                                cell.bold = true;
                                cell.fontSize = 11;
                            });
                            tableNode.table.body.slice(1).forEach((row, idx) => {
                                row.forEach(cell => {
                                    cell.fontSize = 10;
                                    cell.margin = [5, 3, 5, 3];
                                    cell.alignment = 'center';
                                });
                                if (idx % 2 === 0) {
                                    row.forEach(cell => { cell.fillColor = '#f9f9f9'; });
                                }
                            });
                        }
                    }
                },
                // EXCELn
                // EXCEL EXPORT BUTTON
                {
                    extend: 'excelHtml5',
                    text: '<i class="bi bi-file-earmark-excel text-success fs-5"></i>',
                    title: null,
                    filename: 'Inventory Report',
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('.row-select').prop('checked');
                        },
                        columns: ':visible:not(.no-export)',
                        format: {
                            body: function (data, row, column, node) {
                                if (column === 1) return ++exportRowIndex;
                                return data;
                            }
                        }
                    },
                    customize: function (xlsx) {
                        var sheet = xlsx.xl.worksheets['sheet1.xml'];
                        var stylesXml = xlsx.xl['styles.xml'];




                        // ===== Create a centered text style =====
                        var cellXfs = $('cellXfs xf', stylesXml);
                        var centerStyleIndex = cellXfs.length;
                        cellXfs.last().after(
                            '<xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0" applyAlignment="1">' +
                            '<alignment horizontal="center" vertical="center"/></xf>'
                        );

                        // ===== Detect number of exported columns dynamically =====
                        var numCols = $('cols col', sheet).length;
                        if (numCols === 0) numCols = 7; // fallback if DataTables doesn't generate <cols>

                        // Calculate last column letter (A, B, C, ...)
                        function getExcelColumn(colNum) {
                            var dividend = colNum, columnName = "", modulo;
                            while (dividend > 0) {
                                modulo = (dividend - 1) % 26;
                                columnName = String.fromCharCode(65 + modulo) + columnName;
                                dividend = Math.floor((dividend - modulo) / 26);
                            }
                            return columnName;
                        }
                        var lastColLetter = getExcelColumn(numCols);

                        // ===== Ensure <mergeCells> exists =====
                        if ($('mergeCells', sheet).length === 0) {
                            $('worksheet', sheet).prepend('<mergeCells count="0"></mergeCells>');
                        }

                        var mergeCells = $('mergeCells', sheet);
                        var count = parseInt(mergeCells.attr('count') || 0);

                        // ===== Add merged cells for Title and Date =====
                        mergeCells.append(`<mergeCell ref="A1:${lastColLetter}1"/>`);
                        mergeCells.append(`<mergeCell ref="A2:${lastColLetter}2"/>`);
                        mergeCells.attr('count', count + 2);

                        // ===== Create Title & Date rows =====
                        var title = "Inventory Report";
                        var dateText = "Generated Date: " + moment().format("DD/MM/YYYY");

                        var titleRow = `
    <row r="1">
        <c r="A1" t="inlineStr" s="${centerStyleIndex}">
            <is><t>${title}</t></is>
        </c>
    </row>
    <row r="2">
        <c r="A2" t="inlineStr" s="${centerStyleIndex}">
            <is><t>${dateText}</t></is>
        </c>
    </row>
`;

                        // ===== Shift existing rows down by 2 =====
                        $('row', sheet).each(function () {
                            var r = parseInt($(this).attr('r'));
                            $(this).attr('r', r + 2);
                            $(this).find('c').each(function () {
                                var ref = $(this).attr('r');
                                var col = ref.replace(/[0-9]/g, '');
                                $(this).attr('r', col + (r + 2));
                            });
                        });

                        // ===== Insert new rows at top =====
                        var sheetData = $('sheetData', sheet);
                        sheetData.prepend(titleRow);
                    },
                    action: function (e, dt, button, config) {
                        exportRowIndex = 0;
                        var selected = dt.$('.row-select:checked', { page: 'all' }).length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(true); } catch (err) { }
                        $.fn.dataTable.ext.buttons.excelHtml5.__originalAction.call(this, e, dt, button, config);
                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 300);
                    }
                },
                // CSV
                {
                    extend: 'csv',
                    text: '<i class="bi bi-filetype-csv text-success fs-5"></i>',
                    title: `Inventory_Report_${moment().format("DD/MM/YYYY")}`,
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('.row-select').prop('checked');
                        },
                        columns: ':visible:not(.no-export)',
                        format: {
                            body: function (data, row, column, node) {
                                if (column === 1) return ++exportRowIndex;
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {

                        //  Reset Sr.No before export
                        exportRowIndex = 0;

                        var selected = dt.rows().nodes().to$().find('input.row-select:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(false); } catch (err) { }

                        $.fn.dataTable.ext.buttons.csvHtml5.__originalAction.call(this, e, dt, button, config);

                        // Stop spinner almost immediately (no real callback exists)
                        setTimeout(function () {
                            try { btnApi.processing(false); } catch (err) { }
                        }, 300);
                    }
                },

            ],
            drawCallback: function (settings) {
                // Recalculate Sr.No
                var api = this.api();
                api.column(1, { page: 'current' }).nodes().each((cell, i) => cell.innerHTML = i + 1 + settings._iDisplayStart);
                // Initialize tooltips
                $('[data-bs-toggle="tooltip"]').tooltip({ customClass: 'tooltip-dark' });
            }
        });

        // Configure toastr once
        toastr.options = {
            closeButton: true,
            progressBar: true,
            preventDuplicates: true,
            newestOnTop: true,
            positionClass: "toast-top-right",
            timeOut: "3000" // 3 seconds
        };

        // Helper function for warning toast
        function showExportToast() {
            toastr.warning("Please select at least one row before exporting.");
        }


        //  Apply header background
        $('#chartDataTable thead').addClass("table-dark text-white");


        // Select all / row checkboxes
        $('#chartDataTable thead').on('change', '#selectAll', function () {
            $('#chartDataTable .row-select').prop('checked', $(this).is(':checked'));
        });

        $('#chartDataTable tbody').on('change', '.row-select', function () {
            const all = $('#chartDataTable .row-select').length;
            const checked = $('#chartDataTable .row-select:checked').length;

            // Uncheck selectAll if not all rows are selected
            $('#selectAll').prop('checked', all === checked);
        });

    }

    // === Global Highcharts Theme ===
    Highcharts.setOptions({
        chart: {
            style: {
                fontFamily: 'Poppins, sans-serif'
            }
        },
        colors: ['#6EC6FF', '#FFD54F', '#A5D6A7', '#F48FB1', '#90CAF9', '#CE93D8'],
        title: { style: { color: '#333', fontWeight: 'bold' } },
        xAxis: {
            lineColor: '#e0e0e0',
            labels: { style: { color: '#666', fontSize: '12px' } }
        },
        yAxis: {
            gridLineColor: '#f0f0f0',
            labels: { style: { color: '#666', fontSize: '12px' } }
        },
        tooltip: {
            borderColor: '#ddd',
            borderRadius: 10,
            backgroundColor: 'rgba(255,255,255,0.95)',
            style: { color: '#333', fontSize: '13px' },
            shadow: { color: 'rgba(0,0,0,0.05)', offsetX: 2, offsetY: 2, opacity: 0.5, width: 1 }
        },
        plotOptions: {
            series: { animation: { duration: 1000 } }
        }
    });

    // === Inventory Stocks - Modern Bar Chart ===
    // === Inventory Stocks - Modern Bar Chart ===
    const inventoryChart = Highcharts.chart('inventoryStocks', {
        chart: {
            type: 'bar',
            backgroundColor: 'rgba(255, 255, 255, 0.1)',
            borderRadius: 12,
            style: { fontFamily: 'Poppins, sans-serif' },
            spacing: [10, 10, 15, 10],
            shadow: {
                color: 'rgba(0,0,0,0.05)',
                offsetX: 0,
                offsetY: 3,
                width: 5
            }
        },
        credits: { enabled: false },
        title: false,
        xAxis: {
            categories: ['Total Item', 'Low In Stock', 'Most In Stock'],
            title: {
                text: 'Inventory Status',
                style: {
                    color: '#444',
                    fontWeight: '600',
                    fontSize: '13px'
                }
            },
            labels: {
                style: {
                    color: '#555',
                    fontWeight: '500'
                }
            },
            gridLineWidth: 0
        },
        yAxis: {
            min: 0,
            title: {
                text: 'Number of Items',
                style: {
                    color: '#444',
                    fontWeight: '600',
                    fontSize: '13px'
                }
            },
            gridLineColor: 'rgba(0,0,0,0.05)'
        },
        legend: { enabled: false },
        tooltip: {
            backgroundColor: 'rgba(255,255,255,0.9)',
            borderColor: '#ddd',
            borderRadius: 8,
            shadow: true,
            style: { color: '#333', fontSize: '12px' },
            pointFormat: '<b>{point.y}</b> items'
        },
        plotOptions: {
            bar: {
                borderRadius: 8,
                pointPadding: 0.2,
                groupPadding: 0.05,
                borderWidth: 0,
                dataLabels: {
                    enabled: true,
                    style: { fontSize: '12px', color: '#333', fontWeight: '600' }
                },
                cursor: 'pointer',
                point: {
                    events: {
                        click: function () {
                            let filterValue = "";
                            if (this.category === "Total Item") filterValue = "TotalStock";
                            if (this.category === "Low In Stock") filterValue = "LowStock";
                            if (this.category === "Most In Stock") filterValue = "MostStock";
                            openModalWithData("InventoryStocks", filterValue);
                        }
                    }
                }
            }
        },
        series: [{
            name: 'Items',
            colorByPoint: true,
            data: [
                {
                    y: 0,
                    color: {
                        linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
                        stops: [
                            [0, '#36D1DC'],
                            [1, '#5B86E5']
                        ]
                    }
                },
                {
                    y: 0,
                    color: {
                        linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
                        stops: [
                            [0, '#F7971E'],
                            [1, '#FFD200']
                        ]
                    }
                },
                {
                    y: 0,
                    color: {
                        linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
                        stops: [
                            [0, '#56ab2f'],
                            [1, '#a8e063']
                        ]
                    }
                }
            ]
        }]
    });


    // === Inventory Breakdown - Beautiful Pastel Doughnut Pie ===
    const inventoryBreakdownChart = Highcharts.chart('inventoryBreakdown', {
        chart: {
            type: 'pie',
            backgroundColor: 'transparent',
            spacing: [10, 0, 10, 0],
            style: { fontFamily: 'Poppins, sans-serif' }
        },
        credits: { enabled: false },
        title: false,
        tooltip: {
            backgroundColor: 'rgba(255,255,255,0.95)',
            borderColor: '#eee',
            borderRadius: 10,
            shadow: true,
            style: { fontSize: '13px', color: '#333' },
            pointFormat: '<b>{point.name}</b>: {point.y}'
        },
        plotOptions: {
            pie: {
                innerSize: '70%',
                borderWidth: 4,
                borderColor: '#fff',
                allowPointSelect: true,
                slicedOffset: 10,
                startAngle: -90,
                endAngle: 270,
                shadow: { color: 'rgba(0,0,0,0.08)', offsetX: 0, offsetY: 2, width: 8 },
                dataLabels: {
                    enabled: true,
                    distance: 25,
                    style: { color: '#444', fontSize: '13px', fontWeight: 500 },
                    connectorColor: '#ccc',
                    format: '{point.name}<br><b>{point.y}</b>'
                },
                states: {
                    hover: {
                        halo: { size: 12, opacity: 0.35 },
                        brightness: 0.18
                    }
                },
                point: {
                    events: {
                        click: function () {
                            const map = {
                                "Finished Goods": "FinishedGoods",
                                "SemiFinished Goods": "SemiFinishedGoods",
                                "Raw Material": "RawMaterial",
                                "Dead Stock": "DeadStock"
                            };
                            openModalWithData("InventoryBreakdown", map[this.name]);
                        }
                    }
                }
            }
        },
        series: [{
            name: 'Count',
            innerSize: '70%',
            animation: { duration: 1000 },
            data: [
                {
                    name: 'Finished Goods',
                    y: 0,
                    color: {
                        linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
                        stops: [
                            [0, '#42a5f5'],   // Sky Blue
                            [1, '#1e88e5']    // Deep Blue
                        ]
                    }
                },
                {
                    name: 'SemiFinished Goods',
                    y: 0,
                    color: {
                        linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
                        stops: [
                            [0, '#ffb74d'],   // Light Orange
                            [1, '#f57c00']    // Deep Amber
                        ]
                    }
                },
                {
                    name: 'Raw Material',
                    y: 0,
                    color: {
                        linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
                        stops: [
                            [0, '#81c784'],   // Fresh Green
                            [1, '#388e3c']    // Deep Green
                        ]
                    }
                },
                {
                    name: 'Dead Stock',
                    y: 0,
                    color: {
                        linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
                        stops: [
                            [0, '#ef5350'],   // Soft Red
                            [1, '#c62828']    // Deep Red
                        ]
                    }
                }
            ]

        }]
    });


    // === Issue in House - Line Chart ===
    const issueHouseChart = Highcharts.chart('issueHouse', {
        chart: {
            type: 'spline',
            backgroundColor: 'transparent',
            borderRadius: 10,
            shadow: { color: 'rgba(0,0,0,0.05)', offsetX: 0, offsetY: 3, width: 5 }
        },
        credits: { enabled: false },
        title: { text: 'Monthly Issues in House', style: { fontSize: '15px', fontWeight: 600, color: '#444' } },
        xAxis: { categories: [], lineColor: '#ddd' },
        yAxis: { title: { text: 'Issues' }, gridLineColor: '#f3f3f3' },
        plotOptions: {
            spline: {
                marker: { radius: 5, lineColor: '#fff', lineWidth: 2 },
                lineWidth: 3,
                cursor: 'pointer',
                point: {
                    events: {
                        click: function () {
                            openModalWithData("IssueHouse", this.category);
                        }
                    }
                }
            }
        },
        tooltip: { pointFormat: '<b>{point.y}</b> issues reported' },
        series: [{
            name: 'Issues',
            data: [],
            color: '#BA68C8'
        }]
    });

    // === Data Loaders ===
    function loadInventoryStocks() {
        $.get("/Inventory/GetInventoryStockHSB", getFilterParams(), function (data) {
            $("#TotalCount").text(data.TotalCount);
            $("#LowCount").text(data.LowInStocks);
            $("#MostInStocks").text(data.MostInStocks);
            inventoryChart.series[0].setData([data.TotalCount, data.LowInStocks, data.MostInStocks]);
        });
    }

    // === Load Dynamic Data ===
    function loadInventoryBreakdown() {
        $.get("/Inventory/GetItemsCategoryHSB", getFilterParams(), function (data) {
            inventoryBreakdownChart.series[0].setData([
                {
                    name: 'Finished Goods',
                    y: data.FinishedGoods,
                    color: {
                        linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
                        stops: [
                            [0, '#36D1DC'],   // Aqua Blue
                            [1, '#5B86E5']    // Ocean Blue
                        ]
                    }
                },
                {
                    name: 'SemiFinished Goods',
                    y: data.SemiFinishedGoods,
                    color: {
                        linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
                        stops: [
                            [0, '#F7971E'],   // Sunset Orange
                            [1, '#FFD200']    // Warm Yellow
                        ]
                    }
                },
                {
                    name: 'Raw Material',
                    y: data.RawMaterial,
                    color: {
                        linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
                        stops: [
                            [0, '#56ab2f'],   // Fresh Green
                            [1, '#a8e063']    // Lime Green
                        ]
                    }
                },
                {
                    name: 'Dead Stock',
                    y: data.DeadStock,
                    color: {
                        linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
                        stops: [
                            [0, '#8E2DE2'],   // Deep Purple
                            [1, '#4A00E0']    // Electric Violet
                        ]
                    }
                }
            ]);

        });
    }

    function loadIssueHouse() {
        $.get("/Inventory/GetIssueInHouseHSB", getFilterParams(), function (data) {
            let IssueMonth = data.map(item => item.IssueMonth);
            let Issue = data.map(item => item.Issue);
            issueHouseChart.xAxis[0].setCategories(IssueMonth);
            issueHouseChart.series[0].setData(Issue);
        });
    }

    function loadAllCharts() {
        loadInventoryStocks();
        loadInventoryBreakdown();
        loadIssueHouse();
    }



    $(document).ready(function () {
        loadAllCharts();
    });

    $(document).ready(function () {
        // Make floating button draggable
        $("#dateFilterBtn").draggable({
            containment: "window", // restrict movement inside the window
            scroll: false
        });
    });

    //Toaster show

    function showToast(message, type = "danger") {
        let toastId = "toast-" + Date.now();
        let bgClass = (type === "success") ? "bg-success" :
            (type === "info") ? "bg-info" : "bg-warning";

        let toastHtml = `
    <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0"
         role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>`;
        $("#toastContainer").append(toastHtml);
        let toastEl = new bootstrap.Toast(document.getElementById(toastId), { delay: 3000 });
        toastEl.show();
    }


    $.get("/Inventory/getTotalBinHSB", function (data) {

        var bin = $("#Bins");
        var Rack = $("#Rack");
        var WareHouse = $("#WareHouse");
        var Section = $("#Section");

        bin.text(data.Bin);
        Rack.text(data.Rack);
        WareHouse.text(data.WareHouse);
        Section.text(data.Section);

    });




</script>



