@model P2PLibray.Purchase.Purchase
@{
    ViewBag.Title = "Items Request Management";
}

<div class="container">
    <div class="card shadow-lg border-0 rounded-4 p-4">
        <h3 class="mb-1 text-primary text-center">Items Request Management</h3>
        <div class="row mb-3">
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label form-label-sm fw-bold">
                        Items Request: <span class="text-danger">*</span>
                    </label>
                    <select id="ItemReqStatus" class="form-select form-select-sm"></select>
                </div>
                <div class="col-md-3 mb-1">
                    <label class="form-label form-label-sm fw-bold">
                        Select Plan: <span class="text-danger">*</span>
                    </label>
                    <select id="planname" class="form-select form-select-sm" disabled style="max-height:100px !important; overflow-y:auto"></select>
                </div>
            </div>
        </div>
        <div class="mb-1">
            <div class="d-flex justify-content-between align-items-center">
                <!-- Datepicker (Left) -->
                <div class="input-group" style="max-width: 280px;">
                    <span class="input-group-text bg-primary text-white">
                        <i class="bi bi-calendar-date"></i>
                    </span>
                    <input type="text" id="FirstreportrangePSM" class="form-control" readonly placeholder="Select Date Range" />
                </div>

                <button type="button" id="btnCreatePR" class="btn btn-sm btn-success shadow-sm px-5">
                    <i class="bi bi-plus-circle small me-2"></i> <span class="small">Create PR</span>
                </button>
            </div>
            <div class="table-responsive text-center mt-3">
                <table id="itemsTable" class="table table-bordered table-striped table-hover w-100 text-center align-middle">
                    <thead class="table-dark text-center">
                        <tr>
                            <th><input type="checkbox" id="selectAll" /></th>
                            <th>SR No</th>
                            <th>Item Code</th>
                            <th>Item Name</th>
                            <th>Description</th>
                            <th>UOM</th>
                            <th class="text-center">Unit Rate</th>
                            <th class="text-center">Quantity</th>
                            <th class="text-center">Required Date</th>
                        </tr>
                    </thead>
                    <tbody class="text-center"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create PR Modal -->
    <div class="modal fade" id="createPRModal" tabindex="-1" aria-labelledby="createPRModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="card-header bg-primary text-white d-flex justify-content-center align-items-center rounded-top p-1">
                    <h3 class="modal-title fw-bold text-white mb-0 fs-5" id="createPRModalLabel">
                        Create Purchase Requisition For Stock Requirement and MRP Items
                    </h3>
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-2 fs-5" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="prForm">
                        @Html.AntiForgeryToken()
                        <div class="row g-4 mb-3">
                            <div class="col-md-3">
                                <label class="form-label form-label-sm fw-bold">Purchase Requisition No:</label>
                                <input type="text" id="PRcode" name="PRCode" class="form-control form-control-sm bg-light text-dark border-secondary" readonly />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label form-label-sm fw-bold">PR Required Date:<span class="text-danger">*</span></label>
                                <input type="date" id="ToDate" name="RequiredDate" class="form-control form-control-sm" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label form-label-sm fw-bold">Priority:<span class="text-danger">*</span></label>
                                <select id="priority" name="PriorityId" class="form-select form-select-sm "></select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped text-center" id="ItemTable">
                                <thead class="table-dark text-center justify-content-center">
                                    <tr>
                                        <th>SR No</th>
                                        <th>Item Code</th>
                                        <th>Item Name</th>
                                        <th>Description</th>
                                        <th>UOM</th>
                                        <th>Unit Rate</th>
                                        <th>Quantity</th>
                                        <th>Required Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="modalTableBody"></tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mb-3">
                            <button type="submit" class="btn btn-sm btn-success shadow-sm px-5">
                                <span class="small">
                                    <i class="bi bi-check-circle small me-2"></i> Save PR
                                    </span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    .dropdown-container {
        position: relative;
        display: inline-block;
        width: 250px;
        font-family: system-ui, sans-serif;
    }
    /* Force fixed dropdown width */
    #planname[size="5"] {
        overflow-y: auto;
    }

    .limited-dropdown {
        max-height: calc(1.5em * 5); /* 5 rows + padding */
        overflow-y: auto;
    }

        .limited-dropdown option {
            padding: 5px;
        }

    /* ✅ TABLE — compact layout */
    table.dataTable td,
    table.dataTable th,
    .modal table td,
    .modal table th {
        padding: 0.35rem 0.5rem !important;
        font-size: 0.78rem !important;
        vertical-align: middle !important;
    }

    /* ✅ DELETE BTN (modal + table) */
    .btn-delete {
        padding: 2px 6px !important;
        font-size: 0.75rem !important;
        line-height: 1 !important;
    }

        .btn-delete i {
            font-size: inherit !important;
        }

    /* ✅ VIEW PO BUTTON — small square */
    .btnViewPO {
        padding: 0 !important;
        font-size: 0.70rem !important;
        width: 28px !important;
        height: 28px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

        .btnViewPO i {
            font-size: inherit !important;
        }

    /* ✅ Square utility class — applied globally */
    .square-btn {
        width: 28px !important;
        height: 28px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 0 !important;
    }
    td, th {
        text-align: center !important;
    }
</style>

<script>
    //Toastr configuration
    toastr.options = {
        closeButton: true,
        progressBar: true,
        newestOnTop: true,
        positionClass: "toast-top-right",
        preventDuplicates: true,
        timeOut: 3000
    };
    function stripHtml(html) {
        if (html == null) return '';
        if (typeof html !== 'string') {
            try { html = String(html); } catch (e) { html = ''; }
        }
        var tmp = document.createElement("DIV");
        tmp.innerHTML = html;
        return tmp.textContent || tmp.innerText || "";
    }

    function updateCreatePRButtonState() {
        var checkedCount = $('#itemsTable tbody .rowCheckbox:checked').length;
        var $btnCreatePR = $('#btnCreatePR');

        if (checkedCount > 0) {
            $btnCreatePR.css('pointer-events', 'auto');
            $btnCreatePR.css('opacity', '1');
        } else {
            $btnCreatePR.css('pointer-events', 'none');
            $btnCreatePR.css('opacity', '1');
        }
        $btnCreatePR.removeClass('btn-secondary').addClass('btn-success');
    }



    $(function () {
        var table;
        var prItems = [];
        var dateFrom = "", dateTo = "";

        // Initialize DataTable
        table = $('#itemsTable').DataTable({
            dom: '<"d-flex justify-content-between align-items-center mb-2"Bf>rt<"d-flex justify-content-between align-items-center"i p>',
            responsive: true,
            processing: true,
            language: {
                emptyTable: "No data available",
                zeroRecords: "No matching items found"
            },
            columns: [
                {
                    data: null,
                    render: function () {
                        return '<input type="checkbox" class="rowCheckbox"/>';
                    },
                    orderable: false,
                    width: "1%",
                    className: "text-center align-middle"
                },
                {
                    data: null,
                    render: function (d, t, r, meta) {
                        return meta.row + 1 + meta.settings._iDisplayStart;
                    },
                    orderable: false,
                    width: "5%",
                    className: "text-center align-middle"
                },
                { data: "ItemCode", className: "text-center align-middle" },
                { data: "ItemName", className: "text-center align-middle" },
                {
                    data: "Description",
                    render: function (data, type, row) {
                        if (type === 'display') {
                            if (!data) return "";
                            let full = data;
                            let shortText = (full.length > 20 ? full.substring(0, 20) + "..." : full);
                            return `<span data-bs-toggle="tooltip" data-bs-placement="top" title="${full.replace(/"/g, '&quot;')}">${shortText}</span>`;
                        }
                        return data || "";
                    },
                    className: "text-center align-middle"
                },
                { data: "UOMName", className: "text-center align-middle" },
                {
                    data: "UnitRates",
                    render: function (data, type, row) {
                        if (data == null || data === "") return "";
                        return `<i class="bi bi-currency-rupee"></i> ${data}`;
                    },
                    className: "text-center align-middle"
                },
                { data: "Quantity", className: "text-center align-middle" },
                {
                    data: "RequiredDate",
                    render: function (data, type, row) {
                        if (!data) return "";
                        var date = new Date(data);
                        var day = String(date.getDate()).padStart(2, '0');
                        var month = String(date.getMonth() + 1).padStart(2, '0');
                        var year = date.getFullYear();

                        return `${day}/${month}/${year}`;
                    },
                    className: "text-center align-middle"
                }
            ],
            ordering: false,
            buttons: [
                //Print
                {
                    extend: 'print',
                    text: '<i class="bi bi-printer-fill text-dark fs-5"></i>',
                    titleAttr: 'Print',
                    title: 'Approved And Open Purchase Orders',
                    exportOptions: {
                        columns: [2, 3, 4, 5, 6, 7, 8],
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        }
                    },
                    customize: function (win) {
                        var $body = $(win.document.body);

                        // Add styling
                        $body.append(`<style>thead th {
                        background-color: black !important;
                        color: white !important;
                        text-align: center !important;
                        -webkit-print-color-adjust: exact !important;
                         print-color-adjust: exact !important;
                         }
                         table { border-collapse: collapse !important; width: 100% !important; }
                         td, th { border: 1px solid #000 !important; padding: 6px !important; }
                         </style>`);
                        $body.find('h1').css('text-align', 'center');
                        var today = new Date();
                        var formattedDate = String(today.getDate()).padStart(2, '0') + '/' +
                            String(today.getMonth() + 1).padStart(2, '0') + '/' +
                            today.getFullYear();
                        $body.find('h1').after('<div style="text-align:center;font-style:italic;font-size:10pt;margin-bottom:12px;">Generated Date: ' + formattedDate + '</div>');
                        var $table = $body.find('table');
                        $table.addClass('table table-bordered table-striped').css('width', '100%');
                        $table.find('thead tr').prepend('<th>Sr No</th>');
                        $table.find('tbody tr').each(function (index) {
                            $(this).prepend('<td style="text-align:center;">' + (index + 1) + '</td>');
                        });
                        $body.css('font-size', '12pt');
                    },
                    action: function (e, dt, button, config) {
                        var selected = dt.rows().nodes().to$().find('input.rowCheckbox:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(true); } catch (err) { }

                        try {
                            if (!$.fn.dataTable.ext.buttons.print._orig) {
                                $.fn.dataTable.ext.buttons.print._orig = $.fn.dataTable.ext.buttons.print.action || $.fn.dataTable.ext.buttons.print;
                            }
                            $.fn.dataTable.ext.buttons.print._orig.call(this, e, dt, button, config);
                        } catch (err) {
                            setTimeout(function () { try { btnApi.processing(false); } catch (e) { } }, 300);
                            throw err;
                        }

                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 2000);
                    }
                },
                //PDF
                {
                    extend: 'pdfHtml5',
                    text: '<i class="bi bi-file-earmark-pdf text-danger fs-5"></i>',
                    titleAttr: 'PDF',
                    title: 'Items Request Report',
                    orientation: 'landscape',
                    pageSize: 'A4',
                    exportOptions: {
                        columns: [2, 3, 4, 5, 6, 7, 8],
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        },
                        format: {
                            body: function (data, rowIdx, colIdx, node) {
                                if (colIdx === 2) return rowIdx + 1; // Sr No
                                return $('<div>').html(data).text(); // Strip HTML
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        var selected = $('.rowCheckbox:checked').length;
                        var btnApi = dt.button(button);

                        // ✅ If no rows selected
                        if (selected === 0) {
                            toastr.warning("Please select at least one row before exporting!");
                            btnApi.processing(false);
                            return;
                        }

                        // ✅ Start spinner
                        btnApi.processing(true);

                        // ✅ Patch pdfMake to stop spinner after download
                        if (window.pdfMake && pdfMake.createPdf && !pdfMake._patchedForDT) {
                            (function () {
                                var origCreate = pdfMake.createPdf;
                                pdfMake.createPdf = function (docDefinition) {
                                    var pdfDoc = origCreate.call(pdfMake, docDefinition);
                                    var origDownload = pdfDoc.download;
                                    pdfDoc.download = function (filename, cb) {
                                        origDownload.call(pdfDoc, filename);
                                        // Stop spinner after small delay
                                        setTimeout(() => {
                                            try { btnApi.processing(false); } catch (err) { }
                                            if (typeof cb === 'function') cb();
                                        }, 1000);
                                    };
                                    return pdfDoc;
                                };
                                pdfMake._patchedForDT = true;
                            })();
                        }

                        // ✅ Ensure DataTables has the original action stored
                        if (!$.fn.dataTable.ext.buttons.pdfHtml5.__originalAction) {
                            $.fn.dataTable.ext.buttons.pdfHtml5.__originalAction =
                                $.fn.dataTable.ext.buttons.pdfHtml5.action;
                        }

                        // ✅ Call DataTables' built-in export
                        $.fn.dataTable.ext.buttons.pdfHtml5.__originalAction.call(this, e, dt, button, config);

                        // ✅ Safety stop if stuck
                        setTimeout(() => { try { btnApi.processing(false); } catch (err) { } }, 3000);
                    },

                    customize: function (doc) {
                        // ---------- PAGE SETTINGS ----------
                        doc.pageSize = 'A4';
                        doc.pageOrientation = 'landscape';
                        doc.defaultStyle.fontSize = 9;
                        doc.defaultStyle.alignment = 'center';
                        doc.styles.tableHeader.fontSize = 10;
                        doc.styles.tableHeader.fillColor = '#343a40';
                        doc.styles.tableHeader.color = 'white';
                        doc.styles.tableHeader.bold = true;
                        doc.styles.tableHeader.alignment = 'center';
                        // ---------- GENERATED DATE ----------
                        doc.content.splice(1, 0, {
                            text: `Generated on: ${moment().format("DD-MM-YYYY HH:mm")}`,
                            alignment: 'center',
                            margin: [0, 0, 0, 12],
                            fontSize: 9,
                            italics: true
                        });

                        // ---------- FIND TABLE ----------
                        function findTableNodeIndex(doc) {
                            for (var i = 0; i < doc.content.length; i++) {
                                if (doc.content[i].table) return i;
                            }
                            return -1;
                        }

                        const stripHtml = html => $('<div>').html(html).text();
                        var tableNodeIndex = findTableNodeIndex(doc);
                        if (tableNodeIndex < 0) return;
                        var tableNode = doc.content[tableNodeIndex];
                        if (!tableNode || !tableNode.table || !tableNode.table.body) return;

                        // ---------- ADD SR NO ----------
                        var headerRow = tableNode.table.body[0];
                        headerRow.unshift({ text: 'Sr No', style: 'tableHeader' });

                        for (var r = 1; r < tableNode.table.body.length; r++) {
                            var row = tableNode.table.body[r];
                            row.unshift({ text: String(r), alignment: 'center' });
                        }

                        // ---------- SET COLUMN WIDTHS ----------
                        tableNode.table.widths = ['5%', '12%', '15%', '30%', '10%', '10%', '9%', '9%'];

                        // ---------- STYLE CELLS ----------
                        for (var i = 1; i < tableNode.table.body.length; i++) {
                            var row = tableNode.table.body[i];
                            for (var j = 0; j < row.length; j++) {
                                var cell = row[j];
                                var txt = stripHtml(cell.text || cell);
                                row[j] = { text: txt, fontSize: 8, margin: [2, 3, 2, 3], alignment: j === 3 ? 'left' : 'center' };
                            }
                        }

                        // ---------- ADD BORDERS ----------
                        tableNode.layout = {
                            hLineWidth: () => 0.5,
                            vLineWidth: () => 0.5,
                            hLineColor: () => '#aaa',
                            vLineColor: () => '#aaa',
                            paddingLeft: () => 4,
                            paddingRight: () => 4,
                            paddingTop: () => 3,
                            paddingBottom: () => 3
                        };
                    }
                },
                //Excel
                {
                    extend: 'excelHtml5',
                    text: '<i class="bi bi-file-earmark-excel-fill text-success fs-5"></i>',
                    titleAttr: 'Export Excel',
                    filename: `Purchase_Order_Report_${moment().format("YYYY-MM-DD_HH-mm-ss")}`,

                    exportOptions: {
                        columns: ':visible',
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        }
                    },

                    action: function (e, dt, button, config) {
                        const selectedRows = dt.rows().nodes().to$().find('input.rowCheckbox:checked');
                        const btnApi = dt.button(button);

                        if (selectedRows.length === 0) {
                            if (typeof showExportToast === 'function') showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(true); } catch (err) { }

                        const selectedData = [];
                        let srNo = 1;

                        selectedRows.each(function () {
                            const tr = $(this).closest('tr');
                            const rowData = dt.row(tr).data();
                            if (!rowData) return;

                            selectedData.push([
                                srNo++,
                                rowData.ItemCode || '',
                                rowData.ItemName || '',
                                rowData.Description || '',
                                rowData.UOMName || '',
                                rowData.UnitRates || '',
                                rowData.Quantity || '',
                                rowData.RequiredDate
                                    ? new Date(rowData.RequiredDate).toLocaleDateString("en-GB")
                                    : '',
                            ]);
                        });
                        // Format date as DD/MM/YYYY
                        const today = new Date();
                        const formattedDate = String(today.getDate()).padStart(2, '0') + '/' +
                            String(today.getMonth() + 1).padStart(2, '0') + '/' +
                            today.getFullYear();

                        // Create temporary table / DataTable for Excel export
                        const tempDt = $('<table>').DataTable({
                            data: selectedData,
                            columns: [
                                { title: 'SR.NO.' },
                                { title: 'Item Code' },
                                { title: 'Item Name' },
                                { title: 'Description' },
                                { title: 'UOM Name' },
                                { title: 'Unit Rates' },
                                { title: 'Quantity' },
                                { title: 'Required Date' },
                            ],
                            dom: 'Bfrtip',
                            buttons: [{
                                extend: 'excelHtml5',
                                title: null,
                                filename: `GR_Summary_Report_${moment().format("YYYY-MM-DD_HH-mm-ss")}`,
                                customize: function (xlsx) {
                                    const sheet = xlsx.xl.worksheets['sheet1.xml'];
                                    const sheetData = $('sheetData', sheet);
                                    // 1️⃣ Shift existing rows down by 3
                                    $('row', sheetData).each(function () {
                                        const $row = $(this);
                                        const r = parseInt($row.attr('r'), 10);
                                        const newR = r + 3;
                                        $row.attr('r', newR);
                                        // Update each cell reference in this row
                                        $row.find('c').each(function () {
                                            const $c = $(this);
                                            const cellRef = $c.attr('r');
                                            if (!cellRef) return;
                                            const col = cellRef.replace(/\d+$/, '');
                                            const rowNum = parseInt(cellRef.match(/\d+$/)[0], 10);
                                            $c.attr('r', col + (rowNum + 3));
                                        });
                                    });
                                    // 2️⃣ Create centered title & date rows (with style index 51)
                                    const titleCell = `<row r="1"><c r="A1" t="inlineStr" s="51"><is><t>Goods Return Summary Report</t></is></c></row>`;
                                    const dateCell = `<row r="2"><c r="A2" t="inlineStr" s="51"><is><t>Generated Date: ${formattedDate}</t></is></c></row>`;
                                    const blankRow = `<row r="3"></row>`;
                                    // Add them at the top
                                    sheetData.prepend(blankRow);
                                    sheetData.prepend(dateCell);
                                    sheetData.prepend(titleCell);
                                    // 3️⃣ Merge A1:H1 and A2:H2 (center across columns)
                                    const mergeRef1 = 'A1:H1';
                                    const mergeRef2 = 'A2:H2';
                                    if ($('mergeCells', sheet).length === 0) {
                                        const mergeXml = `<mergeCells count="2"><mergeCell ref="${mergeRef1}"/><mergeCell ref="${mergeRef2}"/></mergeCells>`;
                                        $('sheetData', sheet).after(mergeXml);
                                    } else {
                                        $('mergeCells', sheet).append(`<mergeCell ref="${mergeRef1}"/>`);
                                        $('mergeCells', sheet).append(`<mergeCell ref="${mergeRef2}"/>`);
                                        const currentCount = parseInt($('mergeCells', sheet).attr('count') || '0', 10);
                                        $('mergeCells', sheet).attr('count', currentCount + 2);
                                    }
                                    // 4️⃣ Add centered style (s="51") if not defined already
                                    const styles = xlsx.xl['styles.xml'];
                                    const cellXfs = $('cellXfs', styles);
                                    if (cellXfs.find('xf[applyAlignment]').length === 0) {
                                        cellXfs.append(`<xf xfId="0" applyAlignment="1"><alignment horizontal="center" vertical="center"/></xf>`);
                                        const count = parseInt(cellXfs.attr('count'), 10) || 0;
                                        cellXfs.attr('count', count + 1);
                                    }
                                    // 5️⃣ Optional: widen columns
                                    if ($('cols', sheet).length === 0) {
                                        let colsXml = '<cols>';
                                        for (let i = 1; i <= 8; i++) {
                                            colsXml += `<col min="${i}" max="${i}" width="20" customWidth="1"/>`;
                                        }
                                        colsXml += '</cols>';
                                        $('sheetPr', sheet).after(colsXml);
                                    }
                                }
                            }],
                            destroy: true,
                            paging: false,
                            searching: false,
                            info: false
                        });
                        // Trigger excel export
                        tempDt.button('.buttons-excel').trigger();
                        setTimeout(() => { try { btnApi.processing(false); } catch (err) { } }, 800);
                    }
                },
                // ==== CSV ====
                {
                    extend: 'csvHtml5',
                    text: '<i class="bi bi-filetype-csv text-success fs-5"></i>',
                    title: '',
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        },
                        columns: [1, 2, 3, 4, 5, 6, 7, 8],
                        modifier: { search: 'applied', order: 'applied' },
                        format: {
                            body: (function () {
                                let srCounter = 1;
                                return function (data, rowIdx, colIdx, node) {
                                    if (colIdx === 1) return srCounter++;
                                    return $('<div>').html(data).text().trim() || '';
                                };
                            })()
                        }
                    },
                    action: function (e, dt, button, config) {
                        const $rows = dt.rows().nodes().to$();
                        const selected = $rows.find('input.rowCheckbox:checked').length;
                        const btnApi = dt.button(button);

                        if (selected === 0) {
                            toastr.warning("Please select at least one row before exporting!");
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }
                        try { btnApi.processing(true); } catch (err) { }

                        if (!$.fn.dataTable.ext.buttons.csvHtml5._orig) {
                            $.fn.dataTable.ext.buttons.csvHtml5._orig = $.fn.dataTable.ext.buttons.csvHtml5.action;
                        }
                        const self = this;
                        const modifiedAction = function (e, dt, button, config) {
                            const originalDownload = $.fn.DataTable.fileSave;
                            $.fn.DataTable.fileSave = function (content, fileName, options) {
                                const result = originalDownload.call(this, content, fileName, options);
                                setTimeout(() => {
                                    try {
                                        btnApi.processing(false);
                                    } catch (err) {
                                        console.log('Spinner stopped');
                                    }
                                }, 500);

                                return result;
                            };

                            try {
                                $.fn.dataTable.ext.buttons.csvHtml5._orig.call(self, e, dt, button, config);
                            } catch (error) {
                                setTimeout(() => {
                                    try {
                                        btnApi.processing(false);
                                    } catch (err) { }
                                }, 500);
                                throw error;
                            } finally {
                                setTimeout(() => {
                                    $.fn.DataTable.fileSave = originalDownload;
                                }, 1000);
                            }
                        };
                        modifiedAction.call(this, e, dt, button, config);
                    }
                }
            ],
            rowCallback: function (row, data) {
            },
            drawCallback: function () {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.forEach(function (el) {
                    if (!bootstrap.Tooltip.getInstance(el)) {
                        new bootstrap.Tooltip(el);
                    }
                });
                // Update button state after table draw
                updateCreatePRButtonState();
            }
        });
        // update selectAll if user interacts with single row checkbox
        $('#itemsTable tbody').on('change', '.rowCheckbox', function () {
            var total = $('#itemsTable tbody .rowCheckbox').length;
            var checked = $('#itemsTable tbody .rowCheckbox:checked').length;
            $('#selectAll').prop('checked', total > 0 && total === checked);
        });
        // Select All functionality
        $('#selectAll').on('click', function () {
            var checked = this.checked;
            $('#itemsTable tbody').find('.rowCheckbox').prop('checked', checked);
            updateCreatePRButtonState();
        });

        // Update selectAll and Create PR button when individual checkboxes change
        $('#itemsTable tbody').on('change', '.rowCheckbox', function () {
            var total = $('#itemsTable tbody .rowCheckbox').length;
            var checked = $('#itemsTable tbody .rowCheckbox:checked').length;
            $('#selectAll').prop('checked', total > 0 && total === checked);
            updateCreatePRButtonState();
        });

        // Load Item Request Status
        $.getJSON('/Purchase/SelectItemReqStatusPSM', function (data) {
            const $ddl = $('#ItemReqStatus');
            $ddl.empty().append('<option value="">-- Select Status --</option>');
            $.each(data, function (i, item) {
                $ddl.append($('<option>', { value: item.Value, text: item.Text }));
            });
        });
        // DateRangePicker
        $('#FirstreportrangePSM').daterangepicker({
            autoUpdateInput: false,
            opens: "right",
            drops: "down",
            locale: {
                cancelLabel: 'Clear',
                format: 'DD/MM/YYYY' // display format
            },
            ranges: {
                'Today': [moment(), moment()],
                'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                'Last 1 Month': [moment().subtract(1, 'months').startOf('day'), moment()],
                'Last 3 Months': [moment().subtract(3, 'months').startOf('day'), moment()],
                'Last 1 Year': [moment().subtract(12, 'months').startOf('day'), moment()]
            }
        }, function (start, end) {
            // Show in dd/MM/yyyy format
            $('#FirstreportrangePSM').val(start.format('DD/MM/YYYY') + ' - ' + end.format('DD/MM/YYYY'));

            // Pass backend-friendly format (yyyy-MM-dd)
            dateFrom = start.format('YYYY-MM-DD');
            dateTo = end.format('YYYY-MM-DD');
            reloadItems();
        });

        $('#FirstreportrangePSM').on('cancel.daterangepicker', function () {
            $(this).val('');
            dateFrom = "";
            dateTo = "";
            reloadItems();
        });

        function reloadItems() {
            loadItems('/Purchase/GenerateStockRequirementPR', { from: dateFrom, to: dateTo });
        }

        function loadItems(url, params) {
            $.getJSON(url, params)
                .done(function (data) {
                    table.clear().rows.add(data).draw();
                })
                .fail(function () {
                    table.clear().draw();
                });
        }
        // Generate PR Code
        $.getJSON("/Purchase/GeneratePRCodePSM").done(function (res) {
            if (res) {
                if (res.success && res.prCode) $("#PRcode").val(res.prCode);
                else if (res.prCode) $("#PRcode").val(res.prCode);
            }
        });
        // Load Priority
        $.getJSON('/Purchase/PriorityPSM').done(function (data) {
            let ddl = $('#priority');
            ddl.empty().append('<option value="">-- Select Priority --</option>');
            $.each(data, (i, item) => ddl.append($('<option>').val(item.Value).text(item.Text)));

            // --- Auto-select priority based on PR Required Date ---
            let requiredDateStr = $('#ToDate').val(); // assuming #ToDate is your PR Required Date textbox
            if (requiredDateStr) {
                let requiredDate = new Date(requiredDateStr);
                let today = new Date();
                let diffDays = Math.ceil((requiredDate - today) / (1000 * 60 * 60 * 24));

                // Find value dynamically based on text
                let selectedText = '';
                if (diffDays <= 5) selectedText = 'Hot';
                else if (diffDays <= 10) selectedText = 'Warm';
                else if (diffDays > 15) selectedText = 'Cold';

                if (selectedText) {
                    // find the value that matches the text
                    let selectedItem = data.find(x => x.Text.toLowerCase() === selectedText.toLowerCase());
                    if (selectedItem) ddl.val(selectedItem.Value);
                }
            }
        }).fail(function () {
            $('#priority').empty().append('<option value="">-- No priorities --</option>');
        });
        $('#ToDate').on('change', function () {
            let ddl = $('#priority');
            let requiredDateStr = $(this).val();
            if (requiredDateStr) {
                let requiredDate = new Date(requiredDateStr);
                let today = new Date();
                let diffDays = Math.ceil((requiredDate - today) / (1000 * 60 * 60 * 24));
                let selectedText = '';

                if (diffDays <= 5) selectedText = 'Hot';
                else if (diffDays <= 10) selectedText = 'Warm';
                else if (diffDays > 15) selectedText = 'Cold';

                let selectedItem = ddl.find('option').filter(function () {
                    return $(this).text().toLowerCase() === selectedText.toLowerCase();
                });
                ddl.val(selectedItem.val());
            }
        });

        // Hide plan dropdown by default
        $('#planname').closest('.col-md-3').hide().find('input, select').addClass('text-success');

        // Handle Item Request Status change
        $('#ItemReqStatus').on('change', function () {
            const selected = $(this).val();
            const $plan = $('#planname');
            const $planContainer = $plan.closest('.col-md-3');

            // Clear table and reset
            clearTableWithMessage('Select an option to view items');

            if (selected === "13") { // 13 = MRP Items
                $planContainer.show();
                $plan.prop('disabled', false).removeClass('text-success');
                loadPlanDropdown();
                clearTableWithMessage('Please select a plan to view MRP items');
            }
            else if (selected === "8") {
                $planContainer.hide();
                $plan.prop('disabled', true).empty().addClass('text-success');
                reloadItems();
            }
            else {
                $planContainer.hide();
                $plan.prop('disabled', true).empty().addClass('text-success');
                clearTableWithMessage('Select an option to view items');
            }
        });

        $('#planname').on('change', function () {
            const planCode = $(this).val();
            const selectedStatus = $('#ItemReqStatus').val();

            if (!planCode) {
                clearTableWithMessage('Please select a plan to view MRP items');
                return;
            }

            if (selectedStatus === "13") {
                loadItems('/Purchase/MRPItemsListPSM', { planCode: planCode, from: dateFrom, to: dateTo });
            }
        });

        // Helper function to clear table with message
        function clearTableWithMessage(message) {
            if (table) {
                table.clear().draw();
                const tbody = $('#ItemReqtablePSM tbody');
                tbody.empty();
                tbody.append(`<tr><td colspan="12" class="text-center text-muted">${message}</td></tr>`);
            }
            updateCreatePRButtonState();
        }

        // Helper function to load plan dropdown
        function loadPlanDropdown() {
            const $plan = $('#planname');
            $plan.empty().append('<option value="">-- Loading Plans... --</option>');

            $.getJSON('/Purchase/SelectPlanNamesPSM')
                .done(function (data) {
                    $plan.empty().append('<option value="">-- Select Plan --</option>');
                    $.each(data, function (i, item) {
                        $plan.append($('<option>', { value: item.Value, text: item.Text }));
                    });
                })
                .fail(function () {
                    toastr.error("Failed to load plans!");
                    $plan.empty().append('<option value="">-- No Plans Found --</option>');
                });
        }

        // Add validation if no row selected - Do not open modal
        $('#btnCreatePR').on('click', function (e) {
            e.preventDefault();

            // Check if any rows are selected
            const selectedRows = $('.rowCheckbox:checked').length;

            if (selectedRows === 0) {
                toastr.warning("Please select at least one item to create PR!");
                return false;
            }

            // If rows are selected, proceed to build modal content
            prItems = [];
            var modalTableBody = $('#modalTableBody');
            modalTableBody.empty();

            var earliestRequiredDate = null;
            var srNo = 1;

            table.rows().every(function (rowIdx, tableLoop, rowLoop) {
                var node = this.node();
                if ($(node).find('.rowCheckbox').is(':checked')) {
                    var rowData = this.data();
                    if (!rowData) return;
                    prItems.push(rowData);

                    var rd = rowData.RequiredDate ? new Date(rowData.RequiredDate) : null;
                    if (rd && !isNaN(rd.getTime())) {
                        if (earliestRequiredDate === null || rd < earliestRequiredDate) earliestRequiredDate = rd;
                    }

                    var newRow = `<tr>
                        <td class="text-center">${srNo++}</td>
                        <td>${rowData.ItemCode || ''}</td>
                        <td>${rowData.ItemName || ''}</td>
                        <td>${rowData.Description || ''}</td>
                        <td>${rowData.UOMName || ''}</td>
                        <td>₹ ${rowData.UnitRates || ''}</td>
                        <td class="text-end">${rowData.Quantity || ''}</td>
                        <td class="text-center">
                        ${rowData.RequiredDate ? new Date(rowData.RequiredDate).toLocaleDateString('en-GB') : ''}
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-danger square-pill square-btn btn-delete fs-5 btn-delete" data-itemcode="${rowData.ItemCode}">
                                <i class="bi bi-trash fs-5"></i>
                            </button>
                        </td>
                    </tr>`;
                    modalTableBody.append(newRow);
                }
            });

            // Set the date field
            var minDateStr = earliestRequiredDate ? earliestRequiredDate.toISOString().split('T')[0] : '';
            $('#ToDate').val(minDateStr);
            if (minDateStr) {
                $('#ToDate').attr('max', minDateStr);
            } else {
                $('#ToDate').removeAttr('max');
            }

            // Only open modal after validation passes
            $('#createPRModal').modal('show');
        });
        // Submit PR
        $("#prForm").submit(function (e) {
            e.preventDefault();
            // Validation
            if (!$("#PRcode").val()) {
                Swal.fire("Error", "PR Code is missing.", "error");
                return;
            }
            if (!$("#ToDate").val()) {
                Swal.fire("Error", "Please select PR Required Date.", "error");
                return;
            }
            if (!$("#priority").val()) {
                Swal.fire("Error", "Please select a Priority.", "error");
                return;
            }
            if (!prItems || prItems.length === 0) {
                Swal.fire("Error", "Please add at least one item.", "error");
                return;
            }
            var prDateVal = $("#ToDate").val();
            var prRequiredDate = new Date(prDateVal);
            if (isNaN(prRequiredDate.getTime())) {
                Swal.fire("Error", "Invalid PR Required Date.", "error");
                return;
            }

            var earliestRequiredDate = null;
            prItems.forEach(function (item) {
                var rd = item.RequiredDate ? new Date(item.RequiredDate) : null;
                if (rd && !isNaN(rd.getTime())) {
                    if (earliestRequiredDate === null || rd < earliestRequiredDate) earliestRequiredDate = rd;
                }
            });

            if (earliestRequiredDate && prRequiredDate < earliestRequiredDate) {
                Swal.fire("Error", "PR Required Date cannot be earlier than the earliest required date of the selected items (" + earliestRequiredDate.toISOString().split('T')[0] + ").", "error");
                return;
            }

            var token = $('input[name="__RequestVerificationToken"]').val();
            let payload = {
                PRCode: $("#PRcode").val(),
                RequiredDate: $("#ToDate").val(),
                PriorityId: $("#priority").val(),
                Description: $("#Description").val(),
                Items: prItems.map(function (item) {
                    return {
                        PRCode: $("#PRcode").val(),
                        ItemCode: item.ItemCode,
                        RequiredQuantity: item.Quantity
                    };
                })
            };

            $.ajax({
                url: '/Purchase/CreatePRADDItemPSM',
                type: 'POST',
                data: JSON.stringify(payload),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                headers: { '__RequestVerificationToken': token },
                success: function (res) {
                    if (res && res.success) {
                        // Remove selected items from DataTable
                        removeSelectedItemsFromTable();

                        Swal.fire({
                            icon: "success",
                            title: res.message || "PR saved successfully",
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                            didClose: () => {
                                // Close modal and refresh UI
                                $('#createPRModal').modal('hide');
                                $('#modalTableBody').empty();
                                prItems = [];
                                updateCreatePRButtonState();
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: (res && res.message) || "Failed to save PR",
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        icon: "error",
                        title: "Server error occurred. Please try again.",
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });
                }
            });
        });

        // Function to remove selected items from DataTable
        function removeSelectedItemsFromTable() {
            // Get all checked rows
            var checkedRows = [];

            table.rows().every(function (rowIdx, tableLoop, rowLoop) {
                var node = this.node();
                if ($(node).find('.rowCheckbox').is(':checked')) {
                    checkedRows.push(this);
                }
            });
            checkedRows.forEach(function (row) {
                row.remove();
            });
            table.draw();
            $('#selectAll').prop('checked', false);
        }
        // Delete in modal
        $('#modalTableBody').on('click', '.btn-delete', function () {
            let itemCode = $(this).data('itemcode');
            let row = $(this).closest('tr');
            Swal.fire({
                title: "Are you sure?",
                text: "Do you really want to delete this item?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText: "Yes, delete it!",
                cancelButtonText: "Cancel"
            }).then((result) => {
                if (result.isConfirmed) {
                    prItems = prItems.filter(function (x) { return x.ItemCode !== itemCode; });
                    row.remove();
                    Swal.fire("Deleted!", "The item has been removed.", "success");
                    $('#modalTableBody tr').each(function (index) {
                        $(this).find('td:first').text(index + 1);
                    });
                }
            });
        });
        // Cancel main - uncheck all checkboxes in table body (visible)
        $('#btnCancel').on('click', function () {
            $('#itemsTable tbody .rowCheckbox').prop('checked', false);
            $('#selectAll').prop('checked', false);
        });
        // Reset modal - clear modal content and close modal
        $('#prResetBtn').on('click', function () {
            $('#modalTableBody').empty();
            prItems = [];
            $('#createPRModal').modal('hide');
        });
        reloadItems();
    });
</script>
