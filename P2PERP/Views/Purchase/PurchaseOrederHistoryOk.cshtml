@{
    ViewBag.Title = "Purchase Oreder History";
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
  
    <style>
        .dt-paging nav {
            display: flex;
            justify-content: end;
            margin-right: 20px;
        }
        /*.daterangepicker-container {
            border: 1px solid #ccc !important;
            border-radius: 6px;
            overflow: hidden;*/ /* ensures the border applies cleanly around input-group */
            /*background-color: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

            .daterangepicker-container .form-control:focus {
                box-shadow: none;
            }

            .daterangepicker-container .input-group-text {
                background-color: #7357ff !important;*/ /* match your theme */
                /*color: #fff !important;
            }

        #Purchasedatepicker {
            cursor: pointer;
        }


        #exportContainer .dt-buttons {
            display: flex;
            justify-content: end;*/ /* center align */
            /*gap: 8px;
        }*/
        .table-container {
            overflow-x: auto; /* enable horizontal scroll if needed */
            width: 100%; /* force to parent container width */
        }

        #tblPOHistory {
            width: 100% !important; /* force table to stay inside container */
            table-layout: auto; /* let columns adjust naturally */
        }

        #tblPOHistory th div {
            white-space: nowrap; /* Prevent line break */
            overflow: hidden; /* Hide extra text */
            text-overflow: ellipsis; /* Add "..." if too long */
        }

        #tblPOHistory th {
            vertical-align: middle; /* Align text center vertically */
            text-align: center; /* Align text center horizontally */
            padding: 10px 12px; /* Adjust spacing */
        }
        #searchContainer
        {
           margin-top:70px!important;
        }
        /* Common container style for both */
        .expbtndate .input-group {
            width: 230px !important; /* or match your preferred width */
            min-width: 230px;
        }
        .dt-search {
            margin-bottom: 20px;
            display: inline;
            display: flex;
            justify-content: flex-end;
        }

            .dt-search label {
                margin-top: 10px;
            }
        #exportContainer .dt-buttons {
            display: flex;
            gap: 8px;
            /*            margin: 0;*/
            margin-bottom: -40px;
            z-index: 2;
        }

    </style>
</head>
<body>
    <!-- Toast container somewhere fixed, e.g. top right -->
    <div id="toastContainer"
         class="toast-container position-fixed top-0 end-0 p-3"
         style="z-index: 2000;">
    </div>

    <div class="container-fluid px-4 mt-3">
        <div class="card shadow-lg ps-3 m-0 pe-3">
            <h3 class="text-primary d-flex justify-content-center align-content-center m-0">
                Purchase Order History
            </h3>

            <!--<div class="d-flex justify-content-between align-items-start mb-5 flex-wrap">
        <div class="d-flex flex-column gap-3 expbtndate">-->
            <!-- Date Range Picker -->
            <!--<div class="daterangepicker-container input-group">
            <span class="input-group-text bg-primary text-white border-0 rounded-start">
                <i class="bi bi-calendar-date"></i>
            </span>
            <input type="text"
                   id="Purchasedatepicker"
                   class="form-control border-0"
                   placeholder="Select date range"
                   readonly />
        </div>-->
            <!-- Export Buttons -->
            <!--<div id="exportContainer" class="d-flex align-items-center gap-2"></div>
        </div>-->
            <!-- Right side -->
            <!--<div id="searchContainer"></div>
        </div>-->
            <div class="tab-content p-0 ps-1 pe-1 mt-0" id="approval">

                <!-- ✅ Toolbar -->
                <div class="table-toolbar d-flex justify-content-between align-items-center flex-wrap mb-2 mt-4 px-3 pe-0">

                    <!-- ✅ Left Section: Date Picker + Export Buttons -->
                    <div class="row d-flex align-items-center flex-wrap gap-3 p-0 pe-0">

                        <div class="d-flex justify-content-between align-items-center flex-wrap ps-0 mb-3">
                            <!-- ✅ Date Picker Column -->
                            <div class="col-6 p-0">
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white">
                                        <i class="bi bi-calendar-event"></i>
                                    </span>
                                    <input type="text" id="Purchasedatepicker" class="form-control" placeholder="Select Date Range" readonly />
                                </div>
                            </div>
                            <!-- ✅ Status Filter (Right) -->
                            @*<div class="d-flex align-items-center pe-0 ms-12 ps-7">*@
                            <div class="d-none align-items-center pe-0 ms-12 ps-7">
                                <label for="statusFilter" class="form-label fw-bold me-2 mb-0 ps-8">Filter by Status</label>
                                <select id="statusFilter" class="form-select ps-8 pe-0" style="width: 180px;">
                                    <option value="">All</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Open">Open</option>
                                    <option value="Approve">Approve</option>
                                    <option value="Reject">Reject</option>
                                    <option value="Close">Close</option>
                                </select>
                            </div>
                        </div>

                        <!-- ✅ Export Buttons -->
                        <div id="exportContainer" class="d-flex align-items-center gap-2 ps-0"></div>
                    </div>

                    <!-- ✅ Right Section: Search Box -->
                    @*<div id="searchContainer" class="d-flex align-items-center mb-4"></div>*@
                </div>
            </div>


            <!-- Table -->
            <div class="table-container pb-4">
                <table class="table table-striped table-bordered text-center align-middle" id="tblPOHistory">
                    <thead class="table-dark text-center align-middle">
                        <tr>
                            <th>
                                <div class="d-flex align-items-center justify-content-center">
                                    <input type="checkbox" id="selectAll" class="me-1">
                                </div>
                            </th>
                            <th><div>SRNO</div></th>
                            <th><div>PONO</div></th>
                            <th><div>Added Date</div></th>
                            <th><div>Vendor Name</div></th>
                            <th><div>Company Name</div></th>
                            <th><div>Total Amount</div></th>
                            <th><div>State Name</div></th>
                            <th><div>Action</div></th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>

        <!-- Rejected PO Details Modal -->
        <div class="modal fade" id="rejectedPOModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content shadow-lg rounded-3">

                    <!-- Header -->
                    <div class="modal-header bg-primary text-white d-flex justify-content-center align-items-center rounded-top p-2">
                        <h5 class="modal-title text-white fw-bold mb-0 fs-5">Rejected Purchase Order Details</h5>
                        <button type="button" class="btn-close btn-close-white position-absolute end-0 me-2"
                                data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <!-- Body -->
                    <div class="modal-body">
                        <form class="row g-3">

                            <!-- PO Details -->
                            <h6 class="fw-bold text-primary mt-2">Purchase Order Details</h6>
                            <div class="col-md-4">
                                <label class="form-label form-label-sm fw-bold text-dark">PO Code</label>
                                <input type="text" id="poCode" class="form-control form-control-sm shadow-sm" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label form-label-sm fw-bold text-dark">Added Date</label>
                                <input type="text" id="poAddedDate" class="form-control form-control-sm shadow-sm" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label form-label-sm fw-bold text-dark">Shipping Charges</label>
                                <input type="text" id="shippingCharges" class="form-control form-control-sm shadow-sm" readonly>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label form-label-sm fw-bold text-dark">Rejected By</label>
                                <input type="text" id="rejectedByName" class="form-control form-control-sm shadow-sm" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label form-label-sm fw-bold text-dark">Rejected Date</label>
                                <input type="text" id="rejectedDate" class="form-control form-control-sm shadow-sm" readonly>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label form-label-sm fw-bold text-dark">Rejection Note</label>
                                <textarea id="rejectedNote" class="form-control form-control-sm shadow-sm" rows="2" readonly></textarea>
                            </div>

                            <hr class="mt-3">

                            <!-- Vendor Details -->
                            <h6 class="fw-bold text-primary mt-2">Vendor Details</h6>
                            <div class="col-md-4">
                                <label class="form-label form-label-sm fw-bold text-dark">Vendor Name</label>
                                <input type="text" id="vendorName" class="form-control form-control-sm shadow-sm" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label form-label-sm fw-bold text-dark">Vendor Address</label>
                                <input type="text" id="vendorAddress" class="form-control form-control-sm shadow-sm" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label form-label-sm fw-bold text-dark">Vendor Phone</label>
                                <input type="text" id="vendorPhone" class="form-control form-control-sm shadow-sm" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label form-label-sm fw-bold text-dark">Vendor Email</label>
                                <input type="text" id="vendorEmail" class="form-control form-control-sm shadow-sm" readonly>
                            </div>
                            <hr class="mt-3">

                            <!-- Company Details (remove divthen show correct) -->
                            <div class="d-none">
                                <h6 class="fw-bold text-primary mt-2">Company Details</h6>
                                <div class="col-md-4">
                                    <label class="form-label form-label-sm fw-bold text-dark">Company Name</label>
                                    <input type="text" id="companyName" class="form-control form-control-sm shadow-sm" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label form-label-sm fw-bold text-dark">Address</label>
                                    <input type="text" id="companyAddress" class="form-control form-control-sm shadow-sm" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label form-label-sm fw-bold text-dark">Phone</label>
                                    <input type="text" id="companyPhone" class="form-control form-control-sm shadow-sm" readonly>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label form-label-sm fw-bold text-dark">Email</label>
                                    <input type="text" id="companyEmail" class="form-control form-control-sm shadow-sm" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label form-label-sm fw-bold text-dark">Website</label>
                                    <input type="text" id="companyWebsite" class="form-control form-control-sm shadow-sm" readonly>
                                </div>
                            </div>



                            <!-- Warehouse Details -->
                            <h6 class="fw-bold text-primary mt-2">Ship To (Warehouse)</h6>
                            <div class="col-md-4">
                                <label class="form-label form-label-sm fw-bold text-dark">Warehouse Name</label>
                                <input type="text" id="warehouseName" class="form-control form-control-sm shadow-sm" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label form-label-sm fw-bold text-dark">Warehouse Address</label>
                                <input type="text" id="warehouseAddress" class="form-control form-control-sm shadow-sm" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label form-label-sm fw-bold text-dark">Warehouse Phone</label>
                                <input type="text" id="warehousePhone" class="form-control form-control-sm shadow-sm" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label form-label-sm fw-bold text-dark">Warehouse Email</label>
                                <input type="text" id="warehouseEmail" class="form-control form-control-sm shadow-sm" readonly>
                            </div>
                        </form>
                        <hr class="mt-3">
                        <!-- Rejected PO Items Table -->
                        <div class="table-container  mt-4">
                            <table class="table table-striped table-bordered text-center align-middle erp-table" id="tblRejectedPOItems">
                                <thead class="table-dark text-center align-middle">
                                    <tr>
                                        <th>SRNO</th>
                                        <th>Item Code</th>
                                        <th>Item Name</th>
                                        <th>Description</th>
                                        <th>Quantity</th>
                                        <th>UOM</th>
                                        <th>Cost/Unit</th>
                                        <th>Discount</th>
                                        <th>GST</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="9" class="text-end">Sub Total</td>
                                        <td id="subAmount" class="text-center"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="9" class="text-end">Shipping Charges</td>
                                        <td id="shippingTotal" class="text-center"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="9" class="text-end fw-bold">Grand Total</td>
                                        <td id="grandTotal" class="text-center fw-bold"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                    </div>

                    <!-- Footer -->
                    <div class="modal-footer py-2 d-flex justify-content-end">
                        <button type="button" class="btn btn-sm btn-danger btn-sm px-3" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i> Close
                        </button>
                    </div>

                </div>
            </div>
        </div>

    </div>
        <script>
        $(document).ready(function () {
            // Reusable PDF/Print customization function
            function customizeDoc(doc) {
                // Title Styling
                doc.styles.title = {
                    color: '#000000',
                    fontSize: 16,
                    bold: true,
                    alignment: 'center'
                };

                // ✅ Generate date in dd/mm/yyyy format
                var now = new Date();
                var day = String(now.getDate()).padStart(2, '0');
                var month = String(now.getMonth() + 1).padStart(2, '0');
                var year = now.getFullYear();
                var formattedDate = day + '/' + month + '/' + year;

                // ✅ Insert generated date
                doc.content.splice(1, 0, {
                    text: 'Generated Date: ' + formattedDate,
                    fontSize: 10,
                    italics: true,
                    alignment: 'center',
                    margin: [0, 0, 0, 12]
                });

                // Table Header Styling
                doc.styles.tableHeader = {
                    fillColor: '#000000',
                    color: 'white',
                    bold: true,
                    fontSize: 11,
                    alignment: 'center'
                };

                // Table Border + Padding
                var objLayout = {};
                objLayout['hLineWidth'] = function () { return .5; };
                objLayout['vLineWidth'] = function () { return .5; };
                objLayout['hLineColor'] = function () { return '#aaa'; };
                objLayout['vLineColor'] = function () { return '#aaa'; };
                objLayout['paddingLeft'] = function () { return 6; };
                objLayout['paddingRight'] = function () { return 6; };

                // Get the table
                var tableNode = doc.content[doc.content.length - 1];
                tableNode.layout = objLayout;

                // Set fixed widths for all columns
                var colCount = tableNode.table.body[0].length;
                tableNode.table.widths = Array(colCount).fill('*');

                // Wrap in margin to simulate center alignment
                tableNode.alignment = 'center';
                tableNode.margin = [0, 0, 0, 0];
            }


            // Clear processing state for all DataTable buttons
            window.__dt_clearAllProcessing = function () {
                try {
                    // Try to clear via DataTables API
                    var tables = $.fn.dataTable.tables();
                    for (var i = 0; i < tables.length; i++) {
                        try {
                            var api = $(tables[i]).DataTable();
                            if (!api || !api.buttons) continue;
                            var btnCount = (api.buttons().nodes && api.buttons().nodes().length) || 0;
                            for (var j = 0; j < btnCount; j++) {
                                try { api.button(j).processing(false); } catch (e) { }
                            }
                        } catch (e) { }
                    }
                } catch (e) { }

                // Fallback DOM cleanup
                try {
                    $('.dt-button').removeClass('dt-button-processing');
                    $('.dt-button').prop('disabled', false);
                } catch (e) { }
            };

            // Listen for print-done message from print window
            window.addEventListener('message', function (ev) {
                if (ev && ev.data === 'dt_print_done') {
                    window.__dt_clearAllProcessing();
                }
            });

            // Store original button actions if not already stored
            if (!$.fn.dataTable.ext.buttons.pdfHtml5.__originalAction) {
                $.fn.dataTable.ext.buttons.pdfHtml5.__originalAction =
                    $.fn.dataTable.ext.buttons.pdfHtml5.action;
            }
            if (!$.fn.dataTable.ext.buttons.print.__originalAction) {
                $.fn.dataTable.ext.buttons.print.__originalAction =
                    $.fn.dataTable.ext.buttons.print.action;
            }
            if (!$.fn.dataTable.ext.buttons.excelHtml5.__originalAction) {
                $.fn.dataTable.ext.buttons.excelHtml5.__originalAction =
                    $.fn.dataTable.ext.buttons.excelHtml5.action;
            }
            if (!$.fn.dataTable.ext.buttons.csvHtml5.__originalAction) {
                $.fn.dataTable.ext.buttons.csvHtml5.__originalAction =
                    $.fn.dataTable.ext.buttons.csvHtml5.action;
            }

            // Toast notification function
            // ✅ Configure toastr once
            toastr.options = {
                closeButton: true,
                progressBar: true,
                newestOnTop: true,
                positionClass: "toast-top-right",
                preventDuplicates: true,
                timeOut: 3000,
                extendedTimeOut: 1000,
                showDuration: 300,
                hideDuration: 300,
                showMethod: "slideDown",
                hideMethod: "fadeOut"
            };

            // ✅ Helper function for warning toast
            function showExportToast() {
                toastr.warning("Please select at least one row before exporting.");
            }

        // Initialize Purchase Order History DataTable
        var tblPOHistory = $("#tblPOHistory").DataTable({
            ajax: {
                url: '@Url.Action("FetchPOHistoryOK", "Purchase")',
                type: "GET",
                dataSrc: "data"
            },
            columns: [
                {
                    data: null,
                    orderable: false,
                    className: "dt-body-center",
                    render: function (data, type, row) {
                        return `<input type="checkbox" class="row-select" value="${row.QuotationID}">`;
                    }
                },
                { data: "SRNO", title: "Sr.No", className:"text-center"},
                { data: "POCode", title: "PO NO" },
                {
                    data: "AddedDateString", title: "Added Date",
                    "render": function (data) {
                        if (!data) return "";
                        var match = /Date\((\d+)\)/.exec(data);
                        if (match) {
                            var dt = new Date(parseInt(match[1], 10));
                            return dt.toLocaleDateString("en-GB");
                        }
                        var dt2 = new Date(data);
                        if (!isNaN(dt2.getTime())) {
                            return dt2.toLocaleDateString("en-GB");
                        }

                        return data;
                    }
                },
                { data: "VendorName", title: "Vendor Name" },
                { data: "CompanyName", title: "Company Name" },
                {
                    data: "TotalAmount",
                    title: "Total Amount",
                    render: function (data, type, row) {
                        return "₹ " + data;
                    }
                },
                //{ data: "StateName", title: "Status Name"},
                {
                    data: "StateName",
                    title: "Status",
                    render: function (data) {
                        if (!data) return "";
                        let colorClass = "";
                        switch (data.toLowerCase()) {
                            case "pending": colorClass = "bg-warning text-dark text-white"; break;
                            case "open": colorClass = "bg-info text-dark text-white"; break;
                            case "approve": colorClass = "bg-success text-dark text-white"; break;
                            case "rejected": colorClass = "bg-danger text-dark text-white"; break;
                            case "close": colorClass = "bg-danger text-dark text-white"; break;
                        }
                        return `<span class="badge ${colorClass}">${data}</span>`;
                    }
                },
                {
                    data: null,
                    render: function (data, type, row) {
                        return `
                        <button type="button" 
                                class="btn btn-primary btn-view square-pill d-inline-flex align-items-center px-2 py-1"
                                data-row='${JSON.stringify(row)}'
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="View PO">
                            <i class="bi bi-eye-fill fs-6"></i>
                        </button>`;
                    }
                }

            ],
            paging: true,
            searching: true,
            lengthChange: false,
            pageLength: 10,
            ordering: false ,
            select: {
                style: 'multi',
                selector: 'td:first-child input[type="checkbox"]'
            },
            dom: 'Bfrtip',
            buttons: [
                // Print button
                {
                    extend: 'print',
                    text: '<i class="bi bi-printer-fill text-dark fs-5"></i>',
                    titleAttr: 'Print',
                    title: 'Purchase Order History List',
                    exportOptions: {
                        columns: [1, 2, 3, 4, 5, 6],
                        rows: function (idx, data, node) {
                            return $(tblPOHistory.row(idx).node()).find('input.row-select').prop('checked');
                        },
                        format: {
                            body: function (data, rowIdx, colIdx, node) {
                                if (colIdx === 1) return getExportSrNo(rowIdx, tblPOHistory);
                                return data;
                            }
                        }
                    },
                    customize: function (win) {
                        var $body = $(win.document.body);

                        // Inject custom CSS for print
                        $body.append(`
                            <style>
                                thead th {
                                    background-color: black !important;
                                    color: white !important;
                                    text-align: center !important;
                                    -webkit-print-color-adjust: exact !important;
                                    print-color-adjust: exact !important;
                                }
                                table {
                                    border-collapse: collapse !important;
                                    width: 100% !important;
                                }
                                td, th {
                                    border: 1px solid #000 !important;
                                    padding: 6px !important;
                                }
                            </style>
                        `);

                        // Center title
                        $body.find('h1').css('text-align', 'center');

                        // Insert generated date in dd/mm/yyyy format
                        $body.find('h1').after(
                            '<div style="text-align:center;font-style:italic;font-size:10pt;margin-bottom:12px;">Generated Date: ' +
                            (function () {
                                const d = new Date();
                                const day = String(d.getDate()).padStart(2, '0');
                                const month = String(d.getMonth() + 1).padStart(2, '0');
                                const year = d.getFullYear();
                                return `${day}/${month}/${year}`;
                            })() +
                            '</div>'
                        );


                        // Add bootstrap table styles
                        $body.find('table')
                            .addClass('table table-bordered table-striped')
                            .css('width', '100%');

                        // Font size
                        $body.css('font-size', '12pt');
                    },
                    action: function (e, dt, button, config) {
                        var selected = dt.rows().nodes().to$().find('input.row-select:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        // Show spinner
                        try { btnApi.processing(true); } catch (err) { }

                        // Call original print action
                        try {
                            $.fn.dataTable.ext.buttons.print.__originalAction.call(this, e, dt, button, config);
                        } catch (err) {
                            // Ensure spinner not left running
                            setTimeout(function () { try { btnApi.processing(false); } catch (e) { } }, 300);
                            throw err;
                        }

                        // Final fallback: if print window never reports, clear after 2s
                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 2000);
                    }
                },
                // PDF Export button
                {
                    extend: 'pdfHtml5',
                    text: '<i class="bi bi-file-earmark-pdf text-danger fs-5"></i>',
                    titleAttr: 'PDF',
                    title: 'Purchase Order History List',
                    orientation: 'landscape',
                    pageSize: 'A4',
                    exportOptions: {
                        columns: [1, 2, 3, 4, 5, 6],
                        rows: function (idx, data, node) {
                            return $(tblPOHistory.row(idx).node()).find('input.row-select').prop('checked');
                        },
                        format: {
                            body: function (data, rowIdx, colIdx, node) {
                                if (colIdx === 1) return getExportSrNo(rowIdx, tblPOHistory);
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        var selected = dt.rows().nodes().to$().find('input.row-select:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            btnApi.processing(false);
                            return;
                        }

                        btnApi.processing(true);

                        // If pdfMake exists, wrap its download so we can stop spinner when done
                        if (window.pdfMake && pdfMake.createPdf && !pdfMake._patchedForDT) {
                            (function () {
                                var origCreate = pdfMake.createPdf;
                                pdfMake.createPdf = function (docDefinition) {
                                    var pdfDoc = origCreate.call(pdfMake, docDefinition);
                                    var origDownload = pdfDoc.download;
                                    pdfDoc.download = function (filename, cb) {
                                        origDownload.call(pdfDoc, filename, function () {
                                            try { btnApi.processing(false); } catch (err) { }
                                            if (typeof cb === 'function') cb();
                                        });
                                    };
                                    return pdfDoc;
                                };
                                pdfMake._patchedForDT = true; // only patch once
                            })();
                        }

                        // Call original action
                        $.fn.dataTable.ext.buttons.pdfHtml5.__originalAction.call(this, e, dt, button, config);

                        // Final fallback: clear after timeout just in case
                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 1500);
                    },
                    customize: customizeDoc
                },
                // Excel Export button
                {
                    extend: 'excelHtml5',
                    text: '<i class="bi bi-file-earmark-excel text-success fs-5"></i>',
                    titleAttr: 'Excel',
                    title: '',//Purchase Order History List
                    exportOptions: {
                        columns: [1, 2, 3, 4, 5, 6],
                        rows: function (idx, data, node) {
                            return $(tblPOHistory.row(idx).node()).find('input.row-select').prop('checked');
                        },
                        format: {
                            body: function (data, rowIdx, colIdx, node) {
                                if (colIdx === 1) return getExportSrNo(rowIdx, tblPOHistory);
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        var selected = dt.rows().nodes().to$().find('input.row-select:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(true); } catch (err) { }

                        // Call original excelHtml5 action
                        $.fn.dataTable.ext.buttons.excelHtml5.__originalAction.call(this, e, dt, button, config);

                        // Fallback clear spinner after short delay
                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 300);
                    },
                    customize: function (xlsx) {
                        // ✅ Rename worksheet
                        var sheet = xlsx.xl.worksheets['sheet1.xml'];
                        $('sheet', xlsx.xl['workbook.xml']).attr('name', 'PO_History');

                        // ✅ Date in dd/mm/yyyy format
                        var now = new Date();
                        var day = String(now.getDate()).padStart(2, '0');
                        var month = String(now.getMonth() + 1).padStart(2, '0');
                        var year = now.getFullYear();
                        var formattedDate = day + '/' + month + '/' + year;

                        var sheetData = $('sheetData', sheet);

                        // Shift all data rows down by 2 (for title + date)
                        sheetData.find('row').each(function () {
                            var r = parseInt($(this).attr('r'));
                            $(this).attr('r', r + 2);
                            $(this).find('c').each(function () {
                                var cellRef = $(this).attr('r');
                                var col = cellRef.replace(/[0-9]/g, '');
                                $(this).attr('r', col + (r + 2));
                            });
                        });

                        // ✅ Insert Title row (now in A1, will be merged A1:G1 for centering across 7 columns)
                        var titleRow =
                            '<row r="1">' +
                            '<c t="inlineStr" r="A1">' +
                            '<is><t>Purchase Order History List</t></is>' +
                            '</c>' +
                            '</row>';

                        // ✅ Insert Generated Date row (now in A2, will be merged A2:G2 for centering)
                        var dateRow =
                            '<row r="2">' +
                            '<c t="inlineStr" r="A2">' +
                            '<is><t>Generated Date: ' + formattedDate + '</t></is>' +
                            '</c>' +
                            '</row>';

                        // Add rows to the top
                        sheetData.prepend(dateRow);
                        sheetData.prepend(titleRow);

                        // ✅ Add merge cells for centering title and date across columns A:G (7 columns from export)
                        var mergeCells = $('mergeCells', sheet);
                        if (mergeCells.length === 0) {
                            // If no mergeCells exist, create the element
                            $('worksheet', sheet).append('<mergeCells count="2"/>');
                            mergeCells = $('mergeCells', sheet);
                        } else {
                            // Update existing count
                            var currentCount = parseInt(mergeCells.attr('count') || 0);
                            mergeCells.attr('count', currentCount + 2);
                        }
                        // Add title merge (A1:G1)
                        mergeCells.append('<mergeCell ref="A1:G1"/>');
                        // Add date merge (A2:G2)
                        mergeCells.append('<mergeCell ref="A2:G2"/>');

                        // ✅ Add styles for centering + font (fonts, fills, etc.)
                        var styles = xlsx.xl['styles.xml'];
                        var cellXfs = $('cellXfs', styles);
                        var fonts = $('fonts', styles);

                        // Count existing fonts (default is usually 1: fontId=0)
                        var fontCount = $('font', fonts).length;

                        // Add new font for title (bold, size 14)
                        fonts.append(
                            '<font>' +
                            '<sz val="14"/>' +  // Font size 14
                            '<b/>' +             // Bold
                            '<color rgb="000000"/>' +  // Black (default)
                            '</font>'
                        );

                        // Add new font for date (italic, size 11)
                        fonts.append(
                            '<font>' +
                            '<sz val="11"/>' +   // Font size 11 (default size)
                            '<i/>' +             // Italic
                            '<color rgb="000000"/>' +  // Black (default)
                            '</font>'
                        );

                        // Count existing cellXfs
                        var styleCount = $('xf', cellXfs).length;

                        // Add new style for title (use new bold/large font, center alignment)
                        cellXfs.append(
                            '<xf numFmtId="0" fontId="' + fontCount + '" fillId="0" borderId="0" xfId="0" applyFont="1" applyAlignment="1">' +
                            '<alignment horizontal="center" vertical="center" wrapText="1"/>' +  // Center, wrap for long text
                            '</xf>'
                        );

                        // Add new style for date (use new italic font, center alignment)
                        cellXfs.append(
                            '<xf numFmtId="0" fontId="' + (fontCount + 1) + '" fillId="0" borderId="0" xfId="0" applyFont="1" applyAlignment="1">' +
                            '<alignment horizontal="center" vertical="center" wrapText="1"/>' +  // Center, wrap for long text
                            '</xf>'
                        );

                        // Apply new style indexes to the cells
                        $('c[r=A1]', sheet).attr('s', styleCount);       // Title style
                        $('c[r=A2]', sheet).attr('s', styleCount + 1);   // Date style
                    }
                },

                // CSV Export button
                {
                    extend: 'csvHtml5',
                    text: '<i class="bi bi-filetype-csv text-success fs-5"></i>',
                    titleAttr: 'CSV',
                    title: 'Purchase Order History List',
                    exportOptions: {
                        columns: [1, 2, 3, 4, 5, 6],
                        rows: function (idx, data, node) {
                            return $(tblPOHistory.row(idx).node()).find('input.row-select').prop('checked');
                        },
                        format: {
                            body: function (data, rowIdx, colIdx, node) {
                                if (colIdx === 1) return getExportSrNo(rowIdx, tblPOHistory);
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        var selected = dt.rows().nodes().to$().find('input.row-select:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(false); } catch (err) { }

                        $.fn.dataTable.ext.buttons.csvHtml5.__originalAction.call(this, e, dt, button, config);

                        // Stop spinner almost immediately (no real callback exists)
                        setTimeout(function () {
                            try { btnApi.processing(false); } catch (err) { }
                        }, 300);
                    }
                }
            ],
            // Recalculate Sr.No on every draw
            drawCallback: function (settings) {
                var api = this.api();
                api.column(1, { page: 'current' }).nodes().each(function (cell, i) {
                    cell.innerHTML = i + 1 + settings._iDisplayStart;
                });
                initTooltips();
            }
        });

        // Initialize Bootstrap tooltips
        function initTooltips() {
            const tooltipTriggerList = [].slice.call(
                document.querySelectorAll('[data-bs-toggle="tooltip"]')
            );
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl, {
                    customClass: 'tooltip-dark'
                });
            });
        }

        // Move DataTables buttons to the left container
        tblPOHistory.buttons().container().appendTo('#exportContainer');

        // Move default DataTables search input to the right container
        $('.dt-search label').appendTo('#searchContainer');
        $('.dt-search input[type="search"]').appendTo('#searchContainer');

        // Function to get selected rows
        function getSelectedRows() {
            var selected = [];
            tblPOHistory.$('input.row-select:checked').each(function () {
                var rowIndex = tblPOHistory.row($(this).closest('tr')).index();
                selected.push(rowIndex);
            });
            return selected;
        }

        // Handle Select All checkbox
        $(document).on('change', '#selectAll', function () {
            var isChecked = $(this).is(':checked');
            $('.row-select').prop('checked', isChecked);
        });

        // If any row unchecked → uncheck header checkbox
        $(document).on('change', '.row-select', function () {
            if ($('.row-select:checked').length === $('.row-select').length) {
                $('#selectAll').prop('checked', true);
            } else {
                $('#selectAll').prop('checked', false);
            }
        });

        // View PO button click handler
        $(document).on("click", ".btn-view", function () {
            let row = $(this).data("row");
            console.log("PO deatils: ", row);
            // Open PDF in new tab
            window.open('/Purchase/GeneratePOPDF?POCode=' + row.POCode, '_blank');
        });

            // Date Picker initialization
            $('#Purchasedatepicker').daterangepicker({
                autoUpdateInput: false,
                opens: "center",
                drops: "down",
                locale: {
                    cancelLabel: 'Clear',
                    format: 'DD/MM/YYYY' // display format
                },
                ranges: {
                    'Today': [moment(), moment()],
                    //'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 1 Month': [moment().subtract(1, 'months').startOf('day'), moment()],
                    'Last 3 Months': [moment().subtract(3, 'months').startOf('day'), moment()],
                    'Last 1 Year': [moment().subtract(12, 'months').startOf('day'), moment()]
                    //'This Month': [moment().startOf('month'), moment().endOf('month')],
                    //'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }
            }, function (start, end) {
                // Update input field   
                $('#Purchasedatepicker').val(start.format('DD/MM/YYYY') + ' - ' + end.format('DD/MM/YYYY'));

                // Filter DataTable rows based on selected date range
                $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                    var addedDate = moment(data[3], 'DD/MM/YYYY'); // assuming 4th column is date
                    return addedDate.isBetween(start, end, undefined, '[]');
                });

                tblPOHistory.draw();
                $.fn.dataTable.ext.search.pop();
            });

            // Clear date picker when cancell
            $('#Purchasedatepicker').on('cancel.daterangepicker', function () {
                $(this).val('');
                tblPOHistory.draw();
            });

            // Clear filter button
            $('#clearFilter').on('click', function () {
                $('#Purchasedatepicker').val('');
                tblPOHistory.draw();
            });


        // Handle Select All checkbox (duplicate - consider removing one)
            //$(document).on('change', '#selectAll', function () {
            $(document).off("click", ".btn-view").on("click", ".btn-view", function (e) {
                e.preventDefault();
                e.stopPropagation(); // stop any parent click or duplicate handler
            var isChecked = $(this).is(':checked');
            $('.row-select').prop('checked', isChecked);
        });

        $(document).on('change', '.row-select', function () {
            if ($('.row-select:checked').length === $('.row-select').length) {
                $('#selectAll').prop('checked', true);
            } else {
                $('#selectAll').prop('checked', false);
            }
        });
            // 🔹 Custom filter by Status
            $('#statusFilter').on('change', function () {
                var selectedStatus = $(this).val();

                // Apply custom search to Status column
                // Assuming your Status column is index 7 (check your column order!)
                tblPOHistory.column(7).search(selectedStatus, true, false).draw();
            });


        // View PO button click handler (duplicate - consider removing one)
        $(document).on("click", ".btn-view", function (e) {
            // Tooltip cleanup
            var $targetWithTooltip = $(e.target).closest('[data-bs-toggle="tooltip"]');
            if ($targetWithTooltip.length === 0) {
                $targetWithTooltip = $(this).closest('button, [data-bs-toggle="tooltip"]');
            }

            try { $targetWithTooltip.blur(); } catch (err) { }
            const tooltip = bootstrap.Tooltip.getInstance($targetWithTooltip.get(0));
            if (tooltip) {
                tooltip.hide(); // or tooltip.dispose() if you want to fully destroy
            }

            // Your existing logic: open PDF
            let row = $(this).data("row");
            if (row.StateName && row.StateName.trim().toLowerCase() === 'rejected') {
                console.log("PO is Rejected");
                
                viewRejectedPODetails(row.POCode); 
                return;
            }
            else {
                window.open('/Purchase/GeneratePOPDF?POCode=' + row.POCode, '_blank');
            }
        });

            function viewRejectedPODetails(poCode) {
                $.ajax({
                    url: '/Purchase/GetRejectedPODetailsOK',
                    type: 'GET',
                    data: { poCode: poCode },
                    success: function (data) {
                        if (data) {
                            const po = data.po;

                            // ✅ Fill Company details
                            $('#companyName').val(po.CompanyName);
                            $('#companyAddress').val(po.CompanyAddress);
                            $('#companyPhone').val(po.CompanyPhone);
                            $('#companyEmail').val(po.CompanyEmail);
                            $('#companyWebsite').val(po.Website);

                            // ✅ Fill PO details
                            $('#poCode').val(po.POCode);
                            //$('#poAddedDate').val(po.AddedDate);
                            if (po.AddedDate) {
                                console.log(po.AddedDate);
                                $("#poAddedDate").val(moment(po.AddedDate, "YYYY-MM-DD").format("DD/MM/YYYY"));
                            }

                            $('#shippingCharges').val(po.ShippingCharges);
                            $('#rejectedByName').val(po.ApprovedBy);
                            //$('#rejectedDate').val(po.ApprovedRejectedDate);
                            if (po.ApprovedRejectedDate) {
                                console.log(po.ApprovedRejectedDate);
                                $("#rejectedDate").val(moment(po.ApprovedRejectedDate, "YYYY-MM-DD").format("DD/MM/YYYY"));
                            }

                            $('#rejectedNote').val(po.Note);

                            // ✅ Fill Vendor details
                            $('#vendorName').val(po.VendorName);
                            $('#vendorAddress').val(po.VendorAddress);
                            $('#vendorPhone').val(po.VendorPhone);
                            $('#vendorEmail').val(po.VendorEmail);

                            // ✅ Fill Warehouse details
                            $('#warehouseName').val(po.WarehouseName);
                            $('#warehouseAddress').val(po.WarehouseAddress);
                            $('#warehousePhone').val(po.WarehousePhone);
                            $('#warehouseEmail').val(po.WarehouseEmail);

                            // ✅ Fill amount summary
                            $('#subAmount').text('₹' +po.SubAmount);
                            $('#shippingTotal').text('₹' +po.ShippingCharges);
                            $('#grandTotal').text('₹' +po.GrandTotal);

                            // ✅ Initialize / Refresh DataTable
                            if ($.fn.DataTable.isDataTable('#tblRejectedPOItems')) {
                                $('#tblRejectedPOItems').DataTable().clear().destroy();
                            }

                            // ✅ Initialize new DataTable
                            $('#tblRejectedPOItems').DataTable({
                                data: data.poItems,
                                destroy: true,
                                responsive: true,
                                paging: false,
                                searching: false,
                                ordering: false,
                                //scrollX: false,
                                info: false,
                                columns: [
                                    { data: null, title: "Sr.No", render: (d, t, r, m) => m.row + 1 },
                                    { data: "ItemCode", title: "Item Code" },
                                    { data: "ItemName", title: "Item Name" },
                                    {
                                        data: "Description",
                                        defaultContent: "",
                                        render: function (data) {
                                            const safeData = (data || "").replace(/"/g, '&quot;');
                                            return `<span data-bs-toggle="tooltip" title="${safeData}">${data}</span>`;
                                        }
                                    },
                                    { data: "Quantity", title: "Qty" },
                                    { data: "UOM", title: "UOM" },
                                    {
                                        data: "CostPerUnit",
                                        title:"CostPerUnit",
                                        defaultContent: "",
                                        render: function (data, type, row) {
                                            if (type === 'display' || type === 'filter') {
                                                return '₹' + parseFloat(data || 0).toFixed(2);
                                            }
                                            return data;
                                        }
                                    },
                                    { data: "Discount", title: "Discount" },
                                    { data: "GST", title: "GST" },
                                    {
                                        data: "Amount",
                                        defaultContent: "",
                                        render: function (data, type, row) {
                                            if (type === 'display' || type === 'filter') {
                                                return '₹' + parseFloat(data || 0).toFixed(2);
                                            }
                                            return data;
                                        }
                                    }
                                ],
                                drawCallback: function () {
                                    $('#tblRejectedPOItems [data-bs-toggle="tooltip"]').each(function () {
                                        const t = bootstrap.Tooltip.getInstance(this);
                                        if (t) t.dispose();
                                        new bootstrap.Tooltip(this, {
                                            customClass: 'tooltip-dark',
                                            trigger: 'hover focus'
                                        });
                                    });
                                },
                                columnDefs: [
                                    { className: "text-center", targets: "_all" }
                                ]
                                //order: [],
                                //dom: 'Bfrtip'
                             
                            });

                            // ✅ Show modal
                            $('#rejectedPOModal').modal('show');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching rejected PO details:", error);
                    }
                });
            }

            });

           

            // Initialize Bootstrap tooltips
            function initTooltips() {
                const tooltipTriggerList = [].slice.call(
                    document.querySelectorAll('[data-bs-toggle="tooltip"]')
                );
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl, {
                        customClass: 'tooltip-dark',
                        trigger: 'hover'
                    });
                });
            }

    // Helper function to recalc SrNo for export across all pages
    function getExportSrNo(rowIdx, tbl) {
        // Get all rows nodes
        let allRows = tbl.rows({ order: 'applied', search: 'applied' }).nodes().toArray();
        // Filter only the checked rows
        let checkedRows = allRows.filter(row => $(row).find('input.row-select').prop('checked'));
        // Find the position of this row in the checkedRows array
        let sr = checkedRows.findIndex(row => tbl.row(row).index() === rowIdx) + 1;
        return sr; // consecutive Sr.No
    }
        </script>
</body>
</html>

