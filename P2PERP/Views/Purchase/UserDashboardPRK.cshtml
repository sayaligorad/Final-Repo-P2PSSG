@{
    ViewBag.Title = "UserDashboard";
}

<!DOCTYPE html>
<html lang="en">
<head>

<style>
    .materio-card {
        background: #FFFFFF;
        position: relative;
        border-radius: 12px;
        transition: all 0.3s ease-in-out;
    }

    .card-bottom-line {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 1px;
        width: 100%;
        border-radius: 0 0 12px 12px !important;
        filter: brightness(1.35); /* ✅ lighter initially */
        transition: filter .3s ease;
    }

    .materio-card:hover .card-bottom-line {
        filter: brightness(0.85); /* ✅ darker */
    }

    .materio-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.12);
    }

    .materio-card h3 {
        font-size: 24px;
    }

    .icon-box {
        width: 42px;
        height: 42px;
        border-radius: 12px;
    }

    /* Title font size */
    .materio-card h3 {
        font-size: 24px;
    }


     bottom colored strip 
    .card-bottom-line {
        height: 4px;
        width: 100%;
    }


        .modal-backdrop {
            display: none !important;
        }

        body.modal-open .container::before {
            content: '';
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1040;
        }

        .modal {
            z-index: 1055 !important;
        }

         .icon-circle {
             backdrop-filter: blur(4px);
         }
</style>
</head>
<body class="bg-light">
    <div class="main-content">
        <div class="container py-4">
            <div class="shadow-sm rounded bg-white p-4">
                <div class="text-center mb-4">
                    <h3 class="text-primary fw-bold">Purchase Requisition Manager Dashboard</h3>
                </div>

                <!-- Cards section -->
                <div class="row g-3 mb-4">

                    @{
                        var cards = new[] {
            new { Id="approvedPrCard", Icon="bi-check2-circle", Count=0, Title="Approved Purchase Requisition", Bg="#4CAF50", Bg20="rgba(76,175,80,0.15)" },
            new { Id="pendingPrCard", Icon="bi-hourglass", Count=0, Title="Pending Purchase Requisition", Bg="#FF5722", Bg20="rgba(255,87,34,0.15)" },
            new { Id="requestedRfqCard", Icon="bi-check2-circle", Count=0, Title="Requested RFQ", Bg="#03A9F4", Bg20="rgba(3,169,244,0.15)" },
            new { Id="pendingRfqCard", Icon="bi-hourglass", Count=0, Title="Pending RFQ", Bg="#FFC107", Bg20="rgba(255,193,7,0.20)" },
            new { Id="approvedRcCard", Icon="bi-check2-circle", Count=0, Title="Approved Register Quotation", Bg="#009688", Bg20="rgba(0,150,136,0.15)" },
            new { Id="pendingRcCard", Icon="bi-hourglass", Count=0, Title="Pending Register Quotation", Bg="#9C27B0", Bg20="rgba(156,39,176,0.18)" },
            new { Id="approvedPoCard", Icon="bi-check2-circle", Count=0, Title="Approved Purchase Order", Bg="#673AB7", Bg20="rgba(103,58,183,0.18)" },
            new { Id="pendingPoCard", Icon="bi-hourglass", Count=0, Title="Pending Purchase Order", Bg="#E91E63", Bg20="rgba(233,30,99,0.18)" }
        };
                    }

                    @foreach (var card in cards)
                    {
                        <div class="col-sm-6 col-lg-3">
                            <div id="@card.Id"
                                 class="card materio-card h-100 shadow-sm border-0 text-start position-relative p-3"
                                 style="cursor:pointer; overflow:hidden;">

                                <!-- Icon + Count -->
                                <div class="d-flex align-items-start">

                                    <!-- Icon -->
                                    <div class="icon-box d-flex justify-content-center align-items-center"
                                         style="background:@card.Bg20;">
                                        <i class="bi @card.Icon fs-5" style="color:@card.Bg;"></i>
                                    </div>

                                    <!-- Count -->
                                    <h3 class="mb-0 ms-3 fw-bold" style="color:@card.Bg" id="@card.Id-count">
                                        @card.Count
                                    </h3>
                                </div>

                                <!-- Title -->
                                <div class="mt-2">
                                    <h6 class="mb-0 fw-semibold">@card.Title</h6>
                                </div>

                                <!-- ✅ Bottom color line -->
                                <div class="card-bottom-line" style="background:@card.Bg"></div>

                            </div>
                        </div>
                    }
                </div>





                <!-- Charts section -->
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div id="barChart" style="height: 400px;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div id="trendChart" style="height: 400px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Button -->
                <button id="dateFilterBtn"
                        class="btn btn-primary rounded-circle shadow-lg position-fixed"
                        style="top: 70px; right: 20px; width: 60px; height: 60px; z-index: 1050;">
                    <i class="bi bi-calendar-date fs-4"></i>
                </button>

                <!-- Hidden input used for daterangepicker (required for correct positioning) -->
                <input type="text" id="reportrange" class="form-control position-fixed"
                       style="top: 70px; right: 20px; width: 1px; height: 1px; opacity: 0; z-index: -1;" />
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="dashboardModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content rounded-3">
                <div class="modal-header bg-primary d-flex justify-content-center align-items-center rounded-top p-1">
                    <h5 class="modal-title fw-bold text-white mb-0 fs-5" id="dashboardModalLabel">Details</h5>
                    <button type="button" class="btn-close btn-close-white position-absolute end-0 me-3" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="dashboardModalBody"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedStartDate, selectedEndDate;

        function initDateRangePicker() {
            const start = moment().startOf('year');
            const end = moment().endOf('year');

            $('#reportrange').daterangepicker({
                startDate: start,
                endDate: end,
                opens: 'left',
                drops: 'down',
                parentEl: 'body',
                alwaysShowCalendars: false,
                autoUpdateInput: true,
                autoApply: false, // Needed for Apply/Cancel
                showDropdowns: true,
                ranges: {
                    'Today': [moment(), moment()],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 1 Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last 3 Month': [moment().subtract(3, 'month').startOf('month'), moment().subtract(3, 'month').endOf('month')],
                    'Last 1 Year': [moment().startOf('year'), moment().endOf('year')]
                },
                locale: {
                    cancelLabel: 'Clear',
                    applyLabel: 'Apply',
                    format: 'DD/MM/YYYY'
                }
            });

            // Set initial value in field
            $('#reportrange').val(start.format('DD-MM-YYYY') + ' - ' + end.format('DD/MM/YYYY'));

            // Initial dashboard load
            onDateChange(start, end);

            // Handle Apply
            $('#reportrange').on('apply.daterangepicker', function (ev, picker) {
                selectedStartDate = picker.startDate.format('YYYY-MM-DD');
                selectedEndDate = picker.endDate.format('YYYY-MM-DD');

                const displayStartDate = picker.startDate.format('DD/MM/YYYY');
                const displayEndDate = picker.endDate.format('DD/MM/YYYY');

                $(this).val(displayStartDate + ' - ' + displayEndDate);

                onDateChange(picker.startDate, picker.endDate);
            });

            // Handle Clear
            $('#reportrange').on('cancel.daterangepicker', function () {
                $(this).val('');

                // Reset to default
                const start = moment().startOf('year');
                const end = moment().endOf('year');

                onDateChange(start, end);
            });
        }

        function onDateChange(start, end) {
            selectedStartDate = start.format('YYYY-MM-DD');
            selectedEndDate = end.format('YYYY-MM-DD');

            const displayStartDate = start.format('DD/MM/YYYY');
            const displayEndDate = end.format('DD/MM/YYYY');

            $.get("/Purchase/GetDashboardCounts", {
                startDate: selectedStartDate,
                endDate: selectedEndDate
            }, function (data) {
                $("#approvedPrCard h3").text(data.ApprovedPR);
                $("#pendingPrCard h3").text(data.PendingPR);
                $("#requestedRfqCard h3").text(data.RequestedRFQ);
                $("#pendingRfqCard h3").text(data.PendingRFQ);
                $("#approvedRcCard h3").text(data.ApprovedRC);
                $("#pendingRcCard h3").text(data.PendingRC);
                $("#approvedPoCard h3").text(data.ApprovedPO);
                $("#pendingPoCard h3").text(data.PendingPO);


                        Highcharts.chart('barChart', {
                            chart: { type: 'column' },
                            title: {
                                useHTML: true,
                                text: `
                    <span style="color:#28a745; font-size:14px; font-weight:600; font-family:Segoe UI, Roboto, sans-serif;">
                        <i class="bi bi-bar-chart-fill me-1"></i> <!-- Bootstrap icon for status -->
                        PR, RFQ, RQ & PO Status (${displayStartDate} to ${displayEndDate})
                    </span>
                `
                            },
                            xAxis: { categories: ['PR', 'RFQ', 'RQ', 'PO'] },
                            yAxis: { min: 0, title: { text: 'Count' } },
                            plotOptions: {
                                column: {
                                    borderRadius: 5,
                                    dataLabels: {
                                        enabled: true,
                                        style: { fontWeight: 'bold', color: '#000', textOutline: 'none' }
                                    }
                                }
                            },
                            series: [
                                {
                                    name: 'Approved / Requested',
                                    data: [data.ApprovedPR, data.RequestedRFQ, data.ApprovedRC, data.ApprovedPO],
                                    color: {
                                        linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                                        stops: [
                                            [0, '#16a34a'], // top (lighter green)
                                            [1, '#0d6d2d']  // bottom (darker green)
                                        ]
                                    }
                                },
                                {
                                    name: 'Pending',
                                    data: [data.PendingPR, data.PendingRFQ, data.PendingRC, data.PendingPO],
                                    color: {
                                        linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                                        stops: [
                                            [0, '#facc15'], // top (lighter yellow)
                                            [1, '#d97706']  // bottom (darker golden)
                                        ]
                                    }
                                }
                            ],
                            tooltip: { shared: true },
                            credits: { enabled: false }
                        });

                    });
                

            loadTrendData(selectedStartDate, selectedEndDate, displayStartDate, displayEndDate);
        }

        function loadTrendData(startDate, endDate, displayStartDate, displayEndDate) {
            $.ajax({
                url: '/Purchase/GetDashboardTrends',
                type: 'GET',
                data: { startDate: startDate, endDate: endDate },
                success: function (response) {
                    const categories = (response?.Trend?.Categories || []).map(c => {
                        const m = moment(c, ["YYYY-MM-DD", "YYYY-MM-DDTHH:mm:ss", "DD-MM-YYYY"], true);
                        return m.isValid() ? m.format("DD/MM/YYYY") : c;
                    });


                    const prData = response?.Trend?.PR || [];
                    const rfqData = response?.Trend?.RFQ || [];
                    const rqData = response?.Trend?.RQ || [];
                    const poData = response?.Trend?.PO || [];

                    if (categories.length > 0) {
                        Highcharts.chart('trendChart', {
                            chart: { type: 'line' },
                            title: {
                                useHTML: true,
                                text: `
                                    <span style="color:#28a745; font-size:14px; font-weight:600; font-family:Segoe UI, Roboto, sans-serif;">
                                        <i class="bi bi-graph-up me-1"></i> <!-- Bootstrap icon for status -->
                                        PR, RFQ, RQ & PO Trend (${displayStartDate} to ${displayEndDate})
                                    </span>
`
                            },
                            xAxis: { categories: categories },
                            yAxis: { min: 0, title: { text: 'Count' } },
                            series: [
                                { name: 'PR', data: prData, color: '#3b82f6' },
                                { name: 'RFQ', data: rfqData, color: '#9333ea' },
                                { name: 'RQ', data: rqData, color: '#f97316' },
                                { name: 'PO', data: poData, color: '#16a34a' }
                            ],
                            tooltip: { shared: true },
                            credits: { enabled: false }
                        });
                    } else {
                        $('#trendChart').html('<p class="text-center text-muted">No trend data available for selected range.</p>');
                    }
                },
                error: function () {
                    $('#trendChart').html('<p class="text-center text-danger">Failed to load trend data.</p>');
                }
            });
        }

        $(document).ready(function () {
            initDateRangePicker();

            // Show datepicker on button click and reposition
            $('#dateFilterBtn').on('click', function () {
                const drp = $('#reportrange').data('daterangepicker');
                drp.show();

                const btn = $(this);
                const offset = btn.offset();
                const btnWidth = btn.outerWidth();
                const drpWidth = drp.container.outerWidth();
                let left = offset.left + btnWidth - drpWidth;
                if (left < 0) left = 0;

                drp.container.css({ top: offset.top + btn.outerHeight() + 5, left: left, right: 'auto' });
            });

            // Modal loader (unchanged)
            const modal = new bootstrap.Modal(document.getElementById("dashboardModal"));
            function loadPartial(title, url) {
                const $modal = $("#dashboardModal");
                const $modalBody = $("#dashboardModalBody");

                // Set modal title
                $("#dashboardModalLabel").text(title);

                // Show modal
                $modal.modal('show');

                // Abort previous AJAX
                if (window.currentAjax && window.currentAjax.readyState !== 4) {
                    window.currentAjax.abort();
                }

                // Destroy any existing DataTables inside modal
                $modalBody.find('.dataTable').each(function () {
                    if ($.fn.DataTable.isDataTable(this)) {
                        $(this).DataTable().clear().destroy(true); // fully remove old table
                    }
                });

                // Clear modal body and show loading
                $modalBody.empty().html('<p class="text-center text-muted">Loading...</p>');

                // Load new partial
                window.currentAjax = $.ajax({
                    url: url,
                    type: 'GET',
                    data: { startDate: selectedStartDate, endDate: selectedEndDate },
                    cache: false
                });

                window.currentAjax.done(function (html) {
                    // Insert partial HTML
                    $modalBody.html(html);

                    // 🔹 Initialize DataTables dynamically
                    $modalBody.find('.dataTable').each(function () {
                        const tableId = $(this).attr('id');
                        // Check if there’s a global init function for this table
                        if (tableId && typeof window['init_' + tableId] === 'function') {
                            window['init_' + tableId](selectedStartDate, selectedEndDate);
                        }
                    });

                    // Reset AJAX tracker
                    window.currentAjax = null;
                });

                window.currentAjax.fail(function (jqXHR, textStatus, errorThrown) {
                    console.error('AJAX failed:', textStatus, errorThrown);
                    $modalBody.html('<p class="text-danger text-center">Error loading data.</p>');
                    window.currentAjax = null;
                });
            }



            // Card click events
            $("#approvedPrCard").click(() => loadPartial("Approved Purchase Requisition", "/Purchase/ShowApprovePRPartialPRK"));
            $("#pendingPrCard").click(() => loadPartial("Pending Purchase Requisition", "/Purchase/ShowPendingPRPartialPRK"));
            $("#requestedRfqCard").click(() => loadPartial("Requested Request for Quotation", "/Purchase/ShowReuestedRFQPartialPRK"));
            $("#pendingRfqCard").click(() => loadPartial("Pending Request for Quotation", "/Purchase/ShowPendingRFQPartialPRK"));
            $("#approvedRcCard").click(() => loadPartial("Approved Register Quotation", "/Purchase/ShowApproveRQPartialPRK"));
            $("#pendingRcCard").click(() => loadPartial("Pending Register Quotation", "/Purchase/ShowPendingRQPartialPRK"));
            $("#approvedPoCard").click(() => loadPartial("Approved Purchase Orders", "/Purchase/ShowApprovePOPartialPRK"));
            $("#pendingPoCard").click(() => loadPartial("Pending Purchase Orders", "/Purchase/ShowPendingPOPartialPRK"));


            $('#dashboardModal').on('hidden.bs.modal', function () {
                // Destroy tables from any partials
                destroyDataTable('#requestedRfqTable');
                destroyDataTable('#anotherPartialTable'); // if you have more partial tables

                // Abort any pending AJAX
                if (window.currentAjax && window.currentAjax.readyState !== 4) {
                    window.currentAjax.abort();
                    window.currentAjax = null;
                }

                $("#dashboardModalBody").empty();
            });



        });
    </script>
</body>
</html>
