@{
    Layout = null;
}
<style>
    #grnTable thead th {
        padding: 0.3rem 0.4rem !important;
    }
</style>
<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index:1100;"></div>

<div>

    <!-- Date Picker -->
    <div class="d-flex mb-3 gap-2">
        <div class="input-group" style="max-width: 230px;">
            <span class="input-group-text bg-primary text-white" style="height: 100%;">
                <i class="bi bi-calendar-date"></i>
            </span>
            <input type="text" id="grnlistdatepicker" class="form-control" placeholder="Select date range" readonly style="height: 100%;" />
        </div>
        <div id="exportContainer" class="d-flex" style="height: 40px; align-items: center;"></div>
    </div>

    <!-- GRN Table -->
    <div class="table-responsive">
        <table id="grnTable" class="table table-bordered table-striped table-hover text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>Sr. No.</th>
                    <th>GRN Code</th>
                    <th>PO Code</th>
                    <th>Invoice No</th>
                    <th>Vendor Name</th>
                    <th>GRN Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- GRN Details Modal -->
<div class="modal fade" data-bs-backdrop="true" id="grnDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content shadow-lg rounded-3">
            <div class="card-header bg-primary text-white d-flex justify-content-center align-items-center rounded-top p-1 position-relative">
                <h3 id="grnModalTitle" class="modal-title fw-bold text-white mb-0 fs-5 w-100 text-center">View GRN</h3>
                <button type="button" class="btn-close btn-close-white position-absolute end-0 me-3" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="grnDetailsModalBody">
                <p class="text-center py-3">Loading...</p>
            </div>

        </div>
    </div>
</div>


<style>
    button.dt-button.processing,
    div.dt-button.processing {
        pointer-events: auto !important;
        opacity: 1 !important;
        background: none !important;
    }

        button.dt-button.processing:after {
            content: none !important;
        }
</style>

<script>

toastr.options = {
    closeButton: true,
    progressBar: true,
    preventDuplicates: true,
    newestOnTop: true,
    positionClass: "toast-top-right",
    timeOut: "3000"
};

// Helper functions for toastr
function showInfo(message)   { toastr.info(message, "Info"); }
function showSuccess(message){ toastr.success(message, "Success"); }
function showWarning(message){ toastr.warning(message); }
function showError(message)  { toastr.error(message, "Error"); }

$(document).ready(function () {
    var selectedGRNs = new Set();
    var fromDate = "";
    var toDate = "";


   var table = $('#grnTable').DataTable({
    ajax: {
        url: '@Url.Action("GRNListSSG","GRN")',
        type: 'GET',
        responsive: true,
           data: function (d) {
               d.fromDate = fromDate;
               d.toDate = toDate;
           },
           dataSrc: function (json) {
               return json.data;
           }
    },
    destroy: true,
       responsive: true,
       ordering: false,
    columns: [
        {
            data: 'GRNCode',
            orderable: false,
            className: 'text-center',
            render: data => `<input type="checkbox" class="rowCheckbox" value="${data}" ${selectedGRNs.has(data) ? 'checked' : ''}>`
        },
        { data: null, className: 'text-center', render: (d, t, r, m) => m.row + 1 },
        { data: 'GRNCode', className: 'text-center' },
        { data: 'POCode', className: 'text-center' },
        { data: 'InvoiceNo', className: 'text-center' },
        { data: 'VendorName', className: 'text-center' },
        {
            data: 'GRNDate',
            className: 'text-center',
            render: function (data) {
                return data ? moment(data, "DD-MM-YYYY").format("DD/MM/YYYY") : "";
            }
        },
        {
            data: null,
            orderable: false,
            className: 'text-center',
            render: function (row) {
                let assignQCBtn = row.ShowAssignQCButton
                    ? `<button class="btn btn-success square-pill d-inline-flex align-items-center px-2 py-1 btn-sm btnAssignQC"
                        data-grn="${row.GRNCode}"
                        data-bs-toggle="tooltip"
                        title="Assign QC For: ${row.GRNCode}">
                        <i class="bi bi-check2-square"></i>
                    </button>`
                    : '';
                return `
                <div class="d-flex flex-column flex-sm-row gap-1 justify-content-center">
                    <button class="btn btn-primary square-pill d-inline-flex align-items-center px-2 py-1 btn-sm btnViewGRN"
                            data-grn="${row.GRNCode}"
                            data-bs-toggle="tooltip"
                            title="View GRN: ${row.GRNCode}">
                        <i class="bi bi-eye-fill"></i>
                    </button>
                    ${assignQCBtn}
                </div>`;
            }
        }
    ],

        dom:
            '<"row mb-3"<"col-md-6 d-flex gap-2"B><"col-md-6 d-flex justify-content-end"f>>' +
            '<"table-responsive"t>' +
            '<"row mt-3"<"col-md-6"i><"col-md-6 d-flex justify-content-end"p>>',
        buttons: [
            // --- PRINT---
            {
                extend: 'print',
                text: '<i class="bi bi-printer-fill text-dark fs-5"></i>',
                title: '',
                exportOptions: {
                    columns: [2, 3, 4, 5,6],
                    rows: (idx, data, node) => selectedGRNs.has(data.GRNCode)
                },
                customize: function (win) {
                    let body = $(win.document.body);
                    body.find('h1').remove();
                    body.prepend(
                        '<h2 style="text-align:center; color:black; margin-bottom:0;">GRN List</h2>' +
                        '<h5 style="text-align:center; color:black; margin-top:0; margin-bottom:10px;">Generated Date: ' + moment().format("DD/MM/YYYY") + '</h5>'
                    );

                    let exportSerialCounter = 0;
                    body.find('table thead tr').prepend('<th>Sr.No.</th>');
                    body.find('table tbody tr').each(function () {
                        $(this).prepend('<td>' + (++exportSerialCounter) + '</td>');
                    });

                    let css = `
            table thead th {
                background-color: #000 !important;
                color: #fff !important;
                text-align: center !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            table tbody td {
                text-align: center !important;
            }
            table {
                border: 1px solid black !important;
                border-collapse: collapse !important;
                width: 100%;
            }
            table th, table td {
                border: 1px solid black !important;
                padding: 5px !important;
            }
        `;
                    $(win.document.head).append('<style>' + css + '</style>');
                },
                action: function (e, dt, btn, config) {
                    if (selectedGRNs.size === 0) {
                        showExportWarning();
                        return;
                    }
                    $.fn.dataTable.ext.buttons.print.action.call(this, e, dt, btn, config);
                    showExportSuccess("Print started.");
                }
            },
            // --- PDF GRN List ---
            {
                extend: 'pdfHtml5',
                text: '<i class="bi bi-file-earmark-pdf fs-5 text-danger"></i>',
                title: '',
                filename: `GRN List - ${moment().format("DD-MM-YYYY")}`,
                exportOptions: {
                    columns: [2, 3, 4, 5, 6],
                    rows: (idx, data, node) => selectedGRNs.has(data.GRNCode)
                },
                customize: function (doc) {
                    exportSerialCounter = 0;
                    doc.content.unshift(
                        { text: 'GRN List', style: 'title', alignment: 'center', margin: [0, 0, 0, 5], fontSize: 16, bold: true },
                        { text: 'Generated Date: ' + moment().format("DD/MM/YYYY"), style: 'subTitle', alignment: 'center', margin: [0, 0, 0, 10], fontSize: 12 }
                    );

                    let tableBody = doc.content[2].table.body;
                    tableBody[0].unshift({ text: 'Sr.No.', bold: true, fillColor: '#000', color: '#fff', alignment: 'center' });
                    tableBody.forEach(function (row, idx) {
                        if (idx === 0) return;
                        row.unshift({ text: (++exportSerialCounter).toString(), alignment: 'center' });
                    });
                    tableBody[0].forEach(function (headerCell) {
                        headerCell.fillColor = '#000';
                        headerCell.color = '#fff';
                        headerCell.alignment = 'center';
                        headerCell.bold = true;
                    });
                    tableBody.forEach(function (row, idx) {
                        if (idx === 0) return;
                        row.forEach(function (cell) {
                            if (cell && cell.text !== undefined) {
                                cell.alignment = 'center';
                            }
                        });
                    });
                    doc.content[2].table.alignment = 'center';
                    doc.content[2].table.widths = Array(doc.content[2].table.body[0].length).fill('*');
                    doc.content[2].layout = {
                        hLineWidth: () => 1,
                        vLineWidth: () => 1,
                        hLineColor: () => '#000',
                        vLineColor: () => '#000',
                        paddingLeft: () => 5,
                        paddingRight: () => 5,
                        paddingTop: () => 4,
                        paddingBottom: () => 4
                    };
                    doc.pageMargins = [40, 40, 40, 40];
                },
                action: function (e, dt, btn, config) {
                    if (selectedGRNs.size === 0) {
                        showExportWarning("Select at least one GRN to export.");
                        return;
                    }
                    $.fn.dataTable.ext.buttons.pdfHtml5.action.call(this, e, dt, btn, config);
                    showExportSuccess("PDF export completed");
                }
            },


            // --- Excel GRN List ---
            {
                extend: 'excelHtml5',
                text: '<i class="bi bi-file-earmark-excel fs-5 text-success"></i>',
                title: '',
                filename: `GRN_List_${moment().format("DD-MM-YYYY")}`,
                titleAttr: 'Export Excel',
                exportOptions: {
                    columns: [0, 2, 3, 4, 5, 6],
                    rows: (idx, data, node) => selectedGRNs.has(data.GRNCode),
                    format: {
                        header: function (data, colIdx) {
                            if (colIdx === 0) return 'Sr.No.';
                            return data;
                        },
                        body: function (data, row, colIdx) {
                            if (colIdx === 0) return ++exportSerialCounter;
                            return $('<div>').html(data).text().trim();
                        }
                    }
                },
                customize: function (xlsx) {
                    const sheet = xlsx.xl.worksheets['sheet1.xml'];
                    const dateStr = moment().format("DD/MM/YYYY");
                    $(sheet).find('row').each(function () {
                        const r = parseInt($(this).attr('r'));
                        $(this).attr('r', r + 2);
                        $(this).find('c').each(function () {
                            const cellRef = $(this).attr('r');
                            const col = cellRef.replace(/\d+/g, '');
                            const row = parseInt(cellRef.replace(/\D/g, '')) + 2;
                            $(this).attr('r', col + row);
                        });
                    });
                                    const titleRow = `<row r="1">
                    <c t="inlineStr" r="C1" s="2"><is><t>GRN List</t></is></c>
                </row>`;
                                    const dateRow = `<row r="2">
                    <c t="inlineStr" r="C2" s="2"><is><t>Generated Date: ${dateStr}</t></is></c>
                </row>`;

                    sheet.childNodes[0].childNodes[1].innerHTML = titleRow + dateRow + sheet.childNodes[0].childNodes[1].innerHTML;
                },
                action: function (e, dt, btn, config) {
                    if (selectedGRNs.size === 0) {
                        showExportWarning("Select at least one GRN to export.");
                        return;
                    }
                    exportSerialCounter = 0;
                    $.fn.dataTable.ext.buttons.excelHtml5.action.call(this, e, dt, btn, config);
                }
            },
            // --- CSV EXPORT ---
            {
                extend: 'csvHtml5',
                text: '<i class="bi bi-filetype-csv fs-5 text-success"></i>',
                filename: `GRN List - ${moment().format("DD-MM-YYYY")}`,
                bom: true,
                exportOptions: {
                    columns: [0, 2, 3, 4, 5,6],
                    rows: (idx, data, node) => selectedGRNs.has(data.GRNCode),
                    format: {
                        header: function (data, colIdx) {
                            if (colIdx === 0) return 'Sr.No.';
                            return data;
                        },
                        body: function (data, row, colIdx) {
                            let plain = $('<div>').html(data).text().trim();
                            plain = plain.replace(/â‚¹|&amp;#8377;/g, '₹');
                            if (colIdx === 0) return ++exportSerialCounter;
                            return plain;
                        }
                    },
                    customize: function (xlsx) {
                        var sheet = xlsx.xl.worksheets['sheet1.xml'];
                        var $sheet = $(sheet);

                        $sheet.find('row c').each(function () {
                            var $c = $(this);
                            var col = $c.attr('r').replace(/[0-9]/g, '');
                            if (col === 'G' || col === 'H') {
                                $c.attr('t', 'inlineStr');
                                var v = $c.find('v').text();
                                $c.empty().append(`<is><t>${v}</t></is>`);
                            }
                        });
                    },

                },

                action: function (e, dt, btn, config) {
                    if (selectedGRNs.size === 0) {
                        showExportWarning("Select at least one row to export.");
                        return;
                    }
                    exportSerialCounter = 0;
                    $.fn.dataTable.ext.buttons.csvHtml5.action.call(this, e, dt, btn, config);
                }
            }

        ],
        rowCallback: (row, data) => $(row).find('.rowCheckbox').prop('checked', selectedGRNs.has(data.GRNCode))
    });

    // Checkbox handling (current page only)
    $(document).on('change', '.rowCheckbox', function () {
        const grn = $(this).val();
        if ($(this).is(':checked')) selectedGRNs.add(grn);
        else selectedGRNs.delete(grn);

        const allVisibleChecked = table.rows({ page: 'current' }).nodes().to$().find('.rowCheckbox').length ===
            table.rows({ page: 'current' }).nodes().to$().find('.rowCheckbox:checked').length;
        $('#selectAll').prop('checked', allVisibleChecked);
    });

    $(document).on('change', '#selectAll', function () {
        const checked = $(this).is(':checked');

        // Only select/deselect checkboxes on current page
        table.rows({ page: 'current' }).nodes().to$().find('.rowCheckbox').prop('checked', checked);

        table.rows({ page: 'current' }).data().each(d => {
            if (checked) selectedGRNs.add(d.GRNCode);
            else selectedGRNs.delete(d.GRNCode);
        });
    });


    // ✅ Export validation
    function exportValidation(e, dt, node, config) {
        if (selectedGRNs.size === 0) {
            showWarning("Please select at least one row before exporting");
            return;
        }
        config.exportOptions.rows = function (idx, data) { return selectedGRNs.has(data.GRNCode); };
        $.fn.dataTable.ext.buttons[config.extend].action.call(this, e, dt, node, config);
        showSuccess(config.extend.toUpperCase() + " export completed");
    }

    $('#grnlistdatepicker').daterangepicker({
        autoUpdateInput: false,
        opens: "center",
        drops: "down",
        locale: { format: "DD-MM-YYYY", cancelLabel: "Clear" },
        ranges: {
            'Today': [moment(), moment()],
            'Last 7 Days': [moment().subtract(6, 'days'), moment()],
            'Last 1 Month': [moment().subtract(1, 'month'), moment()],
            'Last 3 Months': [moment().subtract(3, 'month'), moment()],
            'Last 1 Year': [moment().subtract(1, 'year'), moment()]
        }
    }, function (start, end) {
        fromDate = start.format("YYYY-MM-DD");
        toDate = end.format("YYYY-MM-DD");
        $('#grnlistdatepicker').val(start.format("DD-MM-YYYY") + " - " + end.format("DD-MM-YYYY"));
        // table.ajax.reload();
        $('#grnTable').DataTable().ajax.reload();

    });

    $('#grnlistdatepicker').on("cancel.daterangepicker", function () {
        $(this).val("");
        fromDate = "";
        toDate = "";
        table.ajax.reload();
    });



// ✅ View GRN details
$(document).on("click", ".btnViewGRN", function () {
    let grnCode = $(this).data("grn");
    console.log("GrnCode", grnCode);
    // Open the PDF in new tab
    window.open('/GRN/GenerateGRNPDF?GRNCode=' + grnCode, '_blank');
    @*$("#grnDetailsModalBody").html("<p class='text-center py-3'>Loading...</p>");

    $("#grnModalTitle").text("View GRN");

    let url = '@Url.Action("ViewGRNSSG","GRN")' + '?GRNCode=' + grn;
    bootstrap.Modal.getOrCreateInstance(document.getElementById('grnDetailsModal')).show();
    $.get(url, html => $("#grnDetailsModalBody").html(html))
        .fail(() => showError("Failed to load GRN details"));*@
});

// ✅ Assign QC
$(document).on("click", ".btnAssignQC", function () {
    let grn = $(this).data("grn");
    $("#grnDetailsModalBody").html("<p class='text-center py-3'>Loading...</p>");
    $("#grnModalTitle").text("Assign to QC");

    bootstrap.Modal.getOrCreateInstance(document.getElementById('grnDetailsModal')).show();
    let url = '@Url.Action("FetchQCSSG","GRN")' + '?GRNCode=' + grn;
    $.get(url, function (html) {
        $("#grnDetailsModalBody").html(html);
        $("#txtGRNCodeQC").val(grn);
    }).fail(function () {
        showError("Failed to load QC items.");
    });
});

    function initTooltips() {
        $('[data-bs-toggle="tooltip"]').tooltip('dispose');

        $('[data-bs-toggle="tooltip"]').tooltip({
            trigger: 'hover',
            container: 'body'
        });
    }

    table.on('draw', function () {
        initTooltips();
    });

    $('#grnDetailsModal').on('show.bs.modal', function () {
        $('.tooltip').remove();
    });

});
</script>
