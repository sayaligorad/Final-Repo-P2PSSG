@{
    ViewBag.Title = "GRN Summary Report";
}

<style>
    /* Compact table */
    .dataTable td, .dataTable th {
        padding: 0.35rem 0.5rem !important;
        font-size: 0.78rem !important;
        vertical-align: middle;
    }
    td, th {
        text-align: center !important;
    }

    /* Small action buttons */
    .btn-delete {
        padding: 2px 6px;
        font-size: 0.75rem;
    }

        .btn-delete i {
            font-size: inherit;
        }

    /* View PO */
    .viewItemsBtn {
        padding: 2px 6px !important;
        font-size: 0.70rem !important;
    }

        .viewItemsBtn i {
            font-size: inherit; /* allow fs-* */
        }

    .square-btn {
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }


</style>

<div class="modal fade" id="grnItemsModal" tabindex="-1" aria-labelledby="grnItemsModalLabel" data-bs-backdrop="true" data-bs-keyboard="false" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content rounded-4 shadow-lg">
            <div class="card-header bg-primary text-white d-flex justify-content-center align-items-center rounded-top p-1">
                <h3 class="modal-title fw-bold text-white mb-0 fs-5" id="grnItemsModalLabel">GRN Items List</h3>
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-2 fs-5" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table id="GRNItemsTablePSM" class="table table-striped table-bordered w-100 text-center">
                    <thead class="table-dark text-center">
                        <tr>
                            <th><input type="checkbox" id="selectAllItems" /></th>
                            <th class="text-center">SR.No</th>
                            <th class="text-center">Item Name</th>
                            <th class="text-center">Cost Per Unit</th>
                            <th class="text-center">Unit Quantity</th>
                            <th class="text-center">Discount</th>
                            <th class="text-center">Tax Rate</th>
                            <th class="text-center">Final Amount</th>
                            <th class="text-center">Quality Check</th>
                        </tr>
                    </thead>
                    <tbody class="text-center"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="card shadow-lg border-0 rounded-4 p-4">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
            <div class="mb-2 d-flex gap-2 align-items-center">
                <div class="input-group" style="max-width: 280px;">
                    <span class="input-group-text bg-primary text-white">
                        <i class="bi bi-calendar-date"></i>
                    </span>
                    <input type="text" id="ThirdreportrangePSM" class="form-control" readonly placeholder="Select Date Range" />
                </div>
            </div>

            <div class="text-center">
                <h3 class="text-primary mb-0">
                   GRN Summary Report
                </h3>
            </div>
            <div style="width:280px;"></div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4 mx-auto">
                <div class="card text-white bg-info text-center shadow-lg rounded-4" style="background: linear-gradient(135deg, #4e73df, #1cc88a);">
                    <div class="card-body p-2 bg-white">
                        <h5 class="fw-bold text-secondary">Total GRN</h5>
                        <h1 id="totalGRNDisplay" class="display-3 fw-bold text-info my-3">0</h1>
                        <i class="bi bi-box-seam text-secondary fs-2"></i>
                    </div>
                </div>
            </div>
        </div>

        <h3 class="text-primary text-center mb-1">GRN Detailed Records</h3>
        <div class="table-responsive">
            <table id="GRNSummaryPSM" class="table table-striped table-bordered w-100">
                <thead class="table-dark">
                    <tr>
                        <th><input type="checkbox" id="selectAll" /></th>
                        <th class="text-center">SR.No</th>
                        <th class="text-center">GRN No</th>
                        <th class="text-center">PO No</th>
                        <th class="text-center">Vendor Name</th>
                        <th class="text-center">Vendor Company</th>
                        <th class="text-center">GRN Date</th>
                        <th class="text-center">Amount</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody class="text-center"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let table = null;
    let itemsTable = null; // Fixed: Added missing itemsTable declaration
    let currentFrom = null, currentTo = null;

    // Utility function to strip HTML tags
    function stripHtml(html) {
        if (!html) return '';
        const tmp = document.createElement("DIV");
        tmp.innerHTML = html;
        return tmp.textContent || tmp.innerText || "";
    }

    // Toast notification for export warnings
    function showExportToast() {
        toastr.warning("Please select at least one row before exporting!");
    }

    // === Date Range Picker ===
    $('#ThirdreportrangePSM').daterangepicker({
        autoUpdateInput: false,
        opens: "right",
        drops: "down",
        locale: {
            cancelLabel: 'Clear',
            format: 'DD/MM/YYYY'
        },
        ranges: {
            'Today': [moment(), moment()],
            'Last 7 Days': [moment().subtract(6, 'days'), moment()],
            'Last 1 Month': [moment().subtract(1, 'months'), moment()],
            'Last 3 Months': [moment().subtract(3, 'months'), moment()],
            'Last 1 Year': [moment().subtract(12, 'months'), moment()]
        }
    }, function (start, end) {
        $('#ThirdreportrangePSM').val(start.format('DD/MM/YYYY') + ' - ' + end.format('DD/MM/YYYY'));
        currentFrom = start.startOf('day').format('YYYY-MM-DDTHH:mm:ss');
        currentTo = end.endOf('day').format('YYYY-MM-DDTHH:mm:ss');
        if (table) table.ajax.reload();
        loadTotalGRN(currentFrom, currentTo);
    });

    $('#ThirdreportrangePSM').on('cancel.daterangepicker', function () {
        $(this).val('');
        currentFrom = null;
        currentTo = null;
        if (table) table.ajax.reload();
        loadTotalGRN(null, null);
    });

    // === DataTable Init ===
    function initTable() {
        table = $('#GRNSummaryPSM').DataTable({
            dom: '<"d-flex justify-content-between align-items-center mb-2"Bf>rt<"d-flex justify-content-between align-items-center"ip>',
            responsive: true,
            ajax: {
                url: '@Url.Action("AllGRNSummaryListPSM", "GRN")',
                type: 'GET',
                data: function (d) {
                    d.fromDate = currentFrom;
                    d.toDate = currentTo;
                },
                dataSrc: 'data'
            },
            columns: [
                { data: null, render: d => `<input type="checkbox" class="rowCheckbox" value="${d.GRNCode}" />`, orderable: false },
                { data: null, render: (d, t, r, m) => m.row + 1 },
                { data: 'GRNCode' },
                { data: 'POCode' },
                { data: 'VendorName' },
                { data: 'CompanyName' },
                {
                    data: 'AddedDate',
                    render: d => {
                        const dt = new Date(d);
                        return isNaN(dt) ? d : dt.toLocaleDateString('en-GB');
                    }
                },
                {
                    data: 'TotalAmount',
                    render: d => `<i class="bi bi-currency-rupee text-secondary"></i> ${(parseFloat(d) || 0).toLocaleString("en-IN", { minimumFractionDigits: 2 })}`
                },
                {
                    data: 'GRNCode',
                    render: d => `<button type="button" class="btn btn-primary square-btn square-pill viewItemsBtn" data-grn="${d}"><i class="bi bi-eye"></i></button>`
                }
            ],
            ordering: false,
            buttons: [
                //Print
                {
                    extend: 'print',
                    text: '<i class="bi bi-printer-fill text-dark fs-5"></i>',
                    titleAttr: 'Print',
                    title: 'Total PO Items',
                    exportOptions: {
                        columns: [2, 3, 4, 5, 6, 7],
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        }
                    },
                    customize: function (win) {
                        var $body = $(win.document.body);
                        // Add styling
                        $body.append(`<style>thead th {
             background-color: black !important;
             color: white !important;
             text-align: center !important;
             -webkit-print-color-adjust: exact !important;
             print-color-adjust: exact !important;
             }
             table { border-collapse: collapse !important; width: 100% !important; }
             td, th { border: 1px solid #000 !important; padding: 6px !important; }
             </style>`);
                        $body.find('h1').css('text-align', 'center');
                        var today = new Date();
                        var formattedDate = String(today.getDate()).padStart(2, '0') + '/' +
                            String(today.getMonth() + 1).padStart(2, '0') + '/' +
                            today.getFullYear();
                        $body.find('h1').after('<div style="text-align:center;font-style:italic;font-size:10pt;margin-bottom:12px;">Generated Date: ' + formattedDate + '</div>');
                        var $table = $body.find('table');
                        $table.addClass('table table-bordered table-striped').css('width', '100%');
                        $table.find('thead tr').prepend('<th>Sr No</th>');
                        $table.find('tbody tr').each(function (index) {
                            $(this).prepend('<td style="text-align:center;">' + (index + 1) + '</td>');
                        });
                        $body.css('font-size', '12pt');
                    },
                    action: function (e, dt, button, config) {
                        var selected = dt.rows().nodes().to$().find('input.rowCheckbox:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(true); } catch (err) { }

                        try {
                            if (!$.fn.dataTable.ext.buttons.print._orig) {
                                $.fn.dataTable.ext.buttons.print._orig = $.fn.dataTable.ext.buttons.print.action || $.fn.dataTable.ext.buttons.print;
                            }
                            $.fn.dataTable.ext.buttons.print._orig.call(this, e, dt, button, config);
                        } catch (err) {
                            setTimeout(function () { try { btnApi.processing(false); } catch (e) { } }, 300);
                            throw err;
                        }

                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 2000);
                    }
                },
                //PDF
                {
                    extend: 'pdfHtml5',
                    text: '<i class="bi bi-file-earmark-pdf text-danger fs-5"></i>',
                    titleAttr: 'PDF',
                    title: 'GRN Summary Report',
                    orientation: 'landscape',
                    pageSize: 'A4',
                    exportOptions: {
                        columns: [2, 3, 4, 5, 6, 7],
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        },
                        format: {
                            body: function (data, rowIdx, colIdx, node) {
                                if (colIdx === 1) return rowIdx + 1; // Sr No
                                return stripHtml(data); // Fixed: Use stripHtml function
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        var selected = $('.rowCheckbox:checked').length;
                        var btnApi = dt.button(button);

                        // ✅ If no rows selected
                        if (selected === 0) {
                            toastr.warning("Please select at least one row before exporting!");
                            btnApi.processing(false);
                            return;
                        }

                        // ✅ Start spinner
                        btnApi.processing(true);

                        // ✅ Patch pdfMake to stop spinner after download
                        if (window.pdfMake && pdfMake.createPdf && !pdfMake._patchedForDT) {
                            (function () {
                                var origCreate = pdfMake.createPdf;
                                pdfMake.createPdf = function (docDefinition) {
                                    var pdfDoc = origCreate.call(pdfMake, docDefinition);
                                    var origDownload = pdfDoc.download;
                                    pdfDoc.download = function (filename, cb) {
                                        origDownload.call(pdfDoc, filename);
                                        // Stop spinner after small delay
                                        setTimeout(() => {
                                            try { btnApi.processing(false); } catch (err) { }
                                            if (typeof cb === 'function') cb();
                                        }, 50);
                                    };
                                    return pdfDoc;
                                };
                                pdfMake._patchedForDT = true;
                            })();
                        }
                        // ✅ Ensure DataTables has the original action stored
                        if (!$.fn.dataTable.ext.buttons.pdfHtml5.__originalAction) {
                            $.fn.dataTable.ext.buttons.pdfHtml5.__originalAction =
                                $.fn.dataTable.ext.buttons.pdfHtml5.action;
                        }

                        // ✅ Call DataTables' built-in export
                        $.fn.dataTable.ext.buttons.pdfHtml5.__originalAction.call(this, e, dt, button, config);

                        // ✅ Safety stop if stuck
                        setTimeout(() => { try { btnApi.processing(false); } catch (err) { } }, 3000);
                    },

                    customize: function (doc) {
                        // ---------- PAGE SETTINGS ----------
                        doc.pageSize = 'A4';
                        doc.pageOrientation = 'landscape';
                        doc.defaultStyle.fontSize = 9;
                        doc.defaultStyle.alignment = 'center';
                        doc.styles.tableHeader.fontSize = 10;
                        doc.styles.tableHeader.fillColor = '#343a40';
                        doc.styles.tableHeader.color = 'white';
                        doc.styles.tableHeader.bold = true;
                        doc.styles.tableHeader.alignment = 'center';
                        // ---------- GENERATED DATE ----------
                        doc.content.splice(1, 0, {
                            text: `Generated Date: ${moment().format("DD-MM-YYYY")}`,
                            alignment: 'center',
                            margin: [0, 0, 0, 12],
                            fontSize: 9,
                            italics: true
                        });

                        // ---------- FIND TABLE ----------
                        function findTableNodeIndex(doc) {
                            for (var i = 0; i < doc.content.length; i++) {
                                if (doc.content[i].table) return i;
                            }
                            return -1;
                        }

                        var tableNodeIndex = findTableNodeIndex(doc);
                        if (tableNodeIndex < 0) return;
                        var tableNode = doc.content[tableNodeIndex];
                        if (!tableNode || !tableNode.table || !tableNode.table.body) return;

                        // ---------- ADD SR NO ----------
                        var headerRow = tableNode.table.body[0];
                        headerRow.unshift({ text: 'Sr No', style: 'tableHeader' });

                        for (var r = 1; r < tableNode.table.body.length; r++) {
                            var row = tableNode.table.body[r];
                            row.unshift({ text: String(r), alignment: 'center' });
                        }

                        // ---------- SET COLUMN WIDTHS ----------
                        tableNode.table.widths = ['5%', '12%', '15%', '15%', '10%', '10%', '9%', '9%'];

                        // ---------- STYLE CELLS ----------
                        for (var i = 1; i < tableNode.table.body.length; i++) {
                            var row = tableNode.table.body[i];
                            for (var j = 0; j < row.length; j++) {
                                var cell = row[j];
                                var txt = stripHtml(cell.text || cell);
                                row[j] = { text: txt, fontSize: 8, margin: [2, 3, 2, 3], alignment: j === 3 ? 'left' : 'center' };
                            }
                        }

                        // ---------- ADD BORDERS ----------
                        tableNode.layout = {
                            hLineWidth: () => 0.5,
                            vLineWidth: () => 0.5,
                            hLineColor: () => '#aaa',
                            vLineColor: () => '#aaa',
                            paddingLeft: () => 4,
                            paddingRight: () => 4,
                            paddingTop: () => 3,
                            paddingBottom: () => 3
                        };
                    }
                },
                //Excel
                {
                    extend: 'excelHtml5',
                    text: '<i class="bi bi-file-earmark-excel-fill text-success fs-5"></i>',
                    titleAttr: 'Export Excel',
                    filename: `Purchase_Order_Report_${moment().format("YYYY-MM-DD_HH-mm-ss")}`,

                    exportOptions: {
                        columns: ':visible',
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        }
                    },

                    action: function (e, dt, button, config) {
                        const selectedRows = dt.rows().nodes().to$().find('input.rowCheckbox:checked');
                        const btnApi = dt.button(button);

                        if (selectedRows.length === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(true); } catch (err) { }

                        const selectedData = [];
                        let srNo = 1;

                        selectedRows.each(function () {
                            const tr = $(this).closest('tr');
                            const rowData = dt.row(tr).data();
                            if (!rowData) return;

                            selectedData.push([
                                srNo++,
                                rowData.GRNCode || '',
                                rowData.POCode || '',
                                rowData.VendorName || '',
                                rowData.CompanyName || '',
                                rowData.AddedDate
                                    ? new Date(rowData.AddedDate).toLocaleDateString("en-GB")
                                    : '',
                                rowData.TotalAmount || ''
                            ]);
                        });
                        // Format date as DD/MM/YYYY
                        const today = new Date();
                        const formattedDate = String(today.getDate()).padStart(2, '0') + '/' +
                            String(today.getMonth() + 1).padStart(2, '0') + '/' +
                            today.getFullYear();

                        // Create temporary table / DataTable for Excel export
                        const tempDt = $('<table>').DataTable({
                            data: selectedData,
                            columns: [
                                { title: 'Sr.No' },
                                { title: 'GRN Code' },
                                { title: 'PO Code' },
                                { title: 'Vendor Name' },
                                { title: 'Vendor Company' },
                                { title: 'Added Date' },
                                { title: 'Total Amount' },
                            ],
                            dom: 'Bfrtip',
                            buttons: [{
                                extend: 'excelHtml5',
                                title: null,
                                filename: `GRN_Summary_Report_${moment().format("YYYY-MM-DD_HH-mm-ss")}`,
                                customize: function (xlsx) {
                                    const sheet = xlsx.xl.worksheets['sheet1.xml'];
                                    const sheetData = $('sheetData', sheet);
                                    // 1️⃣ Shift existing rows down by 3
                                    $('row', sheetData).each(function () {
                                        const $row = $(this);
                                        const r = parseInt($row.attr('r'), 10);
                                        const newR = r + 3;
                                        $row.attr('r', newR);
                                        // Update each cell reference in this row
                                        $row.find('c').each(function () {
                                            const $c = $(this);
                                            const cellRef = $c.attr('r');
                                            if (!cellRef) return;
                                            const col = cellRef.replace(/\d+$/, '');
                                            const rowNum = parseInt(cellRef.match(/\d+$/)[0], 10);
                                            $c.attr('r', col + (rowNum + 3));
                                        });
                                    });
                                    // 2️⃣ Create centered title & date rows (with style index 51)
                                    const titleCell = `<row r="1"><c r="A1" t="inlineStr" s="51"><is><t>GRN Summary Report</t></is></c></row>`;
                                    const dateCell = `<row r="2"><c r="A2" t="inlineStr" s="51"><is><t>Generated Date: ${formattedDate}</t></is></c></row>`;
                                    const blankRow = `<row r="3"></row>`;
                                    // Add them at the top
                                    sheetData.prepend(blankRow);
                                    sheetData.prepend(dateCell);
                                    sheetData.prepend(titleCell);
                                    // 3️⃣ Merge A1:H1 and A2:H2 (center across columns)
                                    const mergeRef1 = 'A1:H1';
                                    const mergeRef2 = 'A2:H2';
                                    if ($('mergeCells', sheet).length === 0) {
                                        const mergeXml = `<mergeCells count="2"><mergeCell ref="${mergeRef1}"/><mergeCell ref="${mergeRef2}"/></mergeCells>`;
                                        $('sheetData', sheet).after(mergeXml);
                                    } else {
                                        $('mergeCells', sheet).append(`<mergeCell ref="${mergeRef1}"/>`);
                                        $('mergeCells', sheet).append(`<mergeCell ref="${mergeRef2}"/>`);
                                        const currentCount = parseInt($('mergeCells', sheet).attr('count') || '0', 10);
                                        $('mergeCells', sheet).attr('count', currentCount + 2);
                                    }
                                    // 4️⃣ Add centered style (s="51") if not defined already
                                    const styles = xlsx.xl['styles.xml'];
                                    const cellXfs = $('cellXfs', styles);
                                    if (cellXfs.find('xf[applyAlignment]').length === 0) {
                                        cellXfs.append(`<xf xfId="0" applyAlignment="1"><alignment horizontal="center" vertical="center"/></xf>`);
                                        const count = parseInt(cellXfs.attr('count'), 10) || 0;
                                        cellXfs.attr('count', count + 1);
                                    }
                                    // 5️⃣ Optional: widen columns
                                    if ($('cols', sheet).length === 0) {
                                        let colsXml = '<cols>';
                                        for (let i = 1; i <= 8; i++) {
                                            colsXml += `<col min="${i}" max="${i}" width="20" customWidth="1"/>`;
                                        }
                                        colsXml += '</cols>';
                                        $('sheetPr', sheet).after(colsXml);
                                    }
                                }
                            }],
                            destroy: true,
                            paging: false,
                            searching: false,
                            info: false
                        });
                        // Trigger excel export
                        tempDt.button('.buttons-excel').trigger();
                        setTimeout(() => { try { btnApi.processing(false); } catch (err) { } }, 800);
                    }
                },
                //CSV
                {
                    extend: 'csvHtml5',
                    text: '<i class="bi bi-filetype-csv text-success fs-5"></i>',
                    title: '',
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        },
                        columns: [1, 2, 3, 4, 5, 6, 7],
                        modifier: { search: 'applied', order: 'applied' },
                        format: {
                            body: (function () {
                                let srCounter = 1;
                                return function (data, rowIdx, colIdx, node) {
                                    if (colIdx === 1) return srCounter++;
                                    return $('<div>').html(data).text().trim() || '';
                                };
                            })()
                        }
                    },
                    action: function (e, dt, button, config) {
                        const $rows = dt.rows().nodes().to$();
                        const selected = $rows.find('input.rowCheckbox:checked').length;
                        const btnApi = dt.button(button);

                        if (selected === 0) {
                            toastr.warning("Please select at least one row before exporting!");
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }
                        try { btnApi.processing(true); } catch (err) { }

                        if (!$.fn.dataTable.ext.buttons.csvHtml5._orig) {
                            $.fn.dataTable.ext.buttons.csvHtml5._orig = $.fn.dataTable.ext.buttons.csvHtml5.action;
                        }
                        const self = this;
                        const modifiedAction = function (e, dt, button, config) {
                            const originalDownload = $.fn.DataTable.fileSave;
                            $.fn.DataTable.fileSave = function (content, fileName, options) {
                                const result = originalDownload.call(this, content, fileName, options);
                                setTimeout(() => {
                                    try {
                                        btnApi.processing(false);
                                    } catch (err) {
                                        console.log('Spinner stopped');
                                    }
                                }, 500);

                                return result;
                            };

                            try {
                                $.fn.dataTable.ext.buttons.csvHtml5._orig.call(self, e, dt, button, config);
                            } catch (error) {
                                setTimeout(() => {
                                    try {
                                        btnApi.processing(false);
                                    } catch (err) { }
                                }, 500);
                                throw error;
                            } finally {
                                setTimeout(() => {
                                    $.fn.DataTable.fileSave = originalDownload;
                                }, 1000);
                            }
                        };
                        modifiedAction.call(this, e, dt, button, config);
                    }
                }
            ],
        });

        // Select All
        $(document).on("change", "#selectAll", function () {
            $(".rowCheckbox").prop("checked", this.checked);
        });

        $(document).on("change", ".rowCheckbox", function () {
            $("#selectAll").prop("checked", $(".rowCheckbox:checked").length === $(".rowCheckbox").length);
        });

        // Fixed: Add event delegation for view items buttons
        $(document).on('click', '.viewItemsBtn', function() {
            const grnCode = $(this).data('grn');
            $('#grnItemsModalLabel').text("GRN Items List");
            loadGRNItems(grnCode);
            $('#grnItemsModal').modal('show');
        });
    }

    // ---------------- LOAD GRN ITEMS ----------------
    function loadGRNItems(GRNCode) {
        if (itemsTable) {
            try { itemsTable.clear().destroy(); } catch (e) {}
            $('#GRNItemsTablePSM tbody').empty();
        }

        itemsTable = $('#GRNItemsTablePSM').DataTable({
            dom: '<"d-flex justify-content-between align-items-center mb-2"Bf>rt<"d-flex justify-content-between align-items-center"i p>',
            responsive: true,
            processing: true,
            ajax: { url: '@Url.Action("GRNItemsPSM","GRN")', type: 'GET', data: { GRNCode: GRNCode }, dataSrc: 'data' },
            columns: [
                { data: null, orderable: false, render: d => '<input type="checkbox" class="rowCheckbox1" value="' + (d.ItemName || '') + '"/>' },
                { data: null, render: (d, t, r, m) => m.row + 1 },
                { data: "ItemName" },
                { data: "CostPerUnit", render: d => d ? '<i class="bi bi-currency-rupee text-secondary"></i> ' + parseFloat(d).toLocaleString("en-IN", { minimumFractionDigits: 2 }) : "-" },
                { data: "UnitQuantity", render: $.fn.dataTable.render.number(',', '.', 2) },
                { data: "Discount" },
                { data: "TaxRate" },
                { data: "FinalAmount", render: d => d ? '<i class="bi bi-currency-rupee text-secondary"></i> ' + parseFloat(d).toLocaleString("en-IN", { minimumFractionDigits: 2 }) : "-" },
                { data: 'IsQuality', render: d => d === 'Yes' ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-danger">No</span>' }
            ],
            ordering: false,

            buttons: [
                // Print
                {
                    extend: 'print',
                    text: '<i class="bi bi-printer-fill text-dark fs-5"></i>',
                    titleAttr: 'Print',
                    title: 'Total PO Items',
                    exportOptions: {
                        columns: [2, 3, 4, 5, 6, 7, 8],
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox1').prop('checked');
                        }
                    },
                    customize: function (win) {
                        var $body = $(win.document.body);
                        // Add styling
                        $body.append(`<style>thead th {
            background-color: black !important;
            color: white !important;
            text-align: center !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            }
            table { border-collapse: collapse !important; width: 100% !important; }
            td, th { border: 1px solid #000 !important; padding: 6px !important; }
            </style>`);
                        $body.find('h1').css('text-align', 'center');
                        var today = new Date();
                        var formattedDate = String(today.getDate()).padStart(2, '0') + '/' +
                            String(today.getMonth() + 1).padStart(2, '0') + '/' +
                            today.getFullYear();
                        $body.find('h1').after('<div style="text-align:center;font-style:italic;font-size:10pt;margin-bottom:12px;">Generated Date: ' + formattedDate + '</div>');
                        var $table = $body.find('table');
                        $table.addClass('table table-bordered table-striped').css('width', '100%');
                        $table.find('thead tr').prepend('<th>Sr No</th>');
                        $table.find('tbody tr').each(function (index) {
                            $(this).prepend('<td style="text-align:center;">' + (index + 1) + '</td>');
                        });
                        $body.css('font-size', '12pt');
                    },
                    action: function (e, dt, button, config) {
                        var selected = dt.rows().nodes().to$().find('input.rowCheckbox1:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(true); } catch (err) { }

                        try {
                            if (!$.fn.dataTable.ext.buttons.print._orig) {
                                $.fn.dataTable.ext.buttons.print._orig = $.fn.dataTable.ext.buttons.print.action || $.fn.dataTable.ext.buttons.print;
                            }
                            $.fn.dataTable.ext.buttons.print._orig.call(this, e, dt, button, config);
                        } catch (err) {
                            setTimeout(function () { try { btnApi.processing(false); } catch (e) { } }, 300);
                            throw err;
                        }

                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 2000);
                    }
                },
                // PDF
                {
                    extend: 'pdfHtml5',
                    text: '<i class="bi bi-file-earmark-pdf text-danger fs-5"></i>',
                    titleAttr: 'PDF',
                    title: 'GRN Items Details',
                    orientation: 'landscape',
                    pageSize: 'A4',
                    exportOptions: {
                        columns: [2, 3, 4, 5, 6, 7, 8],
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox1').prop('checked');
                        },
                        format: {
                            body: function (data, rowIdx, colIdx, node) {
                                return stripHtml(data);
                            }
                        }
                    },
                    customize: function (doc) {
                        doc.pageSize = 'A4';
                        doc.pageOrientation = 'landscape';
                        doc.defaultStyle.fontSize = 9;
                        doc.styles.tableHeader.fontSize = 10;
                        doc.styles.tableHeader.fillColor = '#343a40';
                        doc.styles.tableHeader.color = 'white';
                        doc.styles.tableHeader.bold = true;
                        doc.styles.tableHeader.alignment = 'center';

                        // Insert generated date
                        doc.content.splice(1, 0, {
                            text: `Generated Date: ${moment().format("DD/MM/YYYY")}`,
                            alignment: 'center',
                            margin: [0, 0, 0, 12],
                            fontSize: 9,
                            italics: true
                        });

                        // Find table and add Sr No as first column
                        function findTableNodeIndex(doc) {
                            for (var i = 0; i < doc.content.length; i++) {
                                if (doc.content[i].table) return i;
                            }
                            return -1;
                        }
                        var tableNodeIndex = findTableNodeIndex(doc);
                        if (tableNodeIndex < 0) return;
                        var tableNode = doc.content[tableNodeIndex];
                        if (!tableNode || !tableNode.table || !tableNode.table.body) return;
                        tableNode.table.body[0].unshift({ text: 'Sr No', style: 'tableHeader' });
                        for (var r = 1, cnt = 1; r < tableNode.table.body.length; r++, cnt++) {
                            tableNode.table.body[r].unshift({ text: String(cnt), alignment: 'center' });
                        }

                        tableNode.table.widths = ['5%', '15%', '15%', '15%', '15%', '10%', '12%', '12%'];

                        tableNode.layout = {
                            hLineWidth: function () { return 0.5; },
                            vLineWidth: function () { return 0.5; },
                            hLineColor: function () { return '#aaa'; },
                            vLineColor: function () { return '#aaa'; },
                            paddingLeft: function () { return 4; },
                            paddingRight: function () { return 4; },
                            paddingTop: function () { return 3; },
                            paddingBottom: function () { return 3; }
                        };
                    },
                    action: function (e, dt, button, config) {
                        var selected = dt.rows().nodes().to$().find('input.rowCheckbox1:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(true); } catch (err) { }
                        if (window.pdfMake && pdfMake.createPdf && !pdfMake._patchedForDT) {
                            (function () {
                                var origCreate = pdfMake.createPdf;
                                pdfMake.createPdf = function (docDefinition) {
                                    var pdfDoc = origCreate.call(pdfMake, docDefinition);
                                    var origDownload = pdfDoc.download;
                                    pdfDoc.download = function (filename, cb) {
                                        origDownload.call(pdfDoc, filename);
                                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 1000);
                                        if (typeof cb === 'function') cb();
                                    };
                                    return pdfDoc;
                                };
                                pdfMake._patchedForDT = true;
                            })();
                        }

                        // call original
                        if (!$.fn.dataTable.ext.buttons.pdfHtml5._orig) {
                            $.fn.dataTable.ext.buttons.pdfHtml5._orig = $.fn.dataTable.ext.buttons.pdfHtml5.action;
                        }
                        $.fn.dataTable.ext.buttons.pdfHtml5._orig.call(this, e, dt, button, config);

                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 2000);
                    }
                },
                //Excel
                {
                    extend: 'excelHtml5',
                    text: '<i class="bi bi-file-earmark-excel-fill text-success fs-5"></i>',
                    titleAttr: 'Export Excel',
                    filename: `Total_Item_List_${moment().format("YYYY-MM-DD_HH-mm-ss")}`,

                    exportOptions: {
                        columns: ':visible'
                    },
                    action: function (e, dt, button, config) {
                        const selectedRows = dt.rows().nodes().to$().find('input.rowCheckbox1:checked');
                        const btnApi = dt.button(button);

                        if (selectedRows.length === 0) {
                            toastr.warning("Please select at least one row before exporting!");
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }
                        try { btnApi.processing(true); } catch (err) { }

                        const selectedData = [];
                        let srNo = 1;

                        selectedRows.each(function () {
                            const tr = $(this).closest('tr');
                            const rowData = dt.row(tr).data();
                            if (!rowData) return;

                            selectedData.push([
                                srNo++,
                                rowData.ItemName || '',
                                rowData.CostPerUnit ? parseFloat(rowData.CostPerUnit).toLocaleString("en-IN", { minimumFractionDigits: 2 }) : '',
                                rowData.UnitQuantity || '',
                                rowData.Discount || '',
                                rowData.TaxRate || '',
                                rowData.IsQuality || '',
                                rowData.FinalAmount ? parseFloat(rowData.FinalAmount).toLocaleString("en-IN", { minimumFractionDigits: 2 }) : ''
                            ]);
                        });
                        const today = new Date();
                        const formattedDate = String(today.getDate()).padStart(2, '0') + '/' +
                            String(today.getMonth() + 1).padStart(2, '0') + '/' +
                            today.getFullYear();
                        const tempDt = $('<table>').DataTable({
                            data: selectedData,
                            columns: [
                                { title: 'Sr.No' },
                                { title: 'Item Name' },
                                { title: 'Cost/Unit' },
                                { title: 'Quantity' },
                                { title: 'Discount' },
                                { title: 'Tax Rate' },
                                { title: 'Is Quality' },
                                { title: 'Final Amount' }
                            ],
                            dom: 'Bfrtip',
                            buttons: [{
                                extend: 'excelHtml5',
                                title: null,
                                filename: `Total_Item_List_${moment().format("YYYY-MM-DD_HH-mm-ss")}`,
                                customize: function (xlsx) {
                                    const sheet = xlsx.xl.worksheets['sheet1.xml'];
                                    const sheetData = $('sheetData', sheet);
                                    $('row', sheetData).each(function () {
                                        const $row = $(this);
                                        const r = parseInt($row.attr('r'), 10);
                                        const newR = r + 3;
                                        $row.attr('r', newR);
                                        $row.find('c').each(function () {
                                            const $c = $(this);
                                            const cellRef = $c.attr('r');
                                            if (!cellRef) return;
                                            const col = cellRef.replace(/\d+$/, '');
                                            const rowNum = parseInt(cellRef.match(/\d+$/)[0], 10);
                                            $c.attr('r', col + (rowNum + 3));
                                        });
                                    });
                                    const blankRow = `<row r="3"></row>`;
                                    sheetData.prepend(blankRow);
                                    const mergeRef1 = 'A1:H1';
                                    const mergeRef2 = 'A2:H2';
                                    if ($('mergeCells', sheet).length === 0) {
                                        const mergeXml = `<mergeCells count="2"><mergeCell ref="${mergeRef1}"/><mergeCell ref="${mergeRef2}"/></mergeCells>`;
                                        $('sheetData', sheet).after(mergeXml);
                                    } else {
                                        $('mergeCells', sheet).append(`<mergeCell ref="${mergeRef1}"/>`);
                                        $('mergeCells', sheet).append(`<mergeCell ref="${mergeRef2}"/>`);
                                        const currentCount = parseInt($('mergeCells', sheet).attr('count') || '0', 10);
                                        $('mergeCells', sheet).attr('count', currentCount + 2);
                                    }
                                    const styles = xlsx.xl['styles.xml'];
                                    const fonts = $('fonts', styles);
                                    const cellXfs = $('cellXfs', styles);
                                    if (fonts.length === 0) {
                                        $('styleSheet', styles).append('<fonts count="0"></fonts>');
                                    }
                                    if (cellXfs.length === 0) {
                                        $('styleSheet', styles).append('<cellXfs count="0"></cellXfs>');
                                    }
                                    const fontsRef = $('fonts', styles);
                                    const cellXfsRef = $('cellXfs', styles);
                                    const fontsCount = parseInt(fontsRef.attr('count') || '0', 10);
                                    fontsRef.append(`<font><b/><sz val="14"/><name val="Calibri"/></font>`);
                                    fontsRef.attr('count', fontsCount + 1);
                                    const newFontId = fontsCount;
                                    const cellXfsCount = parseInt(cellXfsRef.attr('count') || '0', 10);
                                    cellXfsRef.append(`<xf xfId="0" applyAlignment="1" applyFont="1"><alignment horizontal="center" vertical="center"/><fontId val="${newFontId}"/></xf>`);
                                    cellXfsRef.append(`<xf xfId="0" applyAlignment="1"><alignment horizontal="center" vertical="center"/></xf>`);
                                    cellXfsRef.attr('count', cellXfsCount + 2);
                                    const titleStyleIndex = cellXfsCount;
                                    const dateStyleIndex = cellXfsCount + 1;
                                    const titleCell = `<row r="1"><c r="A1" t="inlineStr" s="${titleStyleIndex}"><is><t>Total PO Items</t></is></c></row>`;
                                    const dateCell = `<row r="2"><c r="A2" t="inlineStr" s="${dateStyleIndex}"><is><t>Generated Date: ${formattedDate}</t></is></c></row>`;
                                    sheetData.prepend(dateCell);
                                    sheetData.prepend(titleCell);
                                    if ($('cols', sheet).length === 0) {
                                        let colsXml = '<cols>';
                                        for (let i = 1; i <= 8; i++) {
                                            colsXml += `<col min="${i}" max="${i}" width="20" customWidth="1"/>`;
                                        }
                                        colsXml += '</cols>';
                                        if ($('sheetPr', sheet).length) {
                                            $('sheetPr', sheet).after(colsXml);
                                        } else {
                                            $(sheetData).before(colsXml);
                                        }
                                    }
                                }
                            }],
                            destroy: true,
                            paging: false,
                            searching: false,
                            info: false
                        });
                        tempDt.button('.buttons-excel').trigger();
                        setTimeout(() => { try { btnApi.processing(false); } catch (err) { } }, 800);
                    }
                },
                //CSV
                {
                    extend: 'csvHtml5',
                    text: '<i class="bi bi-filetype-csv text-success fs-5"></i>',
                    title: '',
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox1').prop('checked');
                        },
                        columns: [1, 2, 3, 4, 5, 6, 7, 8],
                        modifier: { search: 'applied', order: 'applied' },
                        format: {
                            body: (function () {
                                let srCounter = 1;
                                return function (data, rowIdx, colIdx, node) {
                                    if (colIdx === 1) return srCounter++;
                                    return $('<div>').html(data).text().trim() || '';
                                };
                            })()
                        }
                    },
                    action: function (e, dt, button, config) {
                        const $rows = dt.rows().nodes().to$();
                        const selected = $rows.find('input.rowCheckbox1:checked').length;
                        const btnApi = dt.button(button);

                        if (selected === 0) {
                            toastr.warning("Please select at least one row before exporting!");
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }
                        try { btnApi.processing(true); } catch (err) { }

                        if (!$.fn.dataTable.ext.buttons.csvHtml5._orig) {
                            $.fn.dataTable.ext.buttons.csvHtml5._orig = $.fn.dataTable.ext.buttons.csvHtml5.action;
                        }
                        const self = this;
                        const modifiedAction = function (e, dt, button, config) {
                            const originalDownload = $.fn.DataTable.fileSave;
                            $.fn.DataTable.fileSave = function (content, fileName, options) {
                                const result = originalDownload.call(this, content, fileName, options);
                                setTimeout(() => {
                                    try {
                                        btnApi.processing(false);
                                    } catch (err) {
                                        console.log('Spinner stopped');
                                    }
                                }, 500);

                                return result;
                            };

                            try {
                                $.fn.dataTable.ext.buttons.csvHtml5._orig.call(self, e, dt, button, config);
                            } catch (error) {
                                setTimeout(() => {
                                    try {
                                        btnApi.processing(false);
                                    } catch (err) { }
                                }, 500);
                                throw error;
                            } finally {
                                setTimeout(() => {
                                    $.fn.DataTable.fileSave = originalDownload;
                                }, 1000);
                            }
                        };
                        modifiedAction.call(this, e, dt, button, config);
                    }
                }
            ],
        });

        // Fixed: Add event handler for select all items checkbox
        $('#selectAllItems').on('change', function() {
            $('.rowCheckbox1').prop('checked', this.checked);
        });
    }

    // === Load Total GRN ===
    function loadTotalGRN(fromDate, toDate) {
        $.ajax({
            url: '@Url.Action("GRNPieChartPSM","GRN")',
            data: { fromDate, toDate },
            success: function (response) {
                const total = parseInt(response.TotalGRN) || 0;
                $("#totalGRNDisplay").text(total.toLocaleString("en-IN"));
            },
            error: () => $("#totalGRNDisplay").text("0")
        });
    }

    // === Document Ready ===
    $(document).ready(function () {
        initTable();
        loadTotalGRN(null, null);
    });
</script>