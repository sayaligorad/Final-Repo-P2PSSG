@{
    ViewBag.Title = "Purchase Order History";
}


<style>
    /* Compact table */
    .dataTable td, .dataTable th {
        padding: 0.35rem 0.5rem !important;
        font-size: 0.78rem !important;
        vertical-align: middle;
    }
    td, th {
        text-align: center !important;
    }

    /* Small action buttons */
    .btn-delete {
        padding: 2px 6px;
        font-size: 0.75rem;
    }

        /* Allow Bootstrap fs-* to override */
        .btn-delete i {
            font-size: inherit;
        }

    .btnViewPO {
        padding: 2px 6px !important;
        font-size: 0.70rem !important;
    }

        .btnViewPO i {
            font-size: 0.75rem !important;
        }


</style>

<div class="container">
    <div class="card shadow-lg border-0 rounded-4 p-4">

        <!-- Header with Datepicker -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
            <div class="mb-2">
                <div class="input-group" style="max-width: 280px;">
                    <span class="input-group-text bg-primary text-white">
                        <i class="bi bi-calendar-date"></i>
                    </span>
                    <input type="text" id="FirstreportrangePSM" class="form-control" readonly placeholder="Select Date Range" />
                </div>
            </div>

            <div class="text-center">
                <h3 class="text-primary mb-0">
                   Purchase Order Count by Vendor
                </h3>
            </div>
            <div class="mb-1" style="width:280px;"></div>
        </div>

        <!-- Donut Chart -->
        <div class="position-relative border rounded-3 p-3 shadow-sm mb-4">
            <div class="position-absolute top-0 end-0 p-3 text-end">
                <h6 class="text-muted mb-1">Total Approved POs</h6>
                <h2 id="poTotalCountPSM" class="text-success fw-bold mb-0">0</h2>
            </div>
            <div class="w-80" id="poDonutChartPSM" style="min-height: 250px;"></div>
        </div>

        <!-- Approved PO List -->
        <h3 class="text-primary text-center">Purchase Orders</h3>
        <div class="table-responsive">
            <table id="approvedPOListTablePSM" class="table table-striped text-center table-bordered w-100">
                <thead class="table-dark text-center">
                    <tr>
                        <th><input type="checkbox" id="selectAll" /></th>
                        <th class="text-center">SR.No</th>
                        <th class="text-center">PO Code</th>
                        <th class="text-center">RQ Code</th>
                        <th class="text-center">Vendor Name</th>
                        <th class="text-center">Company Name</th>
                        <th class="text-center">Approved Date</th>
                        <th class="text-center">Total Amount</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody class="text-center"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- PO Items Modal -->
<div class="modal fade" id="poItemsModal" tabindex="-1" aria-labelledby="poItemsModalLabel" data-bs-backdrop="true" data-bs-keyboard="false" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="card-header bg-primary text-white d-flex justify-content-center align-items-center rounded-top p-1">
                <h3 class="modal-title fw-bold text-white mb-0 fs-5" id="poItemsModalLabel">Total PO Items</h3>
                <button type="button"
                        class="btn-close btn-close-white position-absolute top-0 end-0 m-2 fs-5"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table id="poItemsTablePSM" class="table table-striped text-center table-bordered w-100">
                    <thead class="table-dark text-center">
                        <tr>
                            <th><input type="checkbox" id="selectAllChild" /></th>
                            <th  class="text-center">SR.No</th>
                            <th  class="text-center">Item Name</th>
                            <th  class="text-center">Cost Per Unit</th>
                            <th  class="text-center">Unit Quantity</th>
                            <th  class="text-center">Discount</th>
                            <th  class="text-center">Tax Rate</th>
                            <th  class="text-center">Quality Check</th>
                            <th  class="text-center">Final Amount</th>
                        </tr>
                    </thead>
                    <tbody  class="text-center"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var poTablePSM = null;
    var poItemsTablePSM = null;

    // Toastr config
    toastr.options = {
        closeButton: true, progressBar: true, newestOnTop: true,
        positionClass: "toast-top-right", preventDuplicates: true, timeOut: 3000
    };

    // ----------------- Helper functions -----------------
    function stripHtml(html) {
        return $('<div>').html(html).text();
    }

    function showToast(message) {
        toastr.info(message);
    }

    function showExportToast() {
        toastr.warning("Please select at least one row to export.");
    }

    // Recalculate SrNo for exports (only for selected rows)
    function getExportSrNo(rowIdx, tbl) {
        var allRows = tbl.rows({ order: 'applied', search: 'applied' }).nodes().toArray();
        var checkedRows = allRows.filter(function (row) {
            return $(row).find('input[type="checkbox"].rowCheckbox').prop('checked');
        });
        var pos = checkedRows.findIndex(function (row) {
            return tbl.row(row).index() === rowIdx;
        });
        return pos >= 0 ? pos + 1 : '';
    }

    // ------------------- DATE PICKER -------------------
    $(document).ready(function () {
        $('#FirstreportrangePSM').daterangepicker({
            autoUpdateInput: false,
            opens: "right",
            drops: "down",
            locale: {
                format: 'DD/MM/YYYY',
                cancelLabel: 'Clear'
            },
            ranges: {
                'Today': [moment(), moment()],
                'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                'Last 1 Month': [moment().subtract(1, 'months').startOf('day'), moment()],
                'Last 3 Months': [moment().subtract(3, 'months').startOf('day'), moment()],
                'Last 1 Year': [moment().subtract(12, 'months').startOf('day'), moment()]
            }
        }, function (start, end) {
            $('#FirstreportrangePSM').val(start.format('DD/MM/YYYY') + ' - ' + end.format('DD/MM/YYYY'));
            initPOTablePSM(start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'));
            loadPOChartPSM(start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'));
        });

        $('#FirstreportrangePSM').on('cancel.daterangepicker', function () {
            $(this).val('');
            initPOTablePSM();
            loadPOChartPSM();
        });

        initPOTablePSM();
        loadPOChartPSM();
    });

   // ------------------- PARENT DATATABLE -------------------
    function initPOTablePSM(fromDate, toDate) {
        try {
            if (poTablePSM) { poTablePSM.destroy(); $("#approvedPOListTablePSM tbody").empty(); }

            poTablePSM = $("#approvedPOListTablePSM").DataTable({
                dom: '<"d-flex justify-content-between align-items-center mb-2"Bf>rt<"d-flex justify-content-between align-items-center"i p>',
                responsive: true, processing: true,
                ajax: {
                    url: '@Url.Action("ApprovedPOListsPSM", "GRN")',
                    type: "GET", data: { startDate: fromDate || "", endDate: toDate || "" },
                    dataSrc: "data"
                },
                columns: [
                    { data: null, render: function () { return '<input type="checkbox" class="rowCheckbox"/>'; } },
                    { data: null, className: 'text-center', render: function (d, t, r, meta) { return meta.row + 1; } }, // S.No (index 1)
                    { data: 'POCode', className: 'text-center' }, // index 2
                    { data: 'RQNO', className: 'text-center' },   // index 3
                    { data: 'VendorName', className: 'text-center' }, // index 4
                    { data: 'VendorCompanyName', className: 'text-center' }, // index 5
                    { data: 'ApprovedRejectedDate', className: 'text-center', render: function (d) { return d ? new Date(d).toLocaleDateString("en-GB") : ""; } }, //6
                    { data: 'TotalAmount', className: 'text-center', render: function (d) { return d ? `<i class="bi bi-currency-rupee"></i> ${d}` : "-"; } }, //7
                    {
                        data: "StatusName",
                        render: function (d) {
                            if (d === "Open") return '<span class="badge bg-primary fw-semibold">' + d + '</span>';
                            if (d === "Approved") return '<span class="badge bg-success fw-semibold">' + d + '</span>';
                            return d || '';
                        }
                    }, //8
                    { data: null, render: function (d) { return `<button class="btn btn-primary btnViewPO square-btn square-pill" data-pocode="${d.POCode}"><i class="bi bi-eye"></i></button>`; } } //9
                ],
                ordering: false,
                buttons: [

                //Print
                {
                    extend: 'print',
                    text: '<i class="bi bi-printer-fill text-dark fs-5"></i>',
                    titleAttr: 'Print',
                    title: 'Approved And Open Purchase Orders',
                    exportOptions: {
                        columns: [2, 3, 4, 5, 6, 7, 8],
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        }
                    },
                    customize: function (win) {
                        var $body = $(win.document.body);

                        // Add styling
                        $body.append(`<style>thead th {
                        background-color: black !important;
                        color: white !important;
                        text-align: center !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                        }
                        table { border-collapse: collapse !important; width: 100% !important; }
                        td, th { border: 1px solid #000 !important; padding: 6px !important; }
                        </style>`);
                        $body.find('h1').css('text-align', 'center');
                        var today = new Date();
                        var formattedDate = String(today.getDate()).padStart(2, '0') + '/' +
                            String(today.getMonth() + 1).padStart(2, '0') + '/' +
                            today.getFullYear();
                        $body.find('h1').after('<div style="text-align:center;font-style:italic;font-size:10pt;margin-bottom:12px;">Generated Date: ' + formattedDate + '</div>');
                        var $table = $body.find('table');
                        $table.addClass('table table-bordered table-striped').css('width', '100%');
                        $table.find('thead tr').prepend('<th>Sr No</th>');
                        $table.find('tbody tr').each(function (index) {
                            $(this).prepend('<td style="text-align:center;">' + (index + 1) + '</td>');});
                        $body.css('font-size', '12pt');
                     },
                    action: function (e, dt, button, config) {
                        var selected = dt.rows().nodes().to$().find('input.rowCheckbox:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(true); } catch (err) { }

                        try {
                            if (!$.fn.dataTable.ext.buttons.print._orig) {
                                $.fn.dataTable.ext.buttons.print._orig = $.fn.dataTable.ext.buttons.print.action || $.fn.dataTable.ext.buttons.print;
                            }
                            $.fn.dataTable.ext.buttons.print._orig.call(this, e, dt, button, config);
                        } catch (err) {
                            setTimeout(function () { try { btnApi.processing(false); } catch (e) { } }, 300);
                            throw err;
                        }

                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 2000);
                    }
                },
                // PDF
                {
                    extend: 'pdfHtml5',
                    text: '<i class="bi bi-file-earmark-pdf text-danger fs-5"></i>',
                    titleAttr: 'PDF',
                    title: 'Approved And Close Purchase Orders',
                    orientation: 'landscape',
                    pageSize: 'A4',
                    exportOptions: {
                        columns: [2, 3, 4, 5, 6, 7, 8],
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        },
                        format: {
                            body: function (data, rowIdx, colIdx, node) {
                                return stripHtml(data);
                            }
                        }
                    },
                    customize: function (doc) {
                        doc.pageSize = 'A4';
                        doc.pageOrientation = 'landscape';
                        doc.defaultStyle.fontSize = 9;
                        doc.styles.tableHeader.fontSize = 10;
                        doc.styles.tableHeader.fillColor = '#343a40';
                        doc.styles.tableHeader.color = 'white';
                        doc.styles.tableHeader.bold = true;
                        doc.styles.tableHeader.alignment = 'center';

                        // Insert generated date
                        doc.content.splice(1, 0, {
                            text: `Generated Date: ${moment().format("DD/MM/YYYY")}`,
                            alignment: 'center',
                            margin: [0, 0, 0, 12],
                            fontSize: 9,
                            italics: true
                        });

                        // Find table and add Sr No as first column
                        function findTableNodeIndex(doc) {
                            for (var i = 0; i < doc.content.length; i++) {
                                if (doc.content[i].table) return i;
                            }
                            return -1;
                        }
                        var tableNodeIndex = findTableNodeIndex(doc);
                        if (tableNodeIndex < 0) return;
                        var tableNode = doc.content[tableNodeIndex];
                        if (!tableNode || !tableNode.table || !tableNode.table.body) return;
                        tableNode.table.body[0].unshift({ text: 'Sr No', style: 'tableHeader' });
                        for (var r = 1, cnt = 1; r < tableNode.table.body.length; r++, cnt++) {
                            tableNode.table.body[r].unshift({ text: String(cnt), alignment: 'center' });
                        }

                        tableNode.table.widths = ['5%', '15%', '15%', '15%', '15%', '10%', '12%', '12%'];

                        tableNode.layout = {
                            hLineWidth: function () { return 0.5; },
                            vLineWidth: function () { return 0.5; },
                            hLineColor: function () { return '#aaa'; },
                            vLineColor: function () { return '#aaa'; },
                            paddingLeft: function () { return 4; },
                            paddingRight: function () { return 4; },
                            paddingTop: function () { return 3; },
                            paddingBottom: function () { return 3; }
                        };
                    },
                    action: function (e, dt, button, config) {
                        var selected = dt.rows().nodes().to$().find('input.rowCheckbox:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(true); } catch (err) { }
                        if (window.pdfMake && pdfMake.createPdf && !pdfMake._patchedForDT) {
                            (function () {
                                var origCreate = pdfMake.createPdf;
                                pdfMake.createPdf = function (docDefinition) {
                                    var pdfDoc = origCreate.call(pdfMake, docDefinition);
                                    var origDownload = pdfDoc.download;
                                    pdfDoc.download = function (filename, cb) {
                                        origDownload.call(pdfDoc, filename);
                                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 1000);
                                        if (typeof cb === 'function') cb();
                                    };
                                    return pdfDoc;
                                };
                                pdfMake._patchedForDT = true;
                            })();
                        }

                        // call original
                        if (!$.fn.dataTable.ext.buttons.pdfHtml5._orig) {
                            $.fn.dataTable.ext.buttons.pdfHtml5._orig = $.fn.dataTable.ext.buttons.pdfHtml5.action;
                        }
                        $.fn.dataTable.ext.buttons.pdfHtml5._orig.call(this, e, dt, button, config);

                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 2000);
                    }
                },
                //Excel
                    {
                        extend: 'excelHtml5',
                        text: '<i class="bi bi-file-earmark-excel-fill text-success fs-5"></i>',
                        titleAttr: 'Export Excel',
                        filename: `Purchase_Order_Report_${moment().format("YYYY-MM-DD_HH-mm-ss")}`,

                        exportOptions: {
                            columns: ':visible',
                            rows: function (idx, data, node) {
                                return $(node).find('input.rowCheckbox').prop('checked');
                            }
                        },

                        action: function (e, dt, button, config) {
                            const selectedRows = dt.rows().nodes().to$().find('input.rowCheckbox:checked');
                            const btnApi = dt.button(button);

                            if (selectedRows.length === 0) {
                                if (typeof showExportToast === 'function') showExportToast();
                                try { btnApi.processing(false); } catch (err) { }
                                return;
                            }

                            try { btnApi.processing(true); } catch (err) { }

                            const selectedData = [];
                            let srNo = 1;

                            selectedRows.each(function () {
                                const tr = $(this).closest('tr');
                                const rowData = dt.row(tr).data();
                                if (!rowData) return;

                                selectedData.push([
                                    srNo++,
                                    rowData.POCode || '',
                                    rowData.RQNO || '',
                                    rowData.VendorName || '',
                                    rowData.VendorCompanyName || '',
                                    rowData.ApprovedRejectedDate
                                        ? new Date(rowData.ApprovedRejectedDate).toLocaleDateString("en-GB")
                                        : '',
                                    rowData.TotalAmount || '',
                                    rowData.StatusName || ''
                                ]);
                            });
                            // Format date as DD/MM/YYYY
                            const today = new Date();
                            const formattedDate = String(today.getDate()).padStart(2, '0') + '/' +
                                String(today.getMonth() + 1).padStart(2, '0') + '/' +
                                today.getFullYear();

                            // Create temporary table / DataTable for Excel export
                            const tempDt = $('<table>').DataTable({
                                data: selectedData,
                                columns: [
                                    { title: 'Sr.No' },
                                    { title: 'PO Code' },
                                    { title: 'RQ Code' },
                                    { title: 'Vendor Name' },
                                    { title: 'Company Name' },
                                    { title: 'Approved Date' },
                                    { title: 'Total Amount' },
                                    { title: 'Status' }
                                ],
                                dom: 'Bfrtip',
                                buttons: [{
                                    extend: 'excelHtml5',
                                    title: null,
                                    filename: `Purchase_Order_Report_${moment().format("YYYY-MM-DD_HH-mm-ss")}`,
                                    customize: function (xlsx) {
                                        const sheet = xlsx.xl.worksheets['sheet1.xml'];
                                        const sheetData = $('sheetData', sheet);
                                        // 1️⃣ Shift existing rows down by 3
                                        $('row', sheetData).each(function () {
                                            const $row = $(this);
                                            const r = parseInt($row.attr('r'), 10);
                                            const newR = r + 3;
                                            $row.attr('r', newR);
                                            // Update each cell reference in this row
                                            $row.find('c').each(function () {
                                                const $c = $(this);
                                                const cellRef = $c.attr('r');
                                                if (!cellRef) return;
                                                const col = cellRef.replace(/\d+$/, '');
                                                const rowNum = parseInt(cellRef.match(/\d+$/)[0], 10);
                                                $c.attr('r', col + (rowNum + 3));
                                            });
                                        });
                                        // 2️⃣ Create centered title & date rows (with style index 51)
                                        const titleCell = `<row r="1"><c r="A1" t="inlineStr" s="51"><is><t>Purchase Order Report</t></is></c></row>`;
                                        const dateCell = `<row r="2"><c r="A2" t="inlineStr" s="51"><is><t>Generated Date: ${formattedDate}</t></is></c></row>`;
                                        const blankRow = `<row r="3"></row>`;
                                        // Add them at the top
                                        sheetData.prepend(blankRow);
                                        sheetData.prepend(dateCell);
                                        sheetData.prepend(titleCell);
                                        // 3️⃣ Merge A1:H1 and A2:H2 (center across columns)
                                        const mergeRef1 = 'A1:H1';
                                        const mergeRef2 = 'A2:H2';
                                        if ($('mergeCells', sheet).length === 0) {
                                            const mergeXml = `<mergeCells count="2"><mergeCell ref="${mergeRef1}"/><mergeCell ref="${mergeRef2}"/></mergeCells>`;
                                            $('sheetData', sheet).after(mergeXml);
                                        } else {
                                            $('mergeCells', sheet).append(`<mergeCell ref="${mergeRef1}"/>`);
                                            $('mergeCells', sheet).append(`<mergeCell ref="${mergeRef2}"/>`);
                                            const currentCount = parseInt($('mergeCells', sheet).attr('count') || '0', 10);
                                            $('mergeCells', sheet).attr('count', currentCount + 2);
                                        }
                                        // 4️⃣ Add centered style (s="51") if not defined already
                                        const styles = xlsx.xl['styles.xml'];
                                        const cellXfs = $('cellXfs', styles);
                                        if (cellXfs.find('xf[applyAlignment]').length === 0) {
                                            cellXfs.append(`<xf xfId="0" applyAlignment="1"><alignment horizontal="center" vertical="center"/></xf>`);
                                            const count = parseInt(cellXfs.attr('count'), 10) || 0;
                                            cellXfs.attr('count', count + 1);
                                        }
                                        // 5️⃣ Optional: widen columns
                                        if ($('cols', sheet).length === 0) {
                                            let colsXml = '<cols>';
                                            for (let i = 1; i <= 8; i++) {
                                                colsXml += `<col min="${i}" max="${i}" width="20" customWidth="1"/>`;
                                            }
                                            colsXml += '</cols>';
                                            $('sheetPr', sheet).after(colsXml);
                                        }
                                    }
                                }],
                                destroy: true,
                                paging: false,
                                searching: false,
                                info: false
                            });
                            // Trigger excel export
                            tempDt.button('.buttons-excel').trigger();
                            setTimeout(() => { try { btnApi.processing(false); } catch (err) { } }, 800);
                        }
                    },
                //CSV
                    {
                        extend: 'csvHtml5',
                        text: '<i class="bi bi-filetype-csv text-success fs-5"></i>',
                        title: '',
                        exportOptions: {
                            rows: function (idx, data, node) {
                                return $(node).find('input.rowCheckbox').prop('checked');
                            },
                            columns: [1, 2, 3, 4, 5, 6, 7, 8],
                            modifier: { search: 'applied', order: 'applied' },
                            format: {
                                body: (function () {
                                    let srCounter = 1;
                                    return function (data, rowIdx, colIdx, node) {
                                        if (colIdx === 1) return srCounter++;
                                        return $('<div>').html(data).text().trim() || '';
                                    };
                                })()
                            }
                        },
                        action: function (e, dt, button, config) {
                            const $rows = dt.rows().nodes().to$();
                            const selected = $rows.find('input.rowCheckbox:checked').length;
                            const btnApi = dt.button(button);

                            if (selected === 0) {
                                toastr.warning("Please select at least one row before exporting!");
                                try { btnApi.processing(false); } catch (err) { }
                                return;
                            }
                            try { btnApi.processing(true); } catch (err) { }

                            if (!$.fn.dataTable.ext.buttons.csvHtml5._orig) {
                                $.fn.dataTable.ext.buttons.csvHtml5._orig = $.fn.dataTable.ext.buttons.csvHtml5.action;
                            }
                            const self = this;
                            const modifiedAction = function (e, dt, button, config) {
                                const originalDownload = $.fn.DataTable.fileSave;
                                $.fn.DataTable.fileSave = function (content, fileName, options) {
                                    const result = originalDownload.call(this, content, fileName, options);
                                    setTimeout(() => {
                                        try {
                                            btnApi.processing(false);
                                        } catch (err) {
                                            console.log('Spinner stopped');
                                        }
                                    }, 500);

                                    return result;
                                };

                                try {
                                    $.fn.dataTable.ext.buttons.csvHtml5._orig.call(self, e, dt, button, config);
                                } catch (error) {
                                    setTimeout(() => {
                                        try {
                                            btnApi.processing(false);
                                        } catch (err) { }
                                    }, 500);
                                    throw error;
                                } finally {
                                    setTimeout(() => {
                                        $.fn.DataTable.fileSave = originalDownload;
                                    }, 1000);
                                }
                            };
                            modifiedAction.call(this, e, dt, button, config);
                        }
                    }
            ]
            });
            // Select All
            $(document).on("change", "#selectAll", function () {
                $(".rowCheckbox").prop("checked", this.checked);
            });

            $(document).on("change", ".rowCheckbox", function () {
                $("#selectAll").prop("checked", $(".rowCheckbox:checked").length === $(".rowCheckbox").length);
            });

        } catch (err) {
            console.error("initPOTablePSM error:", err);
            throw err; // rethrow so you still see the stack if desired
        }
    }

    // ------------------- CHILD DATATABLE -------------------
    function loadPOItems(poCode) {
        if (poItemsTablePSM) { poItemsTablePSM.destroy(); $("#poItemsTablePSM tbody").empty(); }

        poItemsTablePSM = $("#poItemsTablePSM").DataTable({
            dom: '<"d-flex justify-content-between align-items-center mb-2"Bf>rt<"d-flex justify-content-between align-items-center"i p>',
            responsive: true, processing: true,
            ajax: {
                url: '@Url.Action("ApprovedPOItemsPSM", "GRN")',
                type: 'GET', data: { poCode: poCode }, dataSrc: "data"
            },
            columns: [
                { data: null, render: function () { return '<input type="checkbox" class="rowCheckbox1"/>'; } },
                { data: null, render: function (d, t, r, meta) { return meta.row + 1; } },
                { data: 'ItemName', className: 'text-center' },
                { data: "CostPerUnit", className: 'text-center', render: function (d) { return d ? `<i class="bi bi-currency-rupee"></i> ${parseFloat(d).toLocaleString("en-IN", { minimumFractionDigits: 2 })}` : "-"; } },
                { data: 'UnitQuantity', className: 'text-center', render: $.fn.dataTable.render.number(',', '.', 2) },
                { data: 'Discount', className: 'text-center' },
                { data: 'TaxRate', className: 'text-center' },
                { data: 'IsQuality', className: 'text-center', render: function (d) { return d === 'Yes' ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-danger">No</span>'; } },
                { data: 'FinalAmount', className: 'text-center', render: function (d) { return d ? `<i class="bi bi-currency-rupee"></i> ${parseFloat(d).toLocaleString("en-IN", { minimumFractionDigits: 2 })}` : "-"; } }
            ],
            ordering: false,
            buttons: [
                // Print
                {
                    extend: 'print',
                    text: '<i class="bi bi-printer-fill text-dark fs-5"></i>',
                    titleAttr: 'Print',
                    title: 'Total PO Items',
                    exportOptions: {
                        columns: [2, 3, 4, 5, 6, 7, 8],
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox1').prop('checked');
                        }
                    },
                    customize: function (win) {
                        var $body = $(win.document.body);
                        // Add styling
                        $body.append(`<style>thead th {
                        background-color: black !important;
                        color: white !important;
                        text-align: center !important;
                        -webkit-print-color-adjust: exact !important;
                         print-color-adjust: exact !important;
                         }
                         table { border-collapse: collapse !important; width: 100% !important; }
                         td, th { border: 1px solid #000 !important; padding: 6px !important; }
                         </style>`);
                        $body.find('h1').css('text-align', 'center');
                        var today = new Date();
                        var formattedDate = String(today.getDate()).padStart(2, '0') + '/' +
                            String(today.getMonth() + 1).padStart(2, '0') + '/' +
                            today.getFullYear();
                        $body.find('h1').after('<div style="text-align:center;font-style:italic;font-size:10pt;margin-bottom:12px;">Generated Date: ' + formattedDate + '</div>');
                        var $table = $body.find('table');
                        $table.addClass('table table-bordered table-striped').css('width', '100%');
                        $table.find('thead tr').prepend('<th>Sr No</th>');
                        $table.find('tbody tr').each(function (index) {
                            $(this).prepend('<td style="text-align:center;">' + (index + 1) + '</td>');
                        });
                        $body.css('font-size', '12pt');
                    },
                    action: function (e, dt, button, config) {
                        var selected = dt.rows().nodes().to$().find('input.rowCheckbox1:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(true); } catch (err) { }

                        try {
                            if (!$.fn.dataTable.ext.buttons.print._orig) {
                                $.fn.dataTable.ext.buttons.print._orig = $.fn.dataTable.ext.buttons.print.action || $.fn.dataTable.ext.buttons.print;
                            }
                            $.fn.dataTable.ext.buttons.print._orig.call(this, e, dt, button, config);
                        } catch (err) {
                            setTimeout(function () { try { btnApi.processing(false); } catch (e) { } }, 300);
                            throw err;
                        }

                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 2000);
                    }
                },
                // PDF
                {
                    extend: 'pdfHtml5',
                    text: '<i class="bi bi-file-earmark-pdf text-danger fs-5"></i>',
                    titleAttr: 'PDF',
                    title: 'Approved And Close Purchase Order Items',
                    orientation: 'landscape',
                    pageSize: 'A4',
                    exportOptions: {
                        columns: [2, 3, 4, 5, 6, 7, 8],
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox1').prop('checked');
                        },
                        format: {
                            body: function (data, rowIdx, colIdx, node) {
                                return stripHtml(data);
                            }
                        }
                    },
                    customize: function (doc) {
                        doc.pageSize = 'A4';
                        doc.pageOrientation = 'landscape';
                        doc.defaultStyle.fontSize = 9;
                        doc.styles.tableHeader.fontSize = 10;
                        doc.styles.tableHeader.fillColor = '#343a40';
                        doc.styles.tableHeader.color = 'white';
                        doc.styles.tableHeader.bold = true;
                        doc.styles.tableHeader.alignment = 'center';

                        // Insert generated date
                        doc.content.splice(1, 0, {
                            text: `Generated Date: ${moment().format("DD/MM/YYYY")}`,
                            alignment: 'center',
                            margin: [0, 0, 0, 12],
                            fontSize: 9,
                            italics: true
                        });

                        // Find table and add Sr No as first column
                        function findTableNodeIndex(doc) {
                            for (var i = 0; i < doc.content.length; i++) {
                                if (doc.content[i].table) return i;
                            }
                            return -1;
                        }
                        var tableNodeIndex = findTableNodeIndex(doc);
                        if (tableNodeIndex < 0) return;
                        var tableNode = doc.content[tableNodeIndex];
                        if (!tableNode || !tableNode.table || !tableNode.table.body) return;
                        tableNode.table.body[0].unshift({ text: 'Sr No', style: 'tableHeader' });
                        for (var r = 1, cnt = 1; r < tableNode.table.body.length; r++, cnt++) {
                            tableNode.table.body[r].unshift({ text: String(cnt), alignment: 'center' });
                        }

                        tableNode.table.widths = ['5%', '15%', '15%', '15%', '15%', '10%', '12%', '12%'];

                        tableNode.layout = {
                            hLineWidth: function () { return 0.5; },
                            vLineWidth: function () { return 0.5; },
                            hLineColor: function () { return '#aaa'; },
                            vLineColor: function () { return '#aaa'; },
                            paddingLeft: function () { return 4; },
                            paddingRight: function () { return 4; },
                            paddingTop: function () { return 3; },
                            paddingBottom: function () { return 3; }
                        };
                    },
                    action: function (e, dt, button, config) {
                        var selected = dt.rows().nodes().to$().find('input.rowCheckbox1:checked').length;
                        var btnApi = dt.button(button);

                        if (selected === 0) {
                            showExportToast();
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }

                        try { btnApi.processing(true); } catch (err) { }
                        if (window.pdfMake && pdfMake.createPdf && !pdfMake._patchedForDT) {
                            (function () {
                                var origCreate = pdfMake.createPdf;
                                pdfMake.createPdf = function (docDefinition) {
                                    var pdfDoc = origCreate.call(pdfMake, docDefinition);
                                    var origDownload = pdfDoc.download;
                                    pdfDoc.download = function (filename, cb) {
                                        origDownload.call(pdfDoc, filename);
                                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 1000);
                                        if (typeof cb === 'function') cb();
                                    };
                                    return pdfDoc;
                                };
                                pdfMake._patchedForDT = true;
                            })();
                        }

                        // call original
                        if (!$.fn.dataTable.ext.buttons.pdfHtml5._orig) {
                            $.fn.dataTable.ext.buttons.pdfHtml5._orig = $.fn.dataTable.ext.buttons.pdfHtml5.action;
                        }
                        $.fn.dataTable.ext.buttons.pdfHtml5._orig.call(this, e, dt, button, config);

                        setTimeout(function () { try { btnApi.processing(false); } catch (err) { } }, 2000);
                    }
                },
                //Excel
                {
                    extend: 'excelHtml5',
                    text: '<i class="bi bi-file-earmark-excel-fill text-success fs-5"></i>',
                    titleAttr: 'Export Excel',
                    filename: `Total_Item_List_${moment().format("YYYY-MM-DD_HH-mm-ss")}`,

                    exportOptions: {
                        columns: ':visible'
                    },
                    action: function (e, dt, button, config) {
                        const selectedRows = dt.rows().nodes().to$().find('input.rowCheckbox1:checked');
                        const btnApi = dt.button(button);

                        if (selectedRows.length === 0) {
                            toastr.warning("Please select at least one row before exporting!");
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }
                        try { btnApi.processing(true); } catch (err) { }

                        const selectedData = [];
                        let srNo = 1;

                        selectedRows.each(function () {
                            const tr = $(this).closest('tr');
                            const rowData = dt.row(tr).data();
                            if (!rowData) return;

                            selectedData.push([
                                srNo++,
                                rowData.ItemName || '',
                                rowData.CostPerUnit ? parseFloat(rowData.CostPerUnit).toLocaleString("en-IN", { minimumFractionDigits: 2 }) : '',
                                rowData.UnitQuantity || '',
                                rowData.Discount || '',
                                rowData.TaxRate || '',
                                rowData.IsQuality || '',
                                rowData.FinalAmount ? parseFloat(rowData.FinalAmount).toLocaleString("en-IN", { minimumFractionDigits: 2 }) : ''
                            ]);
                        });
                        const today = new Date();
                        const formattedDate = String(today.getDate()).padStart(2, '0') + '/' +
                            String(today.getMonth() + 1).padStart(2, '0') + '/' +
                            today.getFullYear();
                        const tempDt = $('<table>').DataTable({
                            data: selectedData,
                            columns: [
                                { title: 'Sr.No' },
                                { title: 'Item Name' },
                                { title: 'Cost/Unit' },
                                { title: 'Quantity' },
                                { title: 'Discount' },
                                { title: 'Tax Rate' },
                                { title: 'Is Quality' },
                                { title: 'Final Amount' }
                            ],
                            dom: 'Bfrtip',
                            buttons: [{
                                extend: 'excelHtml5',
                                title: null,
                                filename: `Total_Item_List_${moment().format("YYYY-MM-DD_HH-mm-ss")}`,
                                customize: function (xlsx) {
                                    const sheet = xlsx.xl.worksheets['sheet1.xml'];
                                    const sheetData = $('sheetData', sheet);
                                    $('row', sheetData).each(function () {
                                        const $row = $(this);
                                        const r = parseInt($row.attr('r'), 10);
                                        const newR = r + 3;
                                        $row.attr('r', newR);
                                        $row.find('c').each(function () {
                                            const $c = $(this);
                                            const cellRef = $c.attr('r');
                                            if (!cellRef) return;
                                            const col = cellRef.replace(/\d+$/, '');
                                            const rowNum = parseInt(cellRef.match(/\d+$/)[0], 10);
                                            $c.attr('r', col + (rowNum + 3));
                                        });
                                    });
                                    const blankRow = `<row r="3"></row>`;
                                    sheetData.prepend(blankRow);
                                    const mergeRef1 = 'A1:H1';
                                    const mergeRef2 = 'A2:H2';
                                    if ($('mergeCells', sheet).length === 0) {
                                        const mergeXml = `<mergeCells count="2"><mergeCell ref="${mergeRef1}"/><mergeCell ref="${mergeRef2}"/></mergeCells>`;
                                        $('sheetData', sheet).after(mergeXml);
                                    } else {
                                        $('mergeCells', sheet).append(`<mergeCell ref="${mergeRef1}"/>`);
                                        $('mergeCells', sheet).append(`<mergeCell ref="${mergeRef2}"/>`);
                                        const currentCount = parseInt($('mergeCells', sheet).attr('count') || '0', 10);
                                        $('mergeCells', sheet).attr('count', currentCount + 2);
                                    }
                                    const styles = xlsx.xl['styles.xml'];
                                    const fonts = $('fonts', styles);
                                    const cellXfs = $('cellXfs', styles);
                                    if (fonts.length === 0) {
                                        $('styleSheet', styles).append('<fonts count="0"></fonts>');
                                    }
                                    if (cellXfs.length === 0) {
                                        $('styleSheet', styles).append('<cellXfs count="0"></cellXfs>');
                                    }
                                    const fontsRef = $('fonts', styles);
                                    const cellXfsRef = $('cellXfs', styles);
                                    const fontsCount = parseInt(fontsRef.attr('count') || '0', 10);
                                    fontsRef.append(`<font><b/><sz val="14"/><name val="Calibri"/></font>`);
                                    fontsRef.attr('count', fontsCount + 1);
                                    const newFontId = fontsCount;
                                    const cellXfsCount = parseInt(cellXfsRef.attr('count') || '0', 10);
                                    cellXfsRef.append(`<xf xfId="0" applyAlignment="1" applyFont="1"><alignment horizontal="center" vertical="center"/><fontId val="${newFontId}"/></xf>`);
                                    cellXfsRef.append(`<xf xfId="0" applyAlignment="1"><alignment horizontal="center" vertical="center"/></xf>`);
                                    cellXfsRef.attr('count', cellXfsCount + 2);
                                    const titleStyleIndex = cellXfsCount;   
                                    const dateStyleIndex = cellXfsCount + 1;
                                    const titleCell = `<row r="1"><c r="A1" t="inlineStr" s="${titleStyleIndex}"><is><t>Total PO Items</t></is></c></row>`;
                                    const dateCell = `<row r="2"><c r="A2" t="inlineStr" s="${dateStyleIndex}"><is><t>Generated Date: ${formattedDate}</t></is></c></row>`;
                                    sheetData.prepend(dateCell);
                                    sheetData.prepend(titleCell);
                                    if ($('cols', sheet).length === 0) {
                                        let colsXml = '<cols>';
                                        for (let i = 1; i <= 8; i++) {
                                            colsXml += `<col min="${i}" max="${i}" width="20" customWidth="1"/>`;
                                        }
                                        colsXml += '</cols>';
                                        if ($('sheetPr', sheet).length) {
                                            $('sheetPr', sheet).after(colsXml);
                                        } else {
                                            $(sheetData).before(colsXml);
                                        }
                                    }
                                }
                            }],
                            destroy: true,
                            paging: false,
                            searching: false,
                            info: false
                        });
                        tempDt.button('.buttons-excel').trigger();
                        setTimeout(() => { try { btnApi.processing(false); } catch (err) { } }, 800);
                    }
                },
                //CSV
                {
                    extend: 'csvHtml5',
                    text: '<i class="bi bi-filetype-csv text-success fs-5"></i>',
                    title: '',
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox1').prop('checked');
                        },
                        columns: [1, 2, 3, 4, 5, 6, 7, 8],
                        modifier: { search: 'applied', order: 'applied' },
                        format: {
                            body: (function () {
                                let srCounter = 1;
                                return function (data, rowIdx, colIdx, node) {
                                    if (colIdx === 1) return srCounter++;
                                    return $('<div>').html(data).text().trim() || '';
                                };
                            })()
                        }
                    },
                    action: function (e, dt, button, config) {
                        const $rows = dt.rows().nodes().to$();
                        const selected = $rows.find('input.rowCheckbox1:checked').length;
                        const btnApi = dt.button(button);

                        if (selected === 0) {
                            toastr.warning("Please select at least one row before exporting!");
                            try { btnApi.processing(false); } catch (err) { }
                            return;
                        }
                        try { btnApi.processing(true); } catch (err) { }

                        if (!$.fn.dataTable.ext.buttons.csvHtml5._orig) {
                            $.fn.dataTable.ext.buttons.csvHtml5._orig = $.fn.dataTable.ext.buttons.csvHtml5.action;
                        }
                        const self = this;
                        const modifiedAction = function (e, dt, button, config) {
                            const originalDownload = $.fn.DataTable.fileSave;
                            $.fn.DataTable.fileSave = function (content, fileName, options) {
                                const result = originalDownload.call(this, content, fileName, options);
                                setTimeout(() => {
                                    try {
                                        btnApi.processing(false);
                                    } catch (err) {
                                        console.log('Spinner stopped');
                                    }
                                }, 500);

                                return result;
                            };

                            try {
                                $.fn.dataTable.ext.buttons.csvHtml5._orig.call(self, e, dt, button, config);
                            } catch (error) {
                                setTimeout(() => {
                                    try {
                                        btnApi.processing(false);
                                    } catch (err) { }
                                }, 500);
                                throw error;
                            } finally {
                                setTimeout(() => {
                                    $.fn.DataTable.fileSave = originalDownload;
                                }, 1000);
                            }
                        };
                        modifiedAction.call(this, e, dt, button, config);
                    }
                }
            ],
        });

        // child select all
        $(document).off('change', '#selectAllChild').on('change', '#selectAllChild', function () {
            $('#poItemsTablePSM tbody input.rowCheckbox1').prop('checked', $(this).is(':checked'));
        });
    }

    // ------------------- VIEW MODAL -------------------
    $(document).off('click', '.btnViewPO').on('click', '.btnViewPO', function () {
        var poCode = $(this).data('pocode');
        if (!poCode) return;
        $('#poItemsModal').modal('show');
        loadPOItems(poCode);
    });

    // ------------------- DONUT CHART -------------------
    function loadPOChartPSM(fromDate, toDate) {
        $.getJSON('@Url.Action("ApprovedPOChartPSM", "GRN")', { startDate: fromDate || "", endDate: toDate || "" }, function (res) {
            var totalCount = res?.data?.reduce(function (s, r) { return s + (r.Count || 0); }, 0) || 0;
            $("#poTotalCountPSM").text(totalCount);
            Highcharts.chart('poDonutChartPSM', {
                chart: { type: 'pie', height: 400 },
                title: { text: totalCount ? '' : 'No Data Available' },
                subtitle: totalCount ? { text: 'Total POs: <b>' + totalCount + '</b>', align: 'left', floating: true, style: { fontSize: '14px', fontWeight: 'bold', color: '#28a745' } } : null,
                plotOptions: {
                    pie: {
                        innerSize: '60%',
                        dataLabels: { enabled: true, format: '{point.name}: {point.y}' },
                        point: {
                            events: {
                                click: function () {
                                    if (poTablePSM) {
                                        poTablePSM.column(4).search(this.name).draw();
                                    }
                                }
                            }
                        }
                    }
                },
                series: [{ name: 'Approved POs', colorByPoint: true, data: (res?.data || []).map(function (r) { return { name: r.VendorName, y: r.Count }; }) }],
                credits: { enabled: false }
            });
        });
    }
</script>
